# Running Stroom v7 in an IDE

We tend to use IntelliJ as our Java IDE of choice. This is a guide for running Stroom in IntelliJ for the purposes of developing/debugging Stroom.

## Prerequisites

In order to build/run/debug Stroom you will need the following:

 * OpenJDK 15
 * Git
 * Gradle
 * IntelliJ
 * Docker CE
 * Docker Compose

These instructions assume that all services will either run in the IDE or in Docker containers.

## Stroom git repositories

To develop stroom you will need to clone/fork multiple git repositories.
To quickly clone all of the Stroom repositories you can use the helper script described in [stroom-resource (external link)](https://github.com/gchq/stroom-resources/blob/master/README.md).

## Database setup

Stroom requires a MySQL database to run. You can either point Stroom at a MySQL server or preferably at a MySQL Docker container.

### MySQL in a Docker container

See the section below on `stroom-resources`.

### Host based MySQL server

With an instance of MySQL server 8.0 running on your local machine do the following to create the _stroom_ database:

```bash
# log into your MySQL server using your root credentials
mysql --user=root --password=myrootpassword
```

Then run the following commands in the MySQL shell:

```sql
drop database stroom;
create database stroom;
grant all privileges on stroom.* to stroomuser@localhost identified by 'stroompassword1';
quit;
```

## Local configuration file

When running stroom in an IDE it is advisable to have a local configuration file to allow you to change settings locally without affecting the repository. The local configuration file is expected to live at `~/.stroom/stroom.conf`. To create a default version of this file run the script `stroom.conf.sh` from within the root of the stroom git repository.

Add any properties from stroom.properties that you want different values for, e.g.

## stroom-resources

As a minimum to develop stroom you will need clones of the `stroom` and `stroom-resources` git repositories. `stroom-resources` provides the docker-compose configuration for running the many docker containers needed.

Having cloned `stroom-resources` navigate to the directory `stroom-resources/bin` and run the script

``` bash
./bounceIt.sh
```

On first run this will create a default version of the git-ignored file `stroom-resources/bin/local.env` which is intended for use by developers to configure the docker stacks to run.

This file is used to set a number of environment variables that docker compose will use to configure the various containers. The key environment variable in there is `SERVICE_LIST`. This is a space delimited list of the services for docker-compose to run. The services are all defined in `stroom-resources/bin/compose/everything.yml` and its dependencies. By default `SERVICE_LIST` runs a core stroom stack entirely in docker. 

To run stroom in an IDE `stroom` needs to be removed from `SERVICE_LIST`, i.e. by commenting out the line `SERVICE_LIST="${SERVICE_LIST} stroom"` in `local.env`. Having done this run stroom's core dependencies as follows:

``` bash
./bounceIt.sh
```

## Sample Data

Some of the tests are dependent on some sample data and content being present in the database.  This sample data/content can also be useful for manually testing the application in development. The sample data/content is generated by a class called _SetupSampleData.java_. This class assumes that the database being used for Stroom is completely empty.

First you need to create a run configuration for _SetupSampleData.java_

1. Click _Run_ -> _Edit Configurations..._
1. Click the green _+_ icon to add a new configuration
1. Select _Application_ as the configuration type
1. In the _Main Class_ field enter _SetupSampleData_
1. In the _Use classpath of module_ field select _stroom-integrationtest_
1. If you have set the _STROOM_TMP_ environment variable in your _.bashrc_ / _.zshrc_ then ignore this step.  In the _Environment variables_ field click the _..._ icon and add _STROOM_TMP_ = _~/tmp/stroom/_ (or whatever directory you choose)
1. Click the _OK_ button

Now run _SetupSampleData_ 

1. Click _Run_ -> _Run..._
1. Select _SetupSampleData_

You should now have a database populated with tables and data, providing you with some predefined feeds, data, translations, pipelines, dashboards, etc.

## Running Stroom from the IDE

The user interface for Stroom is built using GWT (see [GWT Project](http://www.gwtproject.org/) for more information or GWT specific documentation). As a result Stroom needs to be started up with GWT _Dev Mode_. _Dev Mode_ handles the compilation of the Java user interface source into JavaScript and the source map that links client JavaScript back to Java source for client side debugging.

The following steps for running and debugging Stroom in IDEA assume you have a MySQL database running on `localhost`, with a database `stroom` and user `stroomuser` already created.

### 1. Ensure environment variable `JAVA_HOME` is set and points to a valid JDK 15 directory

```
export JAVA_HOME=~/.jdks/openjdk-15.0.2
```

### 2. Build `stroom-app`

NOTE: During development, it is helpful to skip running unit and integration tests, to speed up the build process:
```
./gradlew clean build -x test
```

### 3. Start a single Stroom node

1. Select the IDEA run configuration named `Stroom GWT SuperDevMode`
1. Click `Debug`. Stroom will start, with log output displayed in the `Run` pane at the bottom of the window.

Watch the log output. Once you see a log INFO message containing the text "Started", you will be able to launch the app in a browser from: https://localhost.

You will see the Stroom blue background, with a username/password prompt. Enter the following default credentials:

* **Username**: admin
* **Password**: admin

You can now interact with Stroom and set breakpoints in Java code. Note that setting breakpoints in GWT code does not
have any effect, as these components are compiled to static JavaScript.

> **NOTE:** Stroom has been written with Google's Chrome browser in mind so has only been tested on Chrome. Behaviour in other browsers may vary. We would like to improve cross-browser support so please let us know about any browser incompatibilities that you find.

## Right click behaviour
Stroom overrides the default right click behaviour in the browser with its own context menu. For UI development it is often required to have access to the browser's context menu for example to inspect elements. To enable the browser's context menu you need to uncomment the following property:

```properties 
stroom.ui.oncontextmenu=
```
