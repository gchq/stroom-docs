<!doctype html>
<html itemscope itemtype="http://schema.org/WebPage" lang="en" class="no-js">
  <head>
    
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="generator" content="Hugo 0.95.0" />
<link rel="canonical" type="text/html" href="../../../../docs/install-guide/upgrades/">
<meta name="robots" content="noindex, nofollow">


<link rel="shortcut icon" href="../../../../favicons/favicon.ico" >
<link rel="apple-touch-icon" href="../../../../favicons/apple-touch-icon-180x180.png" sizes="180x180">
<link rel="icon" type="image/png" href="../../../../favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="../../../../favicons/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="../../../../favicons/android-36x36.png" sizes="36x36">
<link rel="icon" type="image/png" href="../../../../favicons/android-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="../../../../favicons/android-72x72.png" sizes="72x72">
<link rel="icon" type="image/png" href="../../../../favicons/android-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="../../../../favicons/android-144x144.png" sizes="144x144">
<link rel="icon" type="image/png" href="../../../../favicons/android-192x192.png" sizes="192x192">

<title>Upgrades | Stroom</title>
<meta name="description" content="">
<meta property="og:title" content="Upgrades" />
<meta property="og:description" content="Stroom documentation, release notes, news and open source community information" />
<meta property="og:type" content="website" />
<meta property="og:url" content="/docs/install-guide/upgrades/" /><meta property="og:site_name" content="Stroom" />

<meta itemprop="name" content="Upgrades">
<meta itemprop="description" content="Stroom documentation, release notes, news and open source community information"><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Upgrades"/>
<meta name="twitter:description" content="Stroom documentation, release notes, news and open source community information"/>




<link rel="preload" href="../../../../scss/main.min.af042051ae61e3c5eb9d695632db6eafe8b9296cf718159b1de23d2546b9e528.css" as="style">
<link href="../../../../scss/main.min.af042051ae61e3c5eb9d695632db6eafe8b9296cf718159b1de23d2546b9e528.css" rel="stylesheet" integrity="">


<script src='../../../../js/jquery-3.6.0.min.js'></script>


<script src='../../../../js/lunr.min.js'></script>
  
<link rel="stylesheet" href="../../../../css/prism.css"/>

<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-00000000-0', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

  </head>
  <body class="td-section">
    <header>
      <nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar">
  <a class="navbar-brand" href="../../../../"><span class="navbar-brand__logo navbar-logo"><svg xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:cc="http://creativecommons.org/ns#" xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#" xmlns:svg="http://www.w3.org/2000/svg" xmlns="http://www.w3.org/2000/svg" xmlns:sodipodi="http://sodipodi.sourceforge.net/DTD/sodipodi-0.dtd" xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape" width="110.61089" height="30.000004" viewBox="0 0 88.488641 23.999957" id="svg2" inkscape:version="0.91 r13725" sodipodi:docname="logo.svg"><defs id="defs20"/><sodipodi:namedview pagecolor="#989898" bordercolor="#666666" borderopacity="1" objecttolerance="10" gridtolerance="10" guidetolerance="10" inkscape:pageopacity="0" inkscape:pageshadow="2" inkscape:window-width="1920" inkscape:window-height="1137" id="namedview18" showgrid="false" fit-margin-top="0" fit-margin-left="0" fit-margin-right="0" fit-margin-bottom="0" inkscape:zoom="5.5951814" inkscape:cx="55.451414" inkscape:cy="16.275348" inkscape:window-x="0" inkscape:window-y="0" inkscape:window-maximized="1" inkscape:current-layer="svg2"/><g id="g4150" style="opacity:.97000002" transform="matrix(0.03883584,0,0,0.03883584,0,-3.1155874e-4)"><path id="path6" d="M121.99991 205.98497C54.999958 205.98497.0 259.98493.0 327.98487c0 66.99994 54.999958 121.99989 121.99991 121.99989h167.99987c24.99998.0 44.99996 20.99998 44.99996 44.99996.0 24.99998-19.99998 44.99996-44.99996 44.99996H109.20929C65.984126 553.87219 27.100843 581.57313.01093599 617.98462H289.99978c66.99994.0 121.99991-54.99996 121.99991-122.9999.0-66.99994-54.99997-121.99989-121.99991-121.99989H121.99991c-24.999984.0-44.999969-19.99999-44.999969-44.99996.0-24.99998 19.999985-44.99996 44.999969-44.99996h228.79045c26.9905-35.88325 65.47093-63.18547 108.21554-76.99994H121.99991z" style="fill:#fff" inkscape:connector-curvature="0"/><path id="path8" d="M601.44485-.00077860649C572.6583 8.3697982 546.49491 22.822962 524.44491 41.902305V205.78969l.002.19528h-.002c-65.11 48e-5-123.03145 30.0199-160.74675 76.99994h160.74675v334.99971h76.99994V282.98491h144.85298c27.16134-36.05885 65.96411-63.39275 109.02184-76.99994H601.44485v-205.98574860649z" style="fill:#fff" inkscape:connector-curvature="0"/><path id="path10" d="m919.42586 205.98497c-113.99519.0-205.99537 92.00648-206.00296 205.99982-15e-5 68.67178.0 137.32749.0 205.99983h77.99994c-.012-68.6493.0176-137.46869.0-205.99983.0846-70.92785 57.05747-128.99988 128.00462-128.99988 5.28623.0 10.49823.32864 15.62183.95311 18.2219-24.51229 41.78461-45.0838 68.42501-60.15146-25.65065-11.43799-54.08662-17.80159-84.04684-17.80159z" style="fill:#fff" inkscape:connector-curvature="0"/><path id="path12" d="m1109.4153 205.98457c-113.99994.0-205.99983 91.99993-205.99983 205.99984.0 112.9999 91.99989 205.9998 205.99983 205.9998 114 0 205.9999-92.9999 205.9999-205.9998.0-113.99991-91.9999-205.99984-205.9999-205.99984zm0 333.99974c-70.9999.0-128.99994-56.99996-128.99994-127.9999.0-70.99995 58.00004-128.9999 128.99994-128.9999 71 0 128.9999 57.99995 128.9999 128.9999.0 70.99994-57.9999 127.9999-128.9999 127.9999z" style="fill:#fff" inkscape:connector-curvature="0"/><path id="path14" d="m1444.4737 205.98457c-113.9999.0-205.9998 91.99993-205.9998 205.99984.0 112.9999 91.9999 205.9998 205.9998 205.9998s205.9999-92.9999 205.9999-205.9998c0-113.99991-92-205.99984-205.9999-205.99984zm0 333.99974c-70.9999.0-128.9999-56.99996-128.9999-127.9999.0-70.99995 58-128.9999 128.9999-128.9999 71 0 128.9999 57.99995 128.9999 128.9999.0 70.99994-57.9999 127.9999-128.9999 127.9999z" style="fill:#fff" inkscape:connector-curvature="0"/><path id="path16" d="m1738.5308 379.98447c0-53 43-97 95.9999-97 53 0 97 44 97 97v237.9997h76.9999v-237.9997c0-53 43-97 96.9999-97 53 0 95.9999 44 95.9999 97v237.9997h77v-237.9997c0-96-77-173.9999-172.9999-173.9999-54.9999.0-103.9999 24.99998-135.9999 64.99995-31.9999-39.99997-79.9999-64.99995-134.9999-64.99995-95.9999.0-173.9998 77.9999-173.9998 173.9999v237.9997h77.9999z" style="fill:#fff" inkscape:connector-curvature="0"/></g></svg></span><span class="navbar-brand__name">Stroom</span></a>
  <div class="td-navbar-nav-scroll ml-md-auto" id="main_navbar">
    <ul class="navbar-nav mt-2 mt-lg-0">
      <li class="nav-item mr-4 mb-2 mb-lg-0">
        <a class="nav-link" href="../../../../about/about/"><span>About</span></a>
      </li>
      <li class="nav-item mr-4 mb-2 mb-lg-0">
        <a class="nav-link active" href="../../../../docs/"><span class="active">Documentation</span></a>
      </li>
      <li class="nav-item mr-4 mb-2 mb-lg-0">
        <a class="nav-link" href="../../../../news/"><span>News / Releases</span></a>
      </li>
      <li class="nav-item mr-4 mb-2 mb-lg-0">
        <a class="nav-link" href="../../../../community/"><span>Community</span></a>
      </li>
      <li class="nav-item dropdown mr-4 d-none d-lg-block">
        <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
	Stroom Version (7.1)
</a>
<div class="dropdown-menu" aria-labelledby="navbarDropdownMenuLink">
	
	
	
	<a class="dropdown-item" href="../../../../">7.1 (Latest)</a>
	
	<a class="dropdown-item" href="../../../../7.0">7.0</a>
	
	<a class="dropdown-item" href="../../../../legacy">Legacy</a>
	
</div>
</li>
      </ul>
  </div>
  <div class="navbar-nav d-none d-lg-block">
    <div class="td-search td-search--offline">
  <div class="td-search__icon"></div>
  <input
    type="search"
    class="td-search__input form-control"
    placeholder="Search this site…"
    aria-label="Search this site…"
    autocomplete="off"
    
    data-offline-search-index-json-src="../../../../offline-search-index.cabcff3ebe6c5fb6bb6342cae6dc5d96.json"
    data-offline-search-base-href="../../../../"
    data-offline-search-max-results="50"
  >
</div>

  </div>
</nav>
    </header>
    <div class="container-fluid td-outer">
      <div class="td-main">
        <div class="row flex-xl-nowrap">
          <main class="col-12 col-md-9 col-xl-8 pl-md-5" role="main">
            




<div class="td-content">
<div class="pageinfo pageinfo-primary d-print-none">
<p>
This is the multi-page printable view of this section.
<a href="#" onclick="print();return false;">Click here to print</a>.
</p><p>
<a href="../../../../docs/install-guide/upgrades/">Return to the regular view of this page</a>.
</p>
</div>



<h1 class="title">Upgrades</h1>





    <ul>
    
  
  
  
  

  
    
    
	
<li>1: <a href="#pg-3343397eca2385c268b1e77ebc0c4e41">Minor Upgrades and Patches</a></li>


    
  
    
    
	
<li>2: <a href="#pg-0a1127f5aa5f66d848408d2c8caefecc">Upgrade from v5 to v7</a></li>


    
  
    
    
	
<li>3: <a href="#pg-63dfce89305ebda417758285ed429726">Upgrade from v6 to v7</a></li>


    
  

    </ul>


<div class="content">
      
</div>
</div>


  
  
  
  

  
  

  
    
    
	
    



<div class="td-content" style="--base-section-num: '1.'; ">
    
  <h1 id="pg-3343397eca2385c268b1e77ebc0c4e41">1 - Minor Upgrades and Patches</h1>
    <div class="lead">How to upgrade to a new minor or patch release.</div>
	<p>Stroom versioning follows 






  

<span class="external-link">
  <a href="https://semver.org" target="_blank" class="" style="" title="Semantic Versioning (external link)">
    <span>Semantic Versioning</span>
    <i class="external-link-icon fas fa-external-link-alt fa-sm text-secondary"></i>
  </a>
</span>
.</p>
<p>Given a version number <em>MAJOR</em>.<em>MINOR</em>.<em>PATCH</em>:</p>
<ul>
<li><em>MAJOR</em> is incremented when there are major or breaking changes.</li>
<li><em>MINOR</em> is incremented when functionality is added in a backwards compatible manner.</li>
<li><em>PATCH</em> is incremented when bugs are fixed.</li>
</ul>
<p>Stroom is designed to detect the version of the existing database schema and to run any migrations necessary to bring it up to the version begin deployed.
This means you can jump from say 7.0.0 =&gt; 7.2.0 or from 7.0.0 to 7.0.5.</p>
<p>This document covers minor and patch upgrades only.</p>
<h2 id="docker-stack-deployments">Docker stack deployments</h2>

<div class="alert alert-warning" role="alert">
<h4 class="alert-heading">TODO</h4>

    Complete this

</div>

<h2 id="non-docker-deployments">Non-docker deployments</h2>

<div class="alert alert-warning" role="alert">
<h4 class="alert-heading">TODO</h4>

    Complete this

</div>

<h2 id="major-version-upgrades">Major version upgrades</h2>
<p>The following notes are specific for these major version upgrades</p>
<ul>
<li><a href="../../../../docs/install-guide/upgrades/v6-to-v7/">v6 =&gt; v7</a></li>
</ul>

</div>




    
	
  
    
    
	
    



<div class="td-content" style="--base-section-num: '2.'; page-break-before: always">
    
  <h1 id="pg-0a1127f5aa5f66d848408d2c8caefecc">2 - Upgrade from v5 to v7</h1>
    <div class="lead">This document describes the process for upgrading Stroom from v5.x to v7.x.</div>
	
<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">Note</h4>


    This page is currently work in progress and will evolve with further testing of v5 =&gt; v7 migrations.

</div>



<div class="pageinfo pageinfo-danger">
<h4 class="text-danger alert-heading">Warning</h4>
<p>Before commencing an upgrade to v7 you must upgrade Stroom to the latest minor and patch version of v5.<br>
At the time of writing the latest version of v5 is <code>v5.5.16</code>.</p>

</div>


<h2 id="differences-between-v5-and-v7">Differences between v5 and v7</h2>
<p>Stroom v7 has significant differences to v6 which make the upgrade process a little more complicated.</p>
<ul>
<li>v5 handled authentication within the application.
In v7 authentication is handled either internally in stroom (the default) or by an external identity provider such as google or AWS Cognito.</li>
<li>v5 used the <code>~setup.xml</code>, <code>~env.sh</code> and <code>stroom.properties</code> files for configuration.
In v7 stroom uses a config.yml file for its configuration (see <a href="../../../../docs/user-guide/properties/">Properties</a>)</li>
<li>v5 used upper case and heavily abbreviated names for its tables.
In v7 clearer and lower case table names are used.
As a result ALL v5 tables get renamed with the prefix <code>OLD_</code>, the new tables created and any content copied over.
As the database will be holding two copies of most data you need to ensure you have space to accommodate it.</li>
</ul>
<h2 id="pre-upgrade-tasks">Pre-Upgrade tasks</h2>
<p>Stroom can be upgraded straight from v5 to v7 without going via v6.
There are however a few pre-migration steps that need to be followed.</p>
<h3 id="upgrade-stroom-to-the-latest-v5-version">Upgrade Stroom to the latest v5 version</h3>
<p>Follow your standard process for performing a minor upgrade to bring your v5 Stroom instance up to the latest v5 version.
This ensures all v5 migrations are applying all the v6 and v7 migrations.</p>
<h3 id="download-migration-scripts">Download migration scripts</h3>
<p>Download the migration SQL scripts from <a href="https://github.com/gchq/stroom/blob/STROOM_VERSION/scripts">https://github.com/gchq/stroom/blob/STROOM_VERSION/scripts</a>
e.g. <a href="https://github.com/gchq/stroom/blob/v7.0-beta.198/scripts">https://github.com/gchq/stroom/blob/v7.0-beta.198/scripts</a></p>
<p>Some of these scripts will be used in the steps below.
The unused scripts are not applicable to a v5=&gt;v7 upgrade.</p>
<h3 id="pre-migration-database-checks">Pre-migration database checks</h3>
<p>Run the pre-migration checks script on the running database.</p>

  






<div class="code-toolbar">
  <pre 
    class="command-line language-bash" 
    data-user="stroomuser" 
    data-host="localhost" 
    data-continuation-str="\"
    data-filter-output="(out)"><code class="language-bash">mysql --force --table -u&#34;stroomuser&#34; -p&#34;stroompassword1&#34; stroom \
&lt; v7_db_pre_migration_checks.sql \
&gt; v7_db_pre_migration_checks.out \
2&gt;&amp;1</code></pre>
</div>

<p>This will produce a report of items that will not be migrated or need attention before migration.</p>
<h3 id="capture-non-default-stroom-properties">Capture non-default Stroom properties</h3>
<p>Run the following script to capture the non-default system properties that are held in the database.
This is a precaution in case they are needed following migration.</p>

  






<div class="code-toolbar">
  <pre 
    class="command-line language-bash" 
    data-user="stroomuser" 
    data-host="localhost" 
    data-continuation-str="\"
    data-filter-output="(out)"><code class="language-bash">mysql --force --table -u&#34;stroomuser&#34; -p&#34;stroompassword1&#34; stroom \
&lt; v5_list_properties.sql \
&gt; v5_list_properties.out \
2&gt;&amp;1</code></pre>
</div>

<h3 id="stop-processing">Stop processing</h3>
<p>Before shutting stroom down it is wise to turn off stream processing and let all outstanding server tasks complete.</p>
<p><em>TODO</em> clarify steps for this.</p>
<h3 id="stop-stroom">Stop Stroom</h3>
<p>Stop the stack (stroom and the database) then start up the database.
Do this using the v6 stack.
This ensures that stroom is not trying to access the database.</p>

  






<div class="code-toolbar">
  <pre 
    class="command-line language-bash" 
    data-user="stroomuser" 
    data-host="localhost" 
    data-continuation-str="\"
    data-filter-output="(out)"><code class="language-bash">./stop.sh</code></pre>
</div>

<h3 id="backup-the-databases">Backup the databases</h3>
<p>Backup all the databases for the different components.
Typically these will be <code>stroom</code> and <code>stats</code> (or <code>statistics</code>).</p>
<h3 id="stop-the-database">Stop the database</h3>
<p>Stop the database using the v6 stack.</p>

  






<div class="code-toolbar">
  <pre 
    class="command-line language-bash" 
    data-user="stroomuser" 
    data-host="localhost" 
    data-continuation-str="\"
    data-filter-output="(out)"><code class="language-bash">./stop.sh</code></pre>
</div>

<h3 id="deploy-v7">Deploy v7</h3>
<p>Deploy the latest version of Stroom but don&rsquo;t start it.</p>
<p><em>TODO</em> - more detail</p>
<h3 id="migrate-the-v5-configuration-into-v7">Migrate the v5 configuration into v7</h3>
<p>The configuration properties held in the database and accessed for the <em>Properties</em> UI screen will be migrated automatically by Stroom where possible.</p>
<p>Stroom v5 and v7 however are configured differently when it comes to the configuration files used to bootstrap the application, such as the database connection details.
These properties will need to be manually migrated from the v5 instance to the v7 instance.
The configuration to bootstrap Stroom v5 can be found in <code>instance/lib/stroom.properties</code>.
The configuration for v7 can be found in the following places:</p>
<ul>
<li>Zip distribution - <code>config/config.yml</code>.</li>
<li>Docker stack - <code>volumes/stroom/config/config.yml</code>.
Note that this file uses variable substitution so values can be set in <code>config/&lt;stack_name&gt;.env</code> if suitably substituted.</li>
</ul>
<p>The following table shows the key configuration properties that need to be set to start the application and how they map between v5 and v7.</p>
<table>
<thead>
<tr>
<th>V5 property</th>
<th>V7 property</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td><em>stroom.temp</em></td>
<td><em>appConfig.path.temp</em></td>
<td>Set this if different from <code>$TEMP</code> env var.</td>
</tr>
<tr>
<td>-</td>
<td><em>appConfig.path.home</em></td>
<td>By default all local state (e.g. reference data stores, search results) will live under this directory. Typically it should be in a different location to the stroom instance as it has a different lifecycle.</td>
</tr>
<tr>
<td><em>stroom.node</em></td>
<td><em>appConfig.node.name</em></td>
<td></td>
</tr>
<tr>
<td>-</td>
<td><em>appConfig.nodeUrl.hostname</em></td>
<td>Set this to the FQDN of the node so other nodes can communicate with it.</td>
</tr>
<tr>
<td>-</td>
<td><em>appConfig.publicUrl.hostname</em></td>
<td>Set this to the public FQDN of Stroom, typically a load balancer or Nginx instance.</td>
</tr>
<tr>
<td><em>stroom.jdbcDriverClassName</em></td>
<td><em>appConfig.commonDbDetails.connection.jdbcDriverClassName</em></td>
<td>Do not set this. Will get defaulted to <code>com.mysql.cj.jdbc.Driver</code></td>
</tr>
<tr>
<td><em>stroom.jdbcDriverUrl</em></td>
<td><em>appConfig.commonDbDetails.connection.jdbcDriverUrl</em></td>
<td></td>
</tr>
<tr>
<td><em>stroom.jdbcDriverUsername</em></td>
<td><em>appConfig.commonDbDetails.connection.jdbcDriverUsername</em></td>
<td></td>
</tr>
<tr>
<td><em>stroom.jdbcDriverPassword</em></td>
<td><em>appConfig.commonDbDetails.connection.jdbcDriverPassword</em></td>
<td></td>
</tr>
<tr>
<td><em>stroom.jpaDialect</em></td>
<td>-</td>
<td></td>
</tr>
<tr>
<td><em>stroom.statistics.sql.jdbcDriverClassName</em></td>
<td><em>appConfig.commonDbDetails.connection.jdbcDriverClassName</em></td>
<td>Do not set this. Will get defaulted to <code>com.mysql.cj.jdbc.Driver</code></td>
</tr>
<tr>
<td><em>stroom.statistics.sql.jdbcDriverUrl</em></td>
<td><em>appConfig.statistics.sql.db.connection.jdbcDriverUrl</em></td>
<td></td>
</tr>
<tr>
<td><em>stroom.statistics.sql.jdbcDriverUsername</em></td>
<td><em>appConfig.statistics.sql.db.connection.jdbcDriverUsername</em></td>
<td></td>
</tr>
<tr>
<td><em>stroom.statistics.sql.jdbcDriverPassword</em></td>
<td><em>appConfig.statistics.sql.db.connection.jdbcDriverPassword</em></td>
<td></td>
</tr>
<tr>
<td><em>stroom.statistics.common.statisticEngines</em></td>
<td><em>appConfig.statistics.internal.enabledStoreTypes</em></td>
<td>Do not set this. Will get defaulted to <code>StatisticStore</code></td>
</tr>
<tr>
<td>-</td>
<td><em>appConfig.ui.helpUrl</em></td>
<td>Set this to the URL of your locally published stroom-docs site.</td>
</tr>
<tr>
<td><em>stroom.contentPackImportEnabled</em></td>
<td><em>appConfig.contentPackImport.enabled</em></td>
<td></td>
</tr>
</tbody>
</table>

<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">Note</h4>


    In the <code>config.yml</code> file, properties have a root of <code>appConfig.</code> which corresponds to a root of <code>stroom.</code> in the UI Properties screen.

</div>


<p>Some v5 properties, such as connection pool settings cannot be migrated to v7 equivalents.
It is recommended to review the default values for v7 <code>appConfig.commonDbDetails.connectionPool.*</code> and <code>appConfig.statistics.sql.db.connectionPool.*</code> properties to ensure they are suitable for your environment.
If they are not then set them in the <code>config.yml</code> file.
The defaults can be found in <code>config-defaults.yml</code>.</p>
<h3 id="upgrading-the-mysql-instance-and-database">Upgrading the MySQL instance and database</h3>
<p>Stroom v5 ran on MySQL v5.6.
Stroom v7 runs on MySQL v8.
The upgrade path for MySQL is 5.6 =&gt; 5.7.33 =&gt; 8.x (see 






  

<span class="external-link">
  <a href="https://dev.mysql.com/doc/refman/8.0/en/upgrade-paths.html" target="_blank" class="" style="" title="Upgrade Paths (external link)">
    <span>Upgrade Paths</span>
    <i class="external-link-icon fas fa-external-link-alt fa-sm text-secondary"></i>
  </a>
</span>
).</p>
<p>To ensure the database is up to date <code>mysql_upgrade</code> needs to be run using the 5.7.33 binaries, see the 






  

<span class="external-link">
  <a href="https://dev.mysql.com/doc/refman/8.0/en/mysql-upgrade.html" target="_blank" class="" style="" title="MySQL documentation (external link)">
    <span>MySQL documentation</span>
    <i class="external-link-icon fas fa-external-link-alt fa-sm text-secondary"></i>
  </a>
</span>
.</p>
<p>This is the process for upgrading the database.
The exact steps will depend on how you have installed MySQL.</p>
<ol>
<li>Shutdown the database instance.</li>
<li>Remove the MySQL 5.6 binaries, e.g. using your package manager.</li>
<li>Install the MySQL 5.7.33 binaries.</li>
<li>Start the database instance using the 5.7.33 binaries.</li>
<li>Run <code>mysql_upgrade</code> to upgrade the database to 5.7 specification.</li>
<li>Shutdown the database instance.</li>
<li>Remove the MySQL 5.7.33 binaries.</li>
<li>Install the latest MySQL 8.0 binaries.</li>
<li>Start the database instance.
On start up MySQL 8 will detect a v5.7 instance and upgrade it to 8.0 spec automatically without the need to run <code>mysql_upgrade</code>.</li>
</ol>
<h2 id="performing-the-stroom-upgrade">Performing the Stroom upgrade</h2>
<p>To perform the stroom schema upgrade to v7 run the <em>migrate</em> command (on a single node) which will migrate the database then exit.
For a large upgrade like this is it is preferable to run the <em>migrate</em> command rather than just starting Stroom as Stroom will only migrate the parts of the schema as it needs to use them so some parts of the database may not be migrated initially.
Running the migrate command ensures all parts of the migration are completed when the command is run and no other parts of stroom will be started.</p>

  






<div class="code-toolbar">
  <pre 
    class="command-line language-bash" 
    data-user="stroomuser" 
    data-host="localhost" 
    data-continuation-str="\"
    data-filter-output="(out)"><code class="language-bash">./migrate.sh</code></pre>
</div>

<h2 id="post-upgrade-tasks">Post-Upgrade tasks</h2>
<p><em>TODO</em></p>

</div>




    
	
  
    
    
	
    



<div class="td-content" style="--base-section-num: '3.'; page-break-before: always">
    
  <h1 id="pg-63dfce89305ebda417758285ed429726">3 - Upgrade from v6 to v7</h1>
    <div class="lead">This document describes the process for upgrading a Stroom single node docker stack from v6.x to v7.x.</div>
	
<div class="pageinfo pageinfo-danger">
<h4 class="text-danger alert-heading">Warning</h4>
<p>Before comencing an upgrade to v7 you should upgrade Stroom to the latest minor and patch version of v6.</p>

</div>


<h2 id="differences-between-v6-and-v7">Differences between v6 and v7</h2>
<p>Stroom v7 has significant differences to v6 which make the upgrade process a little more complicated.</p>
<ul>
<li>v6 handled authentication using a separate application, <em>stroom-auth-service</em>, with its own database.
In v7 authentication is handled either internally in stroom (the default) or by an external identity provider such as google or AWS Cognito.</li>
<li>v6 used a stroom.conf file or environment variables for configuration.
In v7 stroom uses a config.yml file for its configuration (see <a href="../../../../docs/user-guide/properties/">Properties</a>)</li>
<li>v6 used upper case and heavily abbreviated names for its tables.
In v7 clearer and lower case table names are used.
As a result ALL v6 tables get renamed with the prefix <code>OLD_</code>, the new tables created and any content copied over.
As the database will be holding two copies of most data you need to ensure you have space to accomodate it.</li>
</ul>
<h2 id="pre-upgrade-tasks">Pre-Upgrade tasks</h2>
<p>The following steps are required to be performed before migrating from v6 to v7.</p>
<h3 id="download-migration-scripts">Download migration scripts</h3>
<p>Download the migration SQL scripts from <a href="https://github.com/gchq/stroom/blob/STROOM_VERSION/scripts">https://github.com/gchq/stroom/blob/STROOM_VERSION/scripts</a>
e.g. <a href="https://github.com/gchq/stroom/blob/v7.0-beta.133/scripts">https://github.com/gchq/stroom/blob/v7.0-beta.133/scripts</a></p>
<p>These scripts will be used in the steps below.</p>
<h3 id="pre-migration-database-checks">Pre-migration database checks</h3>
<p>Run the pre-migration checks script on the running database.</p>

  






<div class="code-toolbar">
  <pre 
    class="command-line language-bash" 
    data-user="stroomuser" 
    data-host="localhost" 
    data-continuation-str="\"
    data-filter-output="(out)"><code class="language-bash">docker exec \
-i \
stroom-all-dbs \
mysql --table -u&#34;stroomuser&#34; -p&#34;stroompassword1&#34; stroom \
&lt; v7_db_pre_migration_checks.sql</code></pre>
</div>

<p>This will produce a report of items that will not be migrated or need attention before migration.</p>
<h3 id="stop-processing">Stop processing</h3>
<p>Before shutting stroom down it is wise to turn off stream processing and let all outstanding server tasks complete.</p>
<p><em>TODO</em> clairfy steps for this.</p>
<h3 id="stop-the-stack">Stop the stack</h3>
<p>Stop the stack (stroom and the database) then start up the database.
Do this using the v6 stack.
This ensures that stroom is not trying to access the database.</p>

  






<div class="code-toolbar">
  <pre 
    class="command-line language-bash" 
    data-user="stroomuser" 
    data-host="localhost" 
    data-continuation-str="\"
    data-filter-output="(out)"><code class="language-bash">./stop.sh
./start.sh stroom-all-dbs</code></pre>
</div>

<h3 id="backup-the-databases">Backup the databases</h3>
<p>Backup all the databases for the different components.
Typically these will be <code>stroom</code>, <code>stats</code> and <code>auth</code>.</p>
<p>If you are running in a docker stack then you can run the <code>./backup_databases.sh</code> script.</p>
<h3 id="stop-the-database">Stop the database</h3>
<p>Stop the database using the v6 stack.</p>

  






<div class="code-toolbar">
  <pre 
    class="command-line language-bash" 
    data-user="stroomuser" 
    data-host="localhost" 
    data-continuation-str="\"
    data-filter-output="(out)"><code class="language-bash">./stop.sh</code></pre>
</div>

<h3 id="deploy-and-configure-v7">Deploy and configure v7</h3>
<p>Deploy the v7 stack.
<em>TODO</em> - more detail</p>
<p>Verify the database connection configuration for the stroom and stats databases.
Ensure that there is NOT any configuration for a separate auth database as this will now be in stroom.</p>
<h3 id="running-mysql_upgrade">Running <code>mysql_upgrade</code></h3>
<p>Stroom v6 ran on mysql v5.6.
Stroom v7 runs on mysql v8.
The upgrade path for MySQL is 5.6 =&gt; 5.7.33 =&gt; 8.x</p>
<p>To ensure the database is up to date <code>mysql_upgrade</code> neeeds to be run using the 5.7.33 binaries, see the 






  

<span class="external-link">
  <a href="https://dev.mysql.com/doc/refman/8.0/en/mysql-upgrade.html" target="_blank" class="" style="" title="MySQL documentation (external link)">
    <span>MySQL documentation</span>
    <i class="external-link-icon fas fa-external-link-alt fa-sm text-secondary"></i>
  </a>
</span>
.</p>
<p>This is the process for upgrading the database. All of these commands are using the v7 stack.</p>

  






<div class="code-toolbar">
  <pre 
    class="command-line language-bash" 
    data-user="stroomuser" 
    data-host="localhost" 
    data-continuation-str="\"
    data-filter-output="(out)"><code class="language-bash"># Set the version of the MySQL docker image to use
export MYSQL_TAG=5.7.33
(out)
# Start MySQL at v5.7, this will recreate the container
./start.sh stroom-all-dbs
(out)
# Run the upgrade from 5.6 =&gt; 5.7.33
docker exec -it stroom-all-dbs mysql_upgrade -u&#34;root&#34; -p&#34;my-secret-pw&#34;
(out)
# Stop MySQL
./stop.sh
(out)
# Unset the tag variable so that it now uses the default from the stack (8.x)
unset MYSQL_TAG
(out)
# Start MySQL at v8.x, this will recreate the container and run the upgrade from 5.7.33=&gt;8
./start.sh stroom-all-dbs
(out)
./stop.sh</code></pre>
</div>

<h3 id="rename-legacy-stroom-auth-tables">Rename legacy stroom-auth tables</h3>
<p>Run this command to connect to the <code>auth</code> database and run the pre-migration SQL script.</p>

  






<div class="code-toolbar">
  <pre 
    class="command-line language-bash" 
    data-user="stroomuser" 
    data-host="localhost" 
    data-continuation-str="\"
    data-filter-output="(out)"><code class="language-bash">docker exec \
-i \
stroom-all-dbs \
mysql --table -u&#34;authuser&#34; -p&#34;stroompassword1&#34; auth \
&lt; v7_auth_db_table_rename.sql</code></pre>
</div>

<p>This will rename all but one of the tables in the <code>auth</code> database.</p>
<h3 id="copy-the-auth-database-content-to-stroom">Copy the <code>auth</code> database content to <code>stroom</code></h3>
<p>Having run the table rename perform another backup of just the <code>auth</code> database.</p>
<p>
  






<div class="code-toolbar">
  <pre 
    class="command-line language-bash" 
    data-user="stroomuser" 
    data-host="localhost" 
    data-continuation-str="\"
    data-filter-output="(out)"><code class="language-bash">./backup_databases.sh . auth</code></pre>
</div>

Now restore this backup into the <code>stroom</code> database.
You can use the v7 stack scripts to do this.</p>

  






<div class="code-toolbar">
  <pre 
    class="command-line language-bash" 
    data-user="stroomuser" 
    data-host="localhost" 
    data-continuation-str="\"
    data-filter-output="(out)"><code class="language-bash">./restore_database.sh stroom auth_20210312143513.sql.gz</code></pre>
</div>

<p>You should now see the following tables in the <code>stroom</code> database:</p>
<pre><code class="language-text">OLD_AUTH_json_web_key
OLD_AUTH_schema_version
OLD_AUTH_token_types
OLD_AUTH_tokens
OLD_AUTH_users
</code></pre>
<p>This can be checked by running the following in the v7 stack.</p>

  






<div class="code-toolbar">
  <pre 
    class="command-line language-bash" 
    data-user="stroomuser" 
    data-host="localhost" 
    data-continuation-str="\"
    data-filter-output="(out)"><code class="language-bash">echo &#39;select table_name from information_schema.tables where table_name like &#34;OLD_AUTH%&#34;&#39; \
| ./database_shell.sh</code></pre>
</div>

<h3 id="drop-unused-databases">Drop unused databases</h3>
<p>There may be a number of databases that are no longer used that can be dropped prior to the upgrade.
Note the use of the <code>--force</code> argument so it copes with users that are not there.</p>

  






<div class="code-toolbar">
  <pre 
    class="command-line language-bash" 
    data-user="stroomuser" 
    data-host="localhost" 
    data-continuation-str="\"
    data-filter-output="(out)"><code class="language-bash">docker exec \
-i \
stroom-all-dbs \
mysql --force -u&#34;root&#34; -p&#34;my-secret-pw&#34; \
&lt; v7_drop_unused_databases.sql</code></pre>
</div>

<p>Verify it worked with:</p>

  






<div class="code-toolbar">
  <pre 
    class="command-line language-bash" 
    data-user="stroomuser" 
    data-host="localhost" 
    data-continuation-str="\"
    data-filter-output="(out)"><code class="language-bash">echo &#39;show databases;&#39; | docker exec -i stroom-all-dbs mysql -u&#34;root&#34; -p&#34;my-secret-pw&#34;</code></pre>
</div>

<h2 id="performing-the-upgrade">Performing the upgrade</h2>
<p>To perform the stroom schema upgrade to v7 run the migrate command which will migrate the database then exit.
For a large upgrade like this is it is preferable to run the migrate command rather than just starting stroom as stroom will only migrate the parts of the schema as it needs to use them.
Running migrate ensures all parts of the migration are completed when the command is run and no other parts of stroom will be started.</p>

  






<div class="code-toolbar">
  <pre 
    class="command-line language-bash" 
    data-user="stroomuser" 
    data-host="localhost" 
    data-continuation-str="\"
    data-filter-output="(out)"><code class="language-bash">./migrate.sh</code></pre>
</div>

<h2 id="post-upgrade-tasks">Post-Upgrade tasks</h2>
<p><em>TODO</em> remove auth* containers,images,volumes</p>

</div>




    
	
  



          </main>
        </div>
      </div>
      
<footer class="bg-dark py-5 row d-print-none">
  <div class="container-fluid mx-sm-5">
    <div class="row">
      <div class="col-6 col-sm-4 text-xs-center order-sm-2">
        
        
        
      </div>
      <div class="col-6 col-sm-4 text-right text-xs-center order-sm-3">
        
        
        
<ul class="list-inline mb-0">
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="GitHub" aria-label="GitHub">
    <a class="text-white" target="_blank" rel="noopener" href="https://github.com/gchq/stroom" aria-label="GitHub">
      <i class="fab fa-github"></i>
    </a>
  </li>
  
</ul>

        
        
      </div>
      <div class="col-12 col-sm-4 text-center py-2 order-sm-2">
        <small class="text-white">&copy; 2023 Crown Copyright All Rights Reserved</small>
        
	
      </div>
    </div>
  </div>
</footer>


    </div>
    

<script src='../../../../js/popper.min.js'></script>
<script src='../../../../js/bootstrap.min.js'></script>






<script src='../../../../js/tabpane-persist.js'></script>




















<script src="../../../../js/main.min.cbc1d428d83561c4dec32da9374290554119d7483329f849251cb7153b2ecd07.js" integrity="sha256-y8HUKNg1YcTewy2pN0KQVUEZ10gzKfhJJRy3FTsuzQc=" crossorigin="anonymous"></script>



<script src='../../../../js/prism.js'></script>



  </body>
</html>
