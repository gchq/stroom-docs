<!doctype html>
<html lang="en" class="no-js">
  <head>
    
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="generator" content="Hugo 0.95.0" />
<link rel="canonical" type="text/html" href="../../../docs/install-guide/">
<meta name="robots" content="noindex, nofollow">


<link rel="shortcut icon" href="../../../favicons/favicon.ico" >
<link rel="apple-touch-icon" href="../../../favicons/apple-touch-icon-180x180.png" sizes="180x180">
<link rel="icon" type="image/png" href="../../../favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="../../../favicons/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="../../../favicons/android-36x36.png" sizes="36x36">
<link rel="icon" type="image/png" href="../../../favicons/android-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="../../../favicons/android-72x72.png" sizes="72x72">
<link rel="icon" type="image/png" href="../../../favicons/android-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="../../../favicons/android-144x144.png" sizes="144x144">
<link rel="icon" type="image/png" href="../../../favicons/android-192x192.png" sizes="192x192">

<title>Installation Guide | Stroom</title>
<meta name="description" content="This section describes how to install Stroom, its dependencies and related applications.
">
<meta property="og:title" content="Installation Guide" />
<meta property="og:description" content="This section describes how to install Stroom, its dependencies and related applications.
" />
<meta property="og:type" content="website" />
<meta property="og:url" content="/docs/install-guide/" /><meta property="og:site_name" content="Stroom" />

<meta itemprop="name" content="Installation Guide">
<meta itemprop="description" content="This section describes how to install Stroom, its dependencies and related applications.
"><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Installation Guide"/>
<meta name="twitter:description" content="This section describes how to install Stroom, its dependencies and related applications.
"/>





<link href="../../../scss/main.css" rel="stylesheet">


<script src='../../../js/jquery-3.6.0.min.js'></script>


<script src='../../../js/lunr.min.js'></script>
  
<link rel="stylesheet" href="../../../css/prism.css"/>

  </head>
  <body class="td-section">
    <header>
      
<nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar">
        <a class="navbar-brand" href="../../../">
		<span class="navbar-logo"><svg xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:cc="http://creativecommons.org/ns#" xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#" xmlns:svg="http://www.w3.org/2000/svg" xmlns="http://www.w3.org/2000/svg" xmlns:sodipodi="http://sodipodi.sourceforge.net/DTD/sodipodi-0.dtd" xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape" width="110.61089" height="30.000004" viewBox="0 0 88.488641 23.999957" id="svg2" inkscape:version="0.91 r13725" sodipodi:docname="logo.svg"><defs id="defs20"/><sodipodi:namedview pagecolor="#989898" bordercolor="#666666" borderopacity="1" objecttolerance="10" gridtolerance="10" guidetolerance="10" inkscape:pageopacity="0" inkscape:pageshadow="2" inkscape:window-width="1920" inkscape:window-height="1137" id="namedview18" showgrid="false" fit-margin-top="0" fit-margin-left="0" fit-margin-right="0" fit-margin-bottom="0" inkscape:zoom="5.5951814" inkscape:cx="55.451414" inkscape:cy="16.275348" inkscape:window-x="0" inkscape:window-y="0" inkscape:window-maximized="1" inkscape:current-layer="svg2"/><g id="g4150" style="opacity:.97000002" transform="matrix(0.03883584,0,0,0.03883584,0,-3.1155874e-4)"><path id="path6" d="M121.99991 205.98497C54.999958 205.98497.0 259.98493.0 327.98487c0 66.99994 54.999958 121.99989 121.99991 121.99989h167.99987c24.99998.0 44.99996 20.99998 44.99996 44.99996.0 24.99998-19.99998 44.99996-44.99996 44.99996H109.20929C65.984126 553.87219 27.100843 581.57313.01093599 617.98462H289.99978c66.99994.0 121.99991-54.99996 121.99991-122.9999.0-66.99994-54.99997-121.99989-121.99991-121.99989H121.99991c-24.999984.0-44.999969-19.99999-44.999969-44.99996.0-24.99998 19.999985-44.99996 44.999969-44.99996h228.79045c26.9905-35.88325 65.47093-63.18547 108.21554-76.99994H121.99991z" style="fill:#fff" inkscape:connector-curvature="0"/><path id="path8" d="M601.44485-.00077860649C572.6583 8.3697982 546.49491 22.822962 524.44491 41.902305V205.78969l.002.19528h-.002c-65.11 48e-5-123.03145 30.0199-160.74675 76.99994h160.74675v334.99971h76.99994V282.98491h144.85298c27.16134-36.05885 65.96411-63.39275 109.02184-76.99994H601.44485v-205.98574860649z" style="fill:#fff" inkscape:connector-curvature="0"/><path id="path10" d="m919.42586 205.98497c-113.99519.0-205.99537 92.00648-206.00296 205.99982-15e-5 68.67178.0 137.32749.0 205.99983h77.99994c-.012-68.6493.0176-137.46869.0-205.99983.0846-70.92785 57.05747-128.99988 128.00462-128.99988 5.28623.0 10.49823.32864 15.62183.95311 18.2219-24.51229 41.78461-45.0838 68.42501-60.15146-25.65065-11.43799-54.08662-17.80159-84.04684-17.80159z" style="fill:#fff" inkscape:connector-curvature="0"/><path id="path12" d="m1109.4153 205.98457c-113.99994.0-205.99983 91.99993-205.99983 205.99984.0 112.9999 91.99989 205.9998 205.99983 205.9998 114 0 205.9999-92.9999 205.9999-205.9998.0-113.99991-91.9999-205.99984-205.9999-205.99984zm0 333.99974c-70.9999.0-128.99994-56.99996-128.99994-127.9999.0-70.99995 58.00004-128.9999 128.99994-128.9999 71 0 128.9999 57.99995 128.9999 128.9999.0 70.99994-57.9999 127.9999-128.9999 127.9999z" style="fill:#fff" inkscape:connector-curvature="0"/><path id="path14" d="m1444.4737 205.98457c-113.9999.0-205.9998 91.99993-205.9998 205.99984.0 112.9999 91.9999 205.9998 205.9998 205.9998s205.9999-92.9999 205.9999-205.9998c0-113.99991-92-205.99984-205.9999-205.99984zm0 333.99974c-70.9999.0-128.9999-56.99996-128.9999-127.9999.0-70.99995 58-128.9999 128.9999-128.9999 71 0 128.9999 57.99995 128.9999 128.9999.0 70.99994-57.9999 127.9999-128.9999 127.9999z" style="fill:#fff" inkscape:connector-curvature="0"/><path id="path16" d="m1738.5308 379.98447c0-53 43-97 95.9999-97 53 0 97 44 97 97v237.9997h76.9999v-237.9997c0-53 43-97 96.9999-97 53 0 95.9999 44 95.9999 97v237.9997h77v-237.9997c0-96-77-173.9999-172.9999-173.9999-54.9999.0-103.9999 24.99998-135.9999 64.99995-31.9999-39.99997-79.9999-64.99995-134.9999-64.99995-95.9999.0-173.9998 77.9999-173.9998 173.9999v237.9997h77.9999z" style="fill:#fff" inkscape:connector-curvature="0"/></g></svg></span><span class="font-weight-bold">Stroom</span>
	</a>
	<div class="td-navbar-nav-scroll ml-md-auto" id="main_navbar">
		<ul class="navbar-nav mt-2 mt-lg-0">
			
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				
				
				<a class="nav-link" href="../../../about/about/" ><span>About</span></a>
			</li>
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				
				
				<a class="nav-link active" href="../../../docs/" ><span class="active">Documentation</span></a>
			</li>
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				
				
				<a class="nav-link" href="../../../community/" ><span>Community</span></a>
			</li>
			
			
			<li class="nav-item dropdown mr-4 d-none d-lg-block">
				<a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
	Stroom Version (Legacy)
</a>
<div class="dropdown-menu" aria-labelledby="navbarDropdownMenuLink">
	
	<a class="dropdown-item" href="../../../../7.1">7.1</a>
	
	<a class="dropdown-item" href="../../../../7.0">7.0</a>
	
	<a class="dropdown-item" href="../../../../legacy">Legacy</a>
	
</div>

			</li>
			
			
		</ul>
	</div>
	<div class="navbar-nav d-none d-lg-block"><input
  type="search"
  class="form-control td-search-input"
  placeholder="&#xf002; Search this site…"
  aria-label="Search this site…"
  autocomplete="off"
  
  data-offline-search-index-json-src="../../../offline-search-index.json"
  data-offline-search-base-href="../../../"
  data-offline-search-max-results="50"
>
</div>
</nav>

    </header>
    <div class="container-fluid td-outer">
      <div class="td-main">
        <div class="row flex-xl-nowrap">
          <main class="col-12 col-md-9 col-xl-8 pl-md-5" role="main">
            




<div class="td-content">
<div class="pageinfo pageinfo-primary d-print-none">
<p>
This is the multi-page printable view of this section.
<a href="#" onclick="print();return false;">Click here to print</a>.
</p><p>
<a href="../../../docs/install-guide/">Return to the regular view of this page</a>.
</p>
</div>



<h1 class="title">Installation Guide</h1>
<div class="lead">This section describes how to install Stroom, its dependencies and related applications.</div>




    <ul>
    
  
  
  
  

  
    
    
	
<li>1: <a href="#pg-4539c9eea16d100709bb0c63eb985376">Setup</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>1.1: <a href="#pg-baf25f528dd0b5d043a6131fcf804e8d">Apache Forwarding</a></li>


    
  
    
    
	
<li>1.2: <a href="#pg-06d5f6643ea3f5b645b70260fb32e360">Java Key Store Setup</a></li>


    
  
    
    
	
<li>1.3: <a href="#pg-2ca84eb0d1a73aaef4a9d836a7d0b0be">MySQL Setup</a></li>


    
  
    
    
	
<li>1.4: <a href="#pg-83516d1c6898776469e61e1639643937">Processing Users</a></li>


    
  
    
    
	
<li>1.5: <a href="#pg-1423b5de8658215848877b76e270e0c7">Securing Stroom</a></li>


    
  

    </ul>
    
  
    
    
	
<li>2: <a href="#pg-6f66d654efd57ce50e45cd099ee248ff">Stroom 5 Installation</a></li>


    
  
    
    
	
<li>3: <a href="#pg-c799e218c5cb8bef7fb1cf2660a8064c">Stroom 6 Architecture &amp; Depployment</a></li>


    
  
    
    
	
<li>4: <a href="#pg-b8704340a0ac9246d13f2c84c3c850b0">Stroom 6 Installation</a></li>


    
  
    
    
	
<li>5: <a href="#pg-da2ad51ba4d61c7122800e900e397c63">Stroom Proxy Installation</a></li>


    
  
    
    
	
<li>6: <a href="#pg-6982f6e621f1d467e7ca809128cdf465">Stroom Upgrades</a></li>


    
  
    
    
	
<li>7: <a href="#pg-f6ffd8d1b01a0988e33029f1507960c6">Upgrades</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>7.1: <a href="#pg-751a8e0db6ce54a247c6cecee7659fca">v6 to v7 Upgrade</a></li>


    
  

    </ul>
    
  
    
    
	
<li>8: <a href="#pg-c89e5b17a07204690526a16417c9dd50">Configuration</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>8.1: <a href="#pg-a53a193cf4abc0b6dfa8fa20a2fda8e2">Nginx Configuration</a></li>


    
  
    
    
	
<li>8.2: <a href="#pg-f67b02c1954e1e3755f22565ea9c45a2">Stroom Configuration</a></li>


    
  
    
    
	
<li>8.3: <a href="#pg-2fbd4f6015742d6292564c2fec48dde8">Stroom Proxy Configuration</a></li>


    
  
    
    
	
<li>8.4: <a href="#pg-cea106477cd6590d5c2f583e39fc1d53">Stroom Log Sender Configuration</a></li>


    
  
    
    
	
<li>8.5: <a href="#pg-c55274dc8017978026995b0c30172626">MySQL Configuration</a></li>


    
  

    </ul>
    
  

    </ul>


<div class="content">
      
</div>
</div>


  
  
  
  

  
  

  
    
    
	
    



<div class="td-content" style="--base-section-num: '1.'; ">
    
  <h1 id="pg-4539c9eea16d100709bb0c63eb985376">1 - Setup</h1>
    
	
</div>




    
      
  
  
  
  

  
  

  
    
    
	
    



<div class="td-content" style="--base-section-num: '1.1.'; ">
    
  <h1 id="pg-baf25f528dd0b5d043a6131fcf804e8d">1.1 - Apache Forwarding</h1>
    
	
<div class="pageinfo pageinfo-danger">
<h4 class="text-danger alert-heading">Warning</h4>
<p>This document refers to v4/5.</p>

</div>


<p>Stroom defaults to listening for HTTP on port 8080.
It is recommended that Apache is used to listen on the standard HTTP port 80 and forward requests on via the Apache mod_jk module and the AJP protocol (on 8009).
Apache can also perform HTTPS on port 443 and pass over requests to Tomcat using the same AJP protocol.</p>
<p>It is additionally recommended that Stroom Proxy is used to front data ingest and so Apache is configured to route traffic to http(s)://server/stroom/datafeed to Stroom Proxy and anything else to Stroom.</p>
<h2 id="prerequisites">Prerequisites</h2>
<ul>
<li>tomcat-connectors-1.2.31-src.tar.gz</li>
</ul>
<h2 id="setup-apache">Setup Apache</h2>
<ul>
<li>As root</li>
<li>Patch mod_jk</li>
</ul>
<pre><code class="language-bash">cd ~/tmp
tar -xvzf tomcat-connectors-1.2.31-src.tar.gz 
cd tomcat-connectors-1.2.31-src/native
./configure --with-apxs=/usr/sbin/apxs 
make
sudo cp apache-2.0/mod_jk.so /etc/httpd/modules/
cd
</code></pre>
<ul>
<li>Put the web server cert, private key, and CA cert into the web servers conf directory  /etc/httpd/conf.  E.g.</li>
</ul>
<pre><code class="language-bash">[user@node1 stroom-doc]$ ls -al /etc/httpd/conf
....
-rw-r--r-- 1 root root  1729 Aug 27  2013 host.crt
-rw-r--r-- 1 root root  1675 Aug 27  2013 host.key
-rw-r--r-- 1 root root  1289 Aug 27  2013 CA.crt
....
</code></pre>
<ul>
<li>Make changes to /etc/http/conf.d/ssl.conf as per below</li>
</ul>
<pre><code class="language-text">JkMount /stroom* local
JkMount /stroom/remoting/cluster* local
</code></pre>
<pre><code class="language-text">JkOptions +ForwardKeySize +ForwardURICompat +ForwardSSLCertChain -ForwardDirectories

SSLCertificateFile /etc/httpd/conf/[YOUR SERVER].crt
SSLCertificateKeyFile /etc/httpd/conf/[YOUR SERVER].key
SSLCertificateChainFile /etc/httpd/conf/[YOUR CA].crt
SSLCACertificateFile /etc/httpd/conf/[YOUR CA APPENDED LIST].crt

SSLOptions +ExportCertData
</code></pre>
<ul>
<li>Remove /etc/httpd/conf.d/nss.conf to avoid a 8443 port clash</li>
</ul>
<pre><code class="language-bash">rm /etc/httpd/conf.d/nss.conf 
</code></pre>
<ul>
<li>Create a /etc/httpd/conf.d/mod_jk.conf configuration</li>
</ul>
<pre><code class="language-text">LoadModule jk_module modules/mod_jk.so
JkWorkersFile conf/workers.properties
JkLogFile logs/mod_jk.log
JkLogLevel info
JkLogStampFormat  &quot;[%a %b %d %H:%M:%S %Y]&quot;
JkOptions +ForwardKeySize +ForwardURICompat +ForwardSSLCertChain -ForwardDirectories
JkRequestLogFormat &quot;%w %V %T&quot;
</code></pre>
<pre><code class="language-text">JkMount /stroom* local
JkMount /stroom/remoting/cluster* local
</code></pre>
<pre><code class="language-text">JkShmFile logs/jk.shm
&lt;Location /jkstatus/&gt;
    JkMount status
    Order deny,allow
    Deny from all
    Allow from 127.0.0.1
&lt;/Location&gt;
</code></pre>
<ul>
<li>Setup stroom-setup/cluster.txt, generate the workers file and copy into Apache.  (as root and replace stroomuser with your processing user)</li>
</ul>
<pre><code class="language-bash">/home/stroomuser/stroom-setup/workers.properties.sh --cluster=/home/stroomuser/cluster.txt &gt; /etc/httpd/conf/workers.properties
</code></pre>
<ul>
<li>Inspect /etc/httpd/conf/workers.properties to make sure it looks as you expect for your cluster</li>
</ul>
<pre><code class="language-text">worker.list=loadbalancer,local,status
worker.stroom_1.port=8009
worker.stroom_1.host=localhost
worker.stroom_1.type=ajp13
worker.stroom_1.lbfactor=1
worker.stroom_1.max_packet_size=65536
....
....
worker.loadbalancer.type=lb
worker.loadbalancer.balance_workers=stroom_1,stroom_2
worker.loadbalancer.sticky_session=1
worker.local.type=lb
worker.local.balance_workers=stroom_1
worker.local.sticky_session=1
worker.status.type=status
</code></pre>
<ul>
<li>Create a simple redirect page to the stroom web app for the root URL (e.g. DocumentRoot &ldquo;/var/www/html&rdquo;, index.html)</li>
</ul>
<pre><code class="language-text">&amp;lt;html&amp;gt;&amp;lt;head&amp;gt;&amp;lt;meta http-equiv=&quot;Refresh&quot; content=&quot;0; URL=stroom&quot;&amp;gt;&amp;lt;/head&amp;gt;&amp;lt;/html&amp;gt;
</code></pre>
<ul>
<li>Restart Apache and then test default http / https access.</li>
</ul>
<pre><code class="language-bash">sudo /etc/init.d/httpd restart
</code></pre>
<h2 id="advanced-forwarding">Advanced Forwarding</h2>
<p>Typically Stroom is setup so that traffic sent to /stroom* is routed to Stroom and /stroom/datafeed to Stroom Proxy.  It is possible to setup an extra 1 level of datafeed routing so that based on the URL this traffic can be routed differently.</p>
<p>For example to route traffic directly to Stroom under the URL /stroom/datafeed/direct (avoiding any aggregation) the following mod_jk setting could be used.</p>
<pre><code class="language-text">JkMount /stroom/datafeed/direct* loadbalancer
</code></pre>

</div>




    
	
  
    
    
	
    



<div class="td-content" style="--base-section-num: '1.2.'; page-break-before: always">
    
  <h1 id="pg-06d5f6643ea3f5b645b70260fb32e360">1.2 - Java Key Store Setup</h1>
    
	<p>In order that the java process communicates over https (for example Stroom Proxy forwarding onto Stroom) the JVM requires relevant keystore&rsquo;s setting up.</p>
<p>As the processing user copy the following files to a directory stroom-jks in the processing user home directory :</p>
<ul>
<li>CA.crt     - Certificate Authority</li>
<li>SERVER.crt - Server certificate with client authentication attributes</li>
<li>SERVER.key - Server private key</li>
</ul>
<p>As the processing user perform the following:</p>
<ul>
<li>First turn your keys into der format:</li>
</ul>
<pre><code class="language-bash">cd ~/stroom-jks

SERVER=&lt;SERVER crt/key PREFIX&gt;
AUTHORITY=CA

openssl x509 -in ${SERVER}.crt -inform PEM -out ${SERVER}.crt.der -outform DER
openssl pkcs8 -topk8 -nocrypt -in ${SERVER}.key -inform PEM -out ${SERVER}.key.der -outform DER
</code></pre>
<ul>
<li>Import Keys into the Key Stores:</li>
</ul>
<pre><code class="language-bash">Stroom_UTIL_JAR=`find ~/*app -name 'stroom-util*.jar' -print | head -1`

java -cp ${Stroom_UTIL_JAR} stroom.util.cert.ImportKey keystore=${SERVER}.jks keypass=${SERVER} alias=${SERVER} keyfile=${SERVER}.key.der certfile=${SERVER}.crt.der
keytool -import -noprompt -alias ${AUTHORITY} -file ${AUTHORITY}.crt -keystore ${AUTHORITY}.jks -storepass ${AUTHORITY}
</code></pre>
<ul>
<li>Update Processing User Global Java Settings:</li>
</ul>
<pre><code class="language-bash">PWD=`pwd`
echo &quot;export JAVA_OPTS=\&quot;-Djavax.net.ssl.trustStore=${PWD}/${AUTHORITY}.jks -Djavax.net.ssl.trustStorePassword=${AUTHORITY} -Djavax.net.ssl.keyStore=${PWD}/${SERVER}.jks -Djavax.net.ssl.keyStorePassword=${SERVER}\&quot;&quot; &gt;&gt; ~/env.sh  
</code></pre>
<p>Any Stroom or Stroom Proxy instance will now additionally pickup the above JAVA_OPTS settings.</p>

</div>




    
	
  
    
    
	
    



<div class="td-content" style="--base-section-num: '1.3.'; page-break-before: always">
    
  <h1 id="pg-2ca84eb0d1a73aaef4a9d836a7d0b0be">1.3 - MySQL Setup</h1>
    
	<h2 id="prerequisites">Prerequisites</h2>
<ul>
<li>MySQL 5.5.y server installed (e.g. yum install mysql-server)</li>
<li>Processing User Setup</li>
</ul>
<p>A single MySQL database is required for each Stroom instance.
You do not need to setup a MySQL instance per node in your cluster.</p>
<h2 id="check-database-installed-and-running">Check Database installed and running</h2>
<pre><code class="language-bash">[root@stroomdb ~]# /sbin/chkconfig --list mysqld
mysqld          0:off   1:off   2:on    3:on    4:on    5:on    6:off
[root@stroomdb ~]# mysql --user=root -p
Enter password:
Welcome to the MySQL monitor.  Commands end with ; or \g.
...
mysql&gt; quit      
</code></pre>
<p>The following commands can be used to auto start mysql if required:</p>
<pre><code class="language-bash">[root@stroomdb ~]# /sbin/chkconfig –level 345 mysqld on
[root@stroomdb ~]# /sbin/service httpd start
</code></pre>
<h2 id="overview">Overview</h2>
<p>MySQL configuration can be simple to complex depending on your requirements.<br>
For a very simple configuration you simply need an out-of-the-box mysql
install and create a database user account.</p>
<p>Things get more complicated when considering:</p>
<ul>
<li>Security</li>
<li>Master Slave Replication</li>
<li>Tuning memory usage</li>
<li>Running Stroom Stats in a different database to Stroom</li>
<li>Performance Monitoring</li>
</ul>
<h2 id="simple-install">Simple Install</h2>
<p>Ensure the database is running, create the database and access to it</p>
<pre><code class="language-bash">[stroomuser@host stroom-setup]$ mysql --user=root
Welcome to the MySQL monitor.  Commands end with ; or \g.
...

mysql&gt; create database stroom;
Query OK, 1 row affected (0.02 sec)

mysql&gt; grant all privileges on stroom.* to 'stroomuser'@'host' identified by 'password';
Query OK, 0 rows affected (0.00 sec)

mysql&gt; create database stroom_stats;
Query OK, 1 row affected (0.02 sec)

mysql&gt; grant all privileges on stroom_stats.* to 'stroomuser'@'host' identified by 'password';
Query OK, 0 rows affected (0.00 sec)

mysql&gt; flush privileges;
Query OK, 0 rows affected (0.00 sec)
</code></pre>
<h2 id="advanced-security">Advanced Security</h2>
<p>It is recommended to run /usr/bin/mysql_secure_installation to remove test database and accounts.</p>
<p>./stroom-setup/mysql_grant.sh is a utility script that creates accounts for you to use within a
cluster (or single node setup).  Run to see the options:</p>
<pre><code class="language-bash">[stroomuser@host stroom-setup]$ ./mysql_grant.sh
usage : --name=&lt;instance name (defaults to my for /etc/my.cnf)&gt;
        --user=&lt;the stroom user for the db&gt;
        --password=&lt;the stroom password for the db&gt;
        --cluster=&lt;the file with a line per node in the cluster&gt;
--user=&lt;db user&gt; Must be set
</code></pre>
<p>N.B. name is used when multiple mysql instances are setup (see below).</p>
<p>You need to create a file cluster.txt with a line for each member of your cluster
(or single line in the case of a one node Stroom install).
Then run the utility script to lock down the server access.</p>
<pre><code class="language-bash">[stroomuser@host ~]$ hostname &gt;&gt; cluster.txt
[stroomuser@host ~]$ ./stroom-setup/mysql_grant.sh --name=mysql56_dev --user=stroomuser --password= --cluster=cluster.txt
Enter root mysql password :
--------------
flush privileges
--------------

--------------
delete from mysql.user where user = 'stroomuser'
--------------
...
...
...
--------------
flush privileges
--------------

[stroomuser@host ~]$
</code></pre>
<h2 id="advanced-install">Advanced Install</h2>
<p>The below example uses the utility scripts to create 3 custom mysql server instances on 2 servers:</p>
<ul>
<li>server1 - master stroom,</li>
<li>server2 - slave stroom, stroom_stats</li>
</ul>
<p>As root on server1:</p>
<pre><code class="language-bash">yum install &quot;mysql56-mysql-server&quot;
</code></pre>
<p>Create the master database:</p>
<pre><code class="language-bash">[root@node1 stroomuser]# ./stroom-setup/mysqld_instance.sh --name=mysqld56_stroom --port=3106 --server=mysqld56 --os=rhel6

--master not set ... assuming master database
Wrote base files in tmp (You need to move them as root).  cp /tmp/mysqld56_stroom /etc/init.d/mysqld56_stroom; cp /tmp/mysqld56_stroom.cnf /etc/mysqld56_stroom.cnf
Run mysql client with mysql --defaults-file=/etc/mysqld56_stroom.cnf

[root@node1 stroomuser]# cp /tmp/mysqld56_stroom /etc/init.d/mysqld56_stroom; cp /tmp/mysqld56_stroom.cnf /etc/mysqld56_stroom.cnf
[root@node1 stroomuser]# /etc/init.d/mysqld56_stroom start

Initializing MySQL database:  Installing MySQL system tables...
OK
Filling help tables...
...
...
Starting mysql56-mysqld:                                   [  OK  ]
</code></pre>
<p>Check Start up Settings Correct</p>
<pre><code class="language-bash">[root@node2 stroomuser]# chkconfig mysqld off
[root@node2 stroomuser]# chkconfig mysql56-mysqld off
[root@node1 stroomuser]# chkconfig --add mysqld56_stroom
[root@node1 stroomuser]# chkconfig mysqld56_stroom on

[root@node2 stroomuser]# chkconfig --list | grep mysql
mysql56-mysqld  0:off   1:off   2:off   3:off   4:off   5:off   6:off
mysqld          0:off   1:off   2:off   3:off   4:off   5:off   6:off
mysqld56_stroom    0:off   1:off   2:on    3:on    4:on    5:on    6:off
mysqld56_stats  0:off   1:off   2:on    3:on    4:on    5:on    6:off
</code></pre>
<p>Create a text file will all members of the cluster:</p>
<pre><code class="language-bash">[root@node1 stroomuser]# vi cluster.txt

node1.my.org
node2.my.org
node3.my.org
node4.my.org 
</code></pre>
<p>Create the grants:</p>
<pre><code class="language-bash">[root@node1 stroomuser]# ./stroom-setup/mysql_grant.sh --name=mysqld56_stroom --user=stroomuser --password=password --cluster=cluster.txt
</code></pre>
<p>As root on server2:</p>
<pre><code class="language-bash">[root@node2 stroomuser]# yum install &quot;mysql56-mysql-server&quot;


[root@node2 stroomuser]# ./stroom-setup/mysqld_instance.sh --name=mysqld56_stroom --port=3106 --server=mysqld56 --os=rhel6 --master=node1.my.org --user=stroomuser --password=password

--master set ... assuming slave database
Wrote base files in tmp (You need to move them as root).  cp /tmp/mysqld56_stroom /etc/init.d/mysqld56_stroom; cp /tmp/mysqld56_stroom.cnf /etc/mysqld56_stroom.cnf
Run mysql client with mysql --defaults-file=/etc/mysqld56_stroom.cnf

[root@node2 stroomuser]# cp /tmp/mysqld56_stroom /etc/init.d/mysqld56_stroom; cp /tmp/mysqld56_stroom.cnf /etc/mysqld56_stroom.cnf
[root@node1 stroomuser]# /etc/init.d/mysqld56_stroom start

Initializing MySQL database:  Installing MySQL system tables...
OK
Filling help tables...
...
...
Starting mysql56-mysqld:                                   [  OK  ]
</code></pre>
<p>Check Start up Settings Correct</p>
<pre><code class="language-bash">[root@node2 stroomuser]# chkconfig mysqld off
[root@node2 stroomuser]# chkconfig mysql56-mysqld off
[root@node1 stroomuser]# chkconfig --add mysqld56_stroom
[root@node1 stroomuser]# chkconfig mysqld56_stroom on

[root@node2 stroomuser]# chkconfig --list | grep mysql
mysql56-mysqld  0:off   1:off   2:off   3:off   4:off   5:off   6:off
mysqld          0:off   1:off   2:off   3:off   4:off   5:off   6:off
mysqld56_stroom    0:off   1:off   2:on    3:on    4:on    5:on    6:off
</code></pre>
<p>Create the grants:</p>
<pre><code class="language-bash">[root@node1 stroomuser]# ./stroom-setup/mysql_grant.sh --name=mysqld56_stroom --user=stroomuser --password=password --cluster=cluster.txt
</code></pre>
<p>Make the slave database start to follow:</p>
<pre><code class="language-bash">[root@node2 stroomuser]# cat /etc/mysqld56_stroom.cnf | grep &quot;change master&quot;
# change master to MASTER_HOST='node1.my.org', MASTER_PORT=3106, MASTER_USER='stroomuser', MASTER_PASSWORD='password';

[root@node2 stroomuser]# mysql --defaults-file=/etc/mysqld56_stroom.cnf

mysql&gt; change master to MASTER_HOST='node1.my.org', MASTER_PORT=3106, MASTER_USER='stroomuser', MASTER_PASSWORD='password';
mysql&gt; start slave; 
</code></pre>
<p>As processing user on server1:</p>
<pre><code class="language-bash">[stroomuser@node1 ~]$ mysql --defaults-file=/etc/mysqld56_stroom.cnf --user=stroomuser --password=password

mysql&gt; create database stroom;
Query OK, 1 row affected (0.00 sec)

mysql&gt; use stroom;
Database changed

mysql&gt; create table test (a int);
Query OK, 0 rows affected (0.05 sec)
</code></pre>
<p>As processing user on server2 check server replicating OK:</p>
<pre><code class="language-bash">[stroomuser@node2 ~]$ mysql --defaults-file=/etc/mysqld56_stroom.cnf --user=stroomuser --password=password

mysql&gt; show create table test;
+-------+----------------------------------------------------------------------------------------+
| Table | Create Table                                                                           |
+-------+----------------------------------------------------------------------------------------+
| test  | CREATE TABLE `test` (`a` int(11) DEFAULT NULL  ) ENGINE=InnoDB DEFAULT CHARSET=latin1  |
+-------+----------------------------------------------------------------------------------------+
1 row in set (0.00 sec)
</code></pre>
<p>As root on server2:</p>
<pre><code class="language-bash">[root@node2 stroomuser]# /home/stroomuser/stroom-setup/mysqld_instance.sh --name=mysqld56_stats --port=3206 --server=mysqld56 --os=rhel6 --user=statsuser --password=password
[root@node2 stroomuser]# cp /tmp/mysqld56_stats /etc/init.d/mysqld56_stats; cp /tmp/mysqld56_stats.cnf /etc/mysqld56_stats.cnf
[root@node2 stroomuser]# /etc/init.d/mysqld56_stats start
[root@node2 stroomuser]# chkconfig mysqld56_stats on
</code></pre>
<p>Create the grants:</p>
<pre><code class="language-bash">[root@node2 stroomuser]# ./stroom-setup/mysql_grant.sh --name=mysqld56_stats --database=stats  --user=stroomstats --password=password --cluster=cluster.txt
</code></pre>
<p>As processing user create the database:</p>
<pre><code class="language-bash">[stroomuser@node2 ~]$ mysql --defaults-file=/etc/mysqld56_stats.cnf --user=stroomstats --password=password
Welcome to the MySQL monitor.  Commands end with ; or \g.
....
mysql&gt; create database stats;
Query OK, 1 row affected (0.00 sec)
</code></pre>

</div>




    
	
  
    
    
	
    



<div class="td-content" style="--base-section-num: '1.4.'; page-break-before: always">
    
  <h1 id="pg-83516d1c6898776469e61e1639643937">1.4 - Processing Users</h1>
    
	<h2 id="processing-user-setup">Processing User Setup</h2>
<p>Stroom / Stroom Proxy should be run under a processing user (we assume stroomuser below).</p>
<ul>
<li>Setup this user</li>
</ul>
<pre><code class="language-bash">/usr/sbin/adduser --system stroomuser
</code></pre>
<ul>
<li>
<p>You may want to allow normal accounts to sudo to this account for maintenance (visudo)</p>
</li>
<li>
<p>Create a service script to start/stop on server startup (as root).</p>
</li>
</ul>
<pre><code class="language-bash">vi /etc/init.d/stroomuser

#!/bin/bash
#
# stroomuser       This shell script takes care of starting and stopping
#               the stroomuser subsystem (tomcat6, etc)
#
# chkconfig: - 86 14
# description: stroomuser is the stroomuser sub system

Stroom_USER=stroomuser

case $1 in
start)
/bin/su ${Stroom_USER} /home/${Stroom_USER}/stroom-deploy/start.sh
;;
stop)
/bin/su ${Stroom_USER} /home/${Stroom_USER}/stroom-deploy/stop.sh
;;
restart)
/bin/su ${Stroom_USER} /home/${Stroom_USER}/stroom-deploy/stop.sh
/bin/su ${Stroom_USER} /home/${Stroom_USER}/stroom-deploy/start.sh
;;
esac
exit 0
</code></pre>
<ul>
<li>Initialise Script</li>
</ul>
<pre><code class="language-bash">/bin/chmod +x /etc/init.d/stroomuser
/sbin/chkconfig --level 345 stroomuser on
</code></pre>
<h2 id="install-java-8">Install Java 8</h2>
<pre><code class="language-bash">yum install java-1.8.0-openjdk.x86_64
yum install java-1.8.0-openjdk-devel.x86_64
</code></pre>
<h2 id="setup-deployment-scripts">Setup Deployment Scripts</h2>
<ul>
<li>As the processing user unpack the stroom-deploy-X-Y-Z-bin.zip generic deployment
scripts in the processing users home directory.</li>
</ul>
<pre><code class="language-bash">unzip stroom-deploy-5.0.beta1-bin.zip
</code></pre>
<ul>
<li>Setup env.sh to include JAVA_HOME to point to the installed directory of the JDK
(this will be platform specific).  vi ~/env.sh</li>
</ul>
<pre><code class="language-bash"># User specific aliases and functions
export JAVA_HOME=/usr/lib/jvm/java-1.8.0
export PATH=${JAVA_HOME}/bin:${PATH}
</code></pre>
<ul>
<li>Setup users profile to include the same.  vi ~/.bashrc</li>
</ul>
<pre><code class="language-bash"># User specific aliases and functions
. ~/env.sh
</code></pre>
<ul>
<li>Check that java is installed OK</li>
</ul>
<pre><code class="language-bash">[stroomuser@node1 ~]$ . .bashrc
[stroomuser@node1 ~]$ which java
/usr/lib/jvm/java-1.8.0/bin/java

[stroomuser@node1 ~]$ which javac
/usr/lib/jvm/java-1.8.0/bin/javac

[stroomuser@node1 ~]$ java -version
openjdk version &quot;1.8.0_65&quot;
OpenJDK Runtime Environment (build 1.8.0_65-b17)
OpenJDK 64-Bit Server VM (build 25.65-b01, mixed mode)
</code></pre>
<ul>
<li>Setup auto deployment crontab script as below (crontab -e)</li>
</ul>
<pre><code class="language-bash">[stroomuser@node1 ~]$ crontab -l
# Deploy Script
0,5,10,15,20,25,30,35,40,45,50,55 * * * * /home/stroomuser/stroom-deploy/deploy.sh &gt;&gt; /home/stroomuser/stroom-deploy.log
59 0 * * * rm -f /home/stroomuser/stroom-deploy.log
# Clean system
0 0 * * * /home/stroomuser/stroom-deploy/clean.sh &gt; /dev/null
</code></pre>

</div>




    
	
  
    
    
	
    



<div class="td-content" style="--base-section-num: '1.5.'; page-break-before: always">
    
  <h1 id="pg-1423b5de8658215848877b76e270e0c7">1.5 - Securing Stroom</h1>
    
	<blockquote>
<p><em>NOTE</em> This document was written for stroom v4/5. Some parts may not be applicable for v6+.</p>
</blockquote>
<h2 id="firewall">Firewall</h2>
<p>The following firewall configuration is recommended:</p>
<ul>
<li>Outside cluster drop all access except ports HTTP 80, HTTPS 443, and any other system ports your require SSH, etc</li>
<li>Within cluster allow all access</li>
</ul>
<p>This will enable nodes within the cluster to communicate on:</p>
<ul>
<li>Native tomcat HTTP 8080, 9080</li>
<li>Tomcat AJP 8009, 9009</li>
<li>MySQL 3006</li>
</ul>
<h2 id="mysql">MySQL</h2>
<ul>
<li>It is recommended that you run mysql_secure_installation to set a root password and remove test database:</li>
</ul>
<pre><code class="language-bash">mysql_secure_installation (provide a root password)
- Set root password? [Y/n] Y
- Remove anonymous users? [Y/n] Y 
- Disallow root login remotely? [Y/n] Y
- Remove test database and access to it? [Y/n] Y
- Reload privilege tables now? [Y/n] Y
</code></pre>
<ul>
<li>stroom-setup includes a version of this script designed to be run on instances create using mysqld_instance.sh
(i.e. non standard or multiple instances of mysql)</li>
</ul>
<pre><code class="language-bash">[stroomuser@stroom_1 stroom-setup]$ ./mysql_secure_installation.sh --name=mysqld_ref1m
</code></pre>

</div>




    
	
  

    
	
  
    
    
	
    



<div class="td-content" style="--base-section-num: '2.'; page-break-before: always">
    
  <h1 id="pg-6f66d654efd57ce50e45cd099ee248ff">2 - Stroom 5 Installation</h1>
    
	
<div class="pageinfo pageinfo-danger">
<h4 class="text-danger alert-heading">Warning</h4>
<p>This document was written for stroom v4/5.
It is not applicable for v6+.</p>

</div>


<h2 id="prerequisites">Prerequisites</h2>
<ul>
<li>Install file &lsquo;stroom-app-distribution-X-Y-Z-bin.zip&rsquo;. All the pre-built binaries are <a href="https://github.com/gchq/stroom/releases">available on GitHub (external link)</a></li>
<li>MySQL Server 5.5</li>
<li>JDK8</li>
<li>Temporarily allow port 8080, if not relying on Apache Forwarding.</li>
</ul>
<h2 id="installing-stroom">Installing Stroom</h2>
<p>Unpack the distribution <code>stroom-app-distribution-X-Y-Z-bin.zip</code>:</p>
<pre><code class="language-bash">unzip stroom-app-distribution-X-Y-Z-bin.zip
</code></pre>
<p>In <code>bin</code> are scripts for configuring and starting and stopping Stroom.</p>
<h3 id="configuring">Configuring</h3>
<p>The <code>setup.sh</code> script will ask a series of questions to help you configure Stroom.</p>
<pre><code class="language-bash">./bin/setup.sh
</code></pre>
<p>This script asks a series of questions about configuration parameters. These parameters are:</p>
<ul>
<li><strong>TEMP_DIR</strong> - This is where Stroom will write some temporary files, e.g. imports/exports. Only change this if you do not want to use &lsquo;/tmp&rsquo;.</li>
<li><strong>NODE</strong> - Each Stroom instance in the cluster needs a unique name, if this is a reinstall ensure you use the previous deployment.
<strong>This name needs match the name used in your worker.properties (e.g. &rsquo;node1&rsquo; in the case &rsquo;node1.my.org&rsquo;)</strong></li>
<li><strong>RACK</strong> - Used to group nodes together (so for example nodes near each other process near data)</li>
<li><strong>PORT_PREFIX</strong> - By default Stroom will run on port 8080</li>
<li><strong>JDBC_CLASSNAME</strong>, <strong>JDBC URL</strong>, <strong>DB USERNAME</strong>, <strong>DB PASSWORD</strong> - MySQL connection details for the <strong>stroom</strong> database</li>
<li><strong>JPA DIALECT</strong> - Leave blank to use MySQL</li>
<li><strong>JAVA OPTS</strong> - By default this is &lsquo;-Xms1g -Xmx8g&rsquo;. Stroom performs better if you use most of the servers memory so change the maximum memory setting (Xmx) accordingly, e.g. -Xmx40g will use 40 GB.</li>
<li><strong>STROOM_STATISTICS_SQL_JDBC_CLASSNAME</strong>, <strong>STROOM_STATISTICS_SQL_JDBC URL</strong>, <strong>STROOM_STATISTICS_SQL_DB USERNAME</strong>, <strong>STROOM_STATISTICS_SQL_DB PASSWORD</strong> - MySQL connection details for the <strong>statistics</strong> database</li>
</ul>
<h3 id="running">Running</h3>
<p>Start the configured instance:</p>
<pre><code class="language-bash">./bin/start.sh
</code></pre>
<p>Inspect the logs:</p>
<pre><code class="language-bash">tail -f instance/logs/stroom.log
</code></pre>
<h3 id="other-things-to-configure">Other things to configure:</h3>
<p>You might want to configure some of the following:</p>
<ul>
<li><a href="../../../docs/install-guide/setup/processing-user-setup/">Processing User Setup</a></li>
<li><a href="../../../docs/install-guide/setup/mysql-server-setup/">MySQL Server Setup</a></li>
<li><a href="../../../docs/install-guide/setup/java-key-store-setup/">Java Key Store Setup</a></li>
<li><a href="../../../docs/install-guide/setup/apache-forwarding/">Apache Forwarding</a></li>
<li><a href="../../../docs/install-guide/setup/securing-stroom/">Securing Stroom</a></li>
</ul>

</div>




    
	
  
    
    
	
    



<div class="td-content" style="--base-section-num: '3.'; page-break-before: always">
    
  <h1 id="pg-c799e218c5cb8bef7fb1cf2660a8064c">3 - Stroom 6 Architecture &amp; Depployment</h1>
    
	<p>The diagram below shows the logical architecture of Stroom v6.
It is not concerned with how/where the various services are deployed.
This page describes represents a reference architecture and deployment for stroom but it is possible to deploy the various services in many different ways, e.g. using a different web server to Nginx or introducing load balancers.</p>







  
  
  
  
  







  



<div class="card rounded shadow-stroom p-2 td-post-card mb-4 mt-4" style="width: fit-content;">

  <a title="images/install-guide/stroom-6-architecture.puml.svg" href="../../../images/install-guide/stroom-6-architecture.puml.svg">
    <figure style="margin-block-end: 0px" >
      
      <img class="card-img-top" src="../../../images/install-guide/stroom-6-architecture.puml.svg" style="max-width: fit-content" alt="images/install-guide/stroom-6-architecture.puml.svg">
      

      
      <div class="card-body px-0 pt-2 pb-0">
        <hr style="border-top: 1px solid #ddd; margin-top: 0px; margin-bottom:4px;">
        <figcaption class="card-text" style="font-size: smaller; text-align: center;">Logical Architecture Diagram</figcaption>
      </div>
      
    </figure>
  </a>
</div>

<h2 id="nginx">Nginx</h2>
<p>In stroom v6, a central Nginx is key to the whole architecture.
It acts in the following capacities:</p>
<ul>
<li>A reverse proxy to abstract clients from the multiple service instances.</li>
<li>An API gateway for all service traffic.</li>
<li>The termination point for client SSL traffic.</li>
</ul>
<h3 id="reverse-proxy">Reverse Proxy</h3>
<p>Nginx is used to reverse proxy all client connections (even those from within the estate) to the various services that sit behind it.
For example, a client request to <code>https://nginx-host/stroom</code> will be reverse proxied to <code>http://a-stroom-host:8080/stroom</code>.
Nginx is responsible for selecting the upstream server to reverse proxy to.
It is possible to use multiple instances of Nginx for redundancy or improved performance, however care needs to be taken to ensure all requests for a session go to the same Nginx instance, i.e. sticky sessions.
Some requests are stateful and some are stateless but the Nginx config will reverse proxy them accordingly.</p>
<h3 id="api-gateway">API Gateway</h3>
<p>Nginx is also used as an API gateway.
This means all inter-service calls go via the Nginx gateway so each service only needs to know the location of the Nginx gateway.
Nginx will then reverse proxy all requests to the appropriate instance of an upstream service.</p>
<p>The grey dashed lines on the diagram attempt to show the effective inter-service connections that are being made if you ignore the Nginx reverse proxying.</p>
<h3 id="ssl-termination">SSL Termination</h3>
<p>All SSL termination is handled by Nginx.
Nginx holds the server and certificate authority certificate and will authenticate the client requests if the client has a certificate.
Any client certificate details will be passed on to the service that is being reverse proxied.</p>
<h2 id="physical-deployment">Physical Deployment</h2>
<h3 id="single-node-docker-deployment">Single Node Docker Deployment</h3>
<p>The simplest deployment of stroom is where all services are on a single host and each service runs in its own docker container.
Such a deployment can be achieved by following <a href="../../../community/dev-guide/docker-running/">these instructions</a>.</p>
<p>The following diagram shows how a single node deployment would look.</p>







  
  
  
  
  







  



<div class="card rounded shadow-stroom p-2 td-post-card mb-4 mt-4" style="width: fit-content;">

  <a title="images/install-guide/stroom-6-deployment-docker-single.puml.svg" href="../../../images/install-guide/stroom-6-deployment-docker-single.puml.svg">
    <figure style="margin-block-end: 0px" >
      
      <img class="card-img-top" src="../../../images/install-guide/stroom-6-deployment-docker-single.puml.svg" style="max-width: fit-content" alt="images/install-guide/stroom-6-deployment-docker-single.puml.svg">
      

      
      <div class="card-body px-0 pt-2 pb-0">
        <hr style="border-top: 1px solid #ddd; margin-top: 0px; margin-bottom:4px;">
        <figcaption class="card-text" style="font-size: smaller; text-align: center;">Logical Architecture Diagram</figcaption>
      </div>
      
    </figure>
  </a>
</div>

<h3 id="multi-node-mixed-deployment">Multi Node Mixed Deployment</h3>
<p>The typical deployment for a large scale stroom is where stroom is run on multiple hosts to scale out the processing.
In this deployment stroom and MySQL are run directly on the host OS, i.e. without docker.
This approach was taken to gradually introduce docker into the stroom deployment strategies.</p>
<p>The following diagram shows how a multi node deployment would look.</p>







  
  
  
  
  







  



<div class="card rounded shadow-stroom p-2 td-post-card mb-4 mt-4" style="width: fit-content;">

  <a title="images/install-guide/stroom-6-deployment-mixed-multi.puml.svg" href="../../../images/install-guide/stroom-6-deployment-mixed-multi.puml.svg">
    <figure style="margin-block-end: 0px" >
      
      <img class="card-img-top" src="../../../images/install-guide/stroom-6-deployment-mixed-multi.puml.svg" style="max-width: fit-content" alt="images/install-guide/stroom-6-deployment-mixed-multi.puml.svg">
      

      
      <div class="card-body px-0 pt-2 pb-0">
        <hr style="border-top: 1px solid #ddd; margin-top: 0px; margin-bottom:4px;">
        <figcaption class="card-text" style="font-size: smaller; text-align: center;">Logical Architecture Diagram</figcaption>
      </div>
      
    </figure>
  </a>
</div>

<h3 id="multi-node-all-docker-deployment">Multi Node All docker Deployment</h3>
<p>The aim in future is to run all services in docker in a multi node deployment.
Such a deployment is still under development and will likely involve kubernetes for container orchestration.</p>

</div>




    
	
  
    
    
	
    



<div class="td-content" style="--base-section-num: '4.'; page-break-before: always">
    
  <h1 id="pg-b8704340a0ac9246d13f2c84c3c850b0">4 - Stroom 6 Installation</h1>
    
	<p>We would welcome feedback on this documentation.</p>
<h2 id="running-on-a-single-box">Running on a single box</h2>
<h3 id="running-a-release">Running a release</h3>
<p>Download a <a href="https://github.com/gchq/stroom-resources/releases">release (external link)</a>, for example <a href="https://github.com/gchq/stroom-resources/releases/download/stroom_core-v6.0-beta.3/stroom_core_v6.0-beta.3.tar.gz">Stroom Core v6.0 Beta 3 (external link)</a>, unpack it, and run the <code>start.sh</code> script. When you&rsquo;ve given it some time to start up go to <code>http://localhost/stroom</code>. There&rsquo;s a <code>README.md</code> file inside the tar.gz with more information.</p>
<h2 id="post-install-hardening">Post-install hardening</h2>
<h3 id="before-first-run">Before first run</h3>
<h4 id="change-database-passwords">Change database passwords</h4>
<p>If you don&rsquo;t do this before the first run of Stroom then the passwords will already be set and you&rsquo;ll have to change them on the database manually, and then change the <code>.env</code>.</p>
<p>This change should be made in the <code>.env</code> configuration file. If the values are not there then this service is not included in your Stroom stack and there is nothing to change.</p>
<ul>
<li>
<p><code>STROOM_DB_PASSWORD</code></p>
</li>
<li>
<p><code>STROOM_DB_ROOT_PASSWORD</code></p>
</li>
<li>
<p><code>STROOM_STATS_DB_ROOT_PASSWORD</code></p>
</li>
<li>
<p><code>STROOM_STATS_DB_PASSWORD</code></p>
</li>
<li>
<p><code>STROOM_AUTH_DB_PASSWORD</code></p>
</li>
<li>
<p><code>STROOM_AUTH_DB_ROOT_PASSWORD</code></p>
</li>
<li>
<p><code>STROOM_ANNOTATIONS_DB_PASSWORD</code></p>
</li>
<li>
<p><code>STROOM_ANNOTATIONS_DB_ROOT_PASSWORD</code></p>
</li>
</ul>
<h3 id="on-first-run">On first run</h3>
<h4 id="create-yourself-an-account">Create yourself an account</h4>
<p>After first logging in as <code>admin</code> you should create yourself a normal account (using your email address) and add yourself to the <code>Administrators</code> group. You should then log out of <code>admin</code>, log in with your new administrator account and then disable the <code>admin</code> account.</p>
<p>If you decide to use the <code>admin</code> account as your normal account you might find yourself locked out. The <code>admin</code> account has no associated email address, so the Reset Password feature will not work if your account is locked. It might become locked if you enter your password incorrectly too many times.</p>
<h4 id="delete-un-used-users-and-api-keys">Delete un-used users and API keys</h4>
<ul>
<li>If you&rsquo;re not using stats you can delete or disable the following:
<ul>
<li>the user <code>statsServiceUser</code></li>
<li>the API key for <code>statsServiceUser</code></li>
</ul>
</li>
</ul>
<h4 id="change-the-api-keys">Change the API keys</h4>
<p>First generate new API keys. You can generate a new API key using Stroom, under <code>Tools</code> -&gt; <code>API Keys</code>. The following need to be changed:</p>
<ul>
<li>
<p><code>STROOM_SECURITY_API_TOKEN</code></p>
<ul>
<li>This is the API token for user <code>stroomServiceUser</code>.</li>
</ul>
</li>
</ul>
<p>Then stop Stroom and update the API key in the <code>.env</code> configuration file with the new value.</p>
<h2 id="troubleshooting">Troubleshooting</h2>
<h3 id="im-trying-to-use-certificate-logins-pki-but-i-keep-being-prompted-for-the-username-and-password">I&rsquo;m trying to use certificate logins (PKI) but I keep being prompted for the username and password!</h3>
<p>You need to be sure of several things:</p>
<ul>
<li>When a user arrives at Stroom the first thing Stroom does is redirect the user to the authentication service. This is when the certificate is checked. If this redirect doesn&rsquo;t use HTTPS then nginx will not get the cert and will not send it onwards to the authentication service. Remember that all of this stuff, apart from back-channel/service-to-service chatter, goes through nginx. The env var that needs to use HTTPS is STROOM_AUTHENTICATION_SERVICE_URL. Note that this is the var Stroom looks for, not the var as set in the stack, so you&rsquo;ll find it in the stack YAML.</li>
<li>Are your certs configured properly? If nginx isn&rsquo;t able to decode the incoming cert for some reason then it won&rsquo;t pass anything on to the service.</li>
<li>Is your browser sending certificates?</li>
</ul>

</div>




    
	
  
    
    
	
    



<div class="td-content" style="--base-section-num: '5.'; page-break-before: always">
    
  <h1 id="pg-da2ad51ba4d61c7122800e900e397c63">5 - Stroom Proxy Installation</h1>
    
	<p>There are 2 versions of the stroom software availble for building a proxy server.<br>
There is an &lsquo;app&rsquo; version that runs stroom as a Java ARchive (jar) file locally on the server and has settings contained in a configuration file that controls access to the stroom server and database.<br>
The other version runs stroom proxy within docker containers and also has a settings configuration file that controls access to the stroom server and database.<br>
The document will cover the installation and configuration of the stroom proxy software for both the docker and &lsquo;app&rsquo; versions.<br>
 </p>
<h2 id="assumptions">Assumptions</h2>
<p>The following assumptions are used in this document.</p>
<ul>
<li>the user has reasonable RHEL/CentOS System administration skills.</li>
<li>installation is on a fully patched minimal CentOS 7 instance.</li>
<li>the Stroom database has been created and resides on the host <code>stroomdb0.strmdev00.org</code> listening on port 3307.</li>
<li>the Stroom database user is <code>stroomuser</code> with a password of <code>Stroompassword1@</code>.</li>
<li>the application user <code>stroomuser</code> has been created.</li>
<li>the user is or has deployed the two node Stroom cluster described <a href="../../../docs/howtos/install/installhowto/#storage-scenario">here</a>.</li>
<li>the user has set up the Stroom processing user as described <a href="../../../docs/howtos/install/installprocessingusersetuphowto/">here</a>.</li>
<li>the prerequisite software has been installed.</li>
<li>when a screen capture is documented, data entry is identified by the data surrounded by &lsquo;&lt;<strong>&rsquo; &lsquo;</strong>&gt;&rsquo; . This excludes enter/return presses.</li>
</ul>
<p> </p>
<p> </p>
<h2 id="stroom-remote-proxy-docker-version">Stroom Remote Proxy (docker version)</h2>
<p>The build of a stroom proxy where the stroom applications are running in docker containers.<br>
The operating system (OS) build for a &lsquo;dockerised&rsquo; stroom proxy is minimal RHEL/CentOS 7 plus the docker-ce &amp; docker-compose packages.<br>
Neither of the pre-requisites are available from the CentOS ditribution.<br>
It will also be necessary to open additional ports on the system firewall (where appropriate).<br>
 </p>
<h3 id="download-and-install-docker">Download and install docker</h3>
<p>To download and install - docker-ce - from the internet, a new &lsquo;repo&rsquo; file is downloaded first, that provides access to the docker.com repository.
e.g. as <em>root</em> user:
 </p>
<ul>
<li>wget <a href="https://download.docker.com/linux/centos/docker-ce.repo">https://download.docker.com/linux/centos/docker-ce.repo</a> -O /etc/yum.repos.d/docker-ce.repo</li>
<li>yum install docker-ce.x86_64</li>
</ul>
<p>The packages - docker-ce docker-ce-cli &amp; containerd.io - will be installed</p>
<p> </p>
<p>The docker-compose software can de downloaded from github
e.g. as <em>root</em> user to download docker-compose version 1.25.4 and save it to -  /usr/local/bin/docker-compose</p>
<ul>
<li>curl -L <a href="https://github.com/docker/compose/releases/download/1.25.4/docker-compose-Linux-x86_64">https://github.com/docker/compose/releases/download/1.25.4/docker-compose-Linux-x86_64</a> -o /usr/local/bin/docker-compose</li>
<li>chmod 755 /usr/local/bin/docker-compose</li>
</ul>
<p> </p>
<h3 id="firewall-configuration">Firewall Configuration</h3>
<p>If you have a firewall running additional ports will need to be opened, to allow the Docker containers to talk to each other.<br>
Currently these ports are:</p>
<ul>
<li>3307</li>
<li>8080</li>
<li>8081</li>
<li>8090</li>
<li>8091</li>
<li>8543</li>
<li>5000</li>
<li>2888</li>
<li>443</li>
<li>80</li>
</ul>
<p>For example on a RHEL/CentOS server using <code>firewalld</code> the commands would be as <em>root</em> user:</p>
<pre><code class="language-bash">firewall-cmd --zone=public --permanent --add-port=3307/tcp  
firewall-cmd --zone=public --permanent --add-port=8080/tcp  
firewall-cmd --zone=public --permanent --add-port=8081/tcp  
firewall-cmd --zone=public --permanent --add-port=8090/tcp  
firewall-cmd --zone=public --permanent --add-port=8091/tcp  
firewall-cmd --zone=public --permanent --add-port=8099/tcp  
firewall-cmd --zone=public --permanent --add-port=5000/tcp  
firewall-cmd --zone=public --permanent --add-port=2888/tcp  
firewall-cmd --zone=public --permanent --add-port=443/tcp  
firewall-cmd --zone=public --permanent --add-port=80/tcp  
firewall-cmd --reload  
</code></pre>
<p> <br>
 </p>
<h3 id="download-and-install-stroom-v7-docker-version">Download and install Stroom v7 (docker version)</h3>
<p>The installation example below is for stroom version 7.0.beta.45 - but is applicable to other stroom v7 versions.<br>
As a suitable stroom user e.g. stroomuser - download and unpack the stroom software.</p>
<ul>
<li>wget <a href="https://github.com/gchq/stroom-resources/releases/download/stroom-stacks-v7.0-beta.41/stroom_proxy-v7.0-beta.45.tar.gz">https://github.com/gchq/stroom-resources/releases/download/stroom-stacks-v7.0-beta.41/stroom_proxy-v7.0-beta.45.tar.gz</a></li>
<li>tar zxf stroom-stacks…………..</li>
</ul>
<p> </p>
<p>For a stroom proxy, the configuration file - stroom_proxy/stroom_proxy-v7.0-beta.45/stroom_proxy.env<br>
needs to be edited, with the connection details of the stroom server that data files will be sent to.<br>
The default network port for connection to the stroom server is 8080
The values that need to be set are:<br>
STROOM_PROXY_REMOTE_FEED_STATUS_API_KEY<br>
STROOM_PROXY_REMOTE_FEED_STATUS_URL<br>
STROOM_PROXY_REMOTE_FORWARD_URL</p>
<p>The &lsquo;API key&rsquo; is generated on the stroom server and is related to a specific user e.g. proxyServiceUser
The 2 URL values also refer to the stroom server and can be a fully qualified domain name (fqdn) or the IP Address.<br>
 </p>
<p>e.g. if the stroom server was - stroom-serve.somewhere.co.uk - the URL lines would be:<br>
export STROOM_PROXY_REMOTE_FEED_STATUS_URL=&ldquo;<a href="http://stroom-serve.somewhere.co.uk:8080/api/feedStatus/v1%22">http://stroom-serve.somewhere.co.uk:8080/api/feedStatus/v1&quot;</a><br>
export STROOM_PROXY_REMOTE_FORWARD_URL=&ldquo;<a href="http://stroom-serve.somewhere.co.uk:8080/stroom/datafeed%22">http://stroom-serve.somewhere.co.uk:8080/stroom/datafeed&quot;</a></p>
<p> </p>
<h3 id="to-start-stroom-proxy">To Start Stroom Proxy</h3>
<p>As the stroom user, run the &lsquo;start.sh&rsquo; script found in the stroom install:</p>
<ul>
<li>cd ~/stroom_proxy/stroom_proxy-v7.0-beta.45/</li>
<li>./start.sh</li>
</ul>
<p>The first time the script is ran it will download from github the docker containers for a stroom proxy<br>
these are - stroom-proxy-remote, stroom-log-sender and nginx.<br>
Once the script has completed the stroom proxy server should be running.
There are additional scripts - status.sh - that will show the status of the docker containers (stroom-proxy-remote, stroom-log-sender and nginx)
and - logs.sh - that will tail all of the stroom message files to the screen.</p>
<p> </p>
<p> </p>
<h2 id="stroom-remote-proxy-app-version">Stroom Remote Proxy (app version)</h2>
<p>The build of a stroom proxy server, where the stroom application is running locally as a Java ARchive (jar) file.<br>
The operating system (OS) build for an &lsquo;application&rsquo; stroom proxy is minimal RHEL/CentOS 7 plus Java.<br>
 </p>
<p>The Java version required for stroom v7 is 12+ This version of Java is not available from the RHEL/CentOS distribution.<br>
The version of Java used below is the &lsquo;openJDK&rsquo; version as opposed to Oracle&rsquo;s version.<br>
This can be downloaded from the internet.</p>
<p>Version 12.0.1<br>
wget <a href="https://download.java.net/java/GA/jdk12.0.1/69cfe15208a647278a19ef0990eea691/12/GPL/openjdk-12.0.1_lin">https://download.java.net/java/GA/jdk12.0.1/69cfe15208a647278a19ef0990eea691/12/GPL/openjdk-12.0.1_lin</a>
ux-x64_bin.tar.gz
<em>Or version 14.0.2 <a href="https://download.java.net/java/GA/jdk14.0.2/205943a0976c4ed48cb16f1043c5c647/12/GPL/openjdk-14.0.2_linux-x64_bin.tar.gz">https://download.java.net/java/GA/jdk14.0.2/205943a0976c4ed48cb16f1043c5c647/12/GPL/openjdk-14.0.2_linux-x64_bin.tar.gz</a></em>
 </p>
<p>The gzipped tar file needs to be untarred and moved to a suitable location.</p>
<ul>
<li>tar xvf openjdk-12.0.1_linux-x64_bin.tar.gz</li>
<li>mv jdk-12.0.1 /opt/<br>
 </li>
</ul>
<p>Create a shell script that will define the Java variables	OR add the statements to .bash_profile
e.g. vi /etc/profile.d/jdk12.sh<br>
export JAVA_HOME=/opt/jdk-12.0.1<br>
export PATH=$PATH:$JAVA_HOME/bin</p>
<ul>
<li>
<p>source /etc/profile.d/jdk12.sh</p>
</li>
<li>
<p>echo $JAVA_HOME<br>
/opt/jdk-12.0.1</p>
</li>
<li>
<p>java &ndash;version
<em>openjdk version &ldquo;12.0.1&rdquo; 2019-04-16</em><br>
<em>OpenJDK Runtime Environment (build 12.0.1+12)</em><br>
<em>OpenJDK 64-Bit Server VM (build 12.0.1+12, mixed mode, sharing)</em></p>
</li>
</ul>
<p> </p>
<p>**Disable selinux to avoid issues with access and file permissions. **</p>
<p> </p>
<h3 id="firewall-configuration-1">Firewall Configuration</h3>
<p>If you have a firewall running additional ports will need to be opened, to allow the Docker containers to talk to each other.<br>
Currently these ports are:</p>
<ul>
<li>3307</li>
<li>8080</li>
<li>8081</li>
<li>8090</li>
<li>8091</li>
<li>8543</li>
<li>5000</li>
<li>2888</li>
<li>443</li>
<li>80</li>
</ul>
<p>For example on a RHEL/CentOS server using <code>firewalld</code> the commands would be as <em>root</em> user:</p>
<pre><code class="language-bash">firewall-cmd --zone=public --permanent --add-port=3307/tcp  
firewall-cmd --zone=public --permanent --add-port=8080/tcp  
firewall-cmd --zone=public --permanent --add-port=8081/tcp  
firewall-cmd --zone=public --permanent --add-port=8090/tcp  
firewall-cmd --zone=public --permanent --add-port=8091/tcp  
firewall-cmd --zone=public --permanent --add-port=8099/tcp  
firewall-cmd --zone=public --permanent --add-port=5000/tcp  
firewall-cmd --zone=public --permanent --add-port=2888/tcp  
firewall-cmd --zone=public --permanent --add-port=443/tcp  
firewall-cmd --zone=public --permanent --add-port=80/tcp  
firewall-cmd --reload  
</code></pre>
<p> <br>
 </p>
<h3 id="download-and-install-stroom-v7-app-version">Download and install Stroom v7 (app version)</h3>
<p>The installation example below is for stroom version 7.0.beta.45 - but is applicable to other stroom v7 versions.<br>
As a suitable stroom user e.g. stroomuser - download and unpack the stroom software.</p>
<pre><code class="language-bash">wget https://github.com/gchq/stroom/releases/download/v7.0-beta.45/stroom-proxy-app-v7.0-beta.45.zip
unzip stroom-proxy-app..............
</code></pre>
<p> </p>
<p>The configuration file – <code>stroom-proxy/config/config.yml</code> – is the principal file to be edited, as it contains</p>
<ul>
<li>connection details to the stroom server</li>
<li>the locations of the proxy server log files</li>
<li>the directory on the proxy server, where data files will be stored prior to forwarding onot stroom</li>
<li>the location of the PKI Java keystore (jks) files<br>
 </li>
</ul>
<p>The log file locations are changed to be relative to where stroom is started i.e. <code>~stroomuser/stroom-proxy/logs/…</code>..</p>
<pre><code class="language-text">currentLogFilename: logs/events/event.log		
archivedLogFilenamePattern: logs/events/event-%d{yyyy-MM-dd'T'HH:mm}.log
currentLogFilename: logs/events/event.log
archivedLogFilenamePattern: logs/events/event-%d{yyyy-MM-dd'T'HH:mm}.log
currentLogFilename: logs/send/send.log
archivedLogFilenamePattern: logs/send/send-%d{yyyy-MM-dd'T'HH:mm}.log.gz
currentLogFilename: logs/app/app.log
archivedLogFilenamePattern: logs/app/app-%d{yyyy-MM-dd'T'HH:mm}.log.gz
</code></pre>
<p> </p>
<p>An API key created on the stroom server for a special proxy user is added to the configuration file.
The API key is used to validate access to the application</p>
<pre><code class="language-yaml">proxyConfig:
  useDefaultOpenIdCredentials: **false**
  proxyContentDir: &quot;/stroom-proxy/content&quot;

  #If you want to use a receipt policy then the RuleSet must exist
  #in Stroom and have the UUID as specified below in receiptPolicyUuid
  #proxyRequestConfig:
  #receiptPolicyUuid: &quot;${RECEIPT_POLICY_UUID:-}&quot;
  feedStatus:
    url: **“http://stroomserver.somewhere.co.uk:8080/api/feedStatus/v1}&quot;**
    apiKey: **&quot; eyJhbGciOiJSUz ……………………….ScdPX0qai5UwlBA&quot;**
  forwardStreamConfig:
    forwardingEnabled: true
</code></pre>
<p> </p>
<p>The location of the jks files has to be set, or comment all of the lines that have <strong>sslConfig: &amp; tls:</strong> sections out to not use jks checking.</p>
<p>Stroom also needs the client &amp; ca ‘jks’ files and by default are located in - <strong>/stroom-proxy/certs/ca.jks &amp; client.jks</strong>
Their location can be changed in the <code>config.yml</code></p>
<pre><code class="language-yaml">keyStorePath: &quot;/stroom-proxy/certs/client.jks&quot;  
trustStorePath: &quot;/stroom-proxy/certs/ca.jks&quot;  
keyStorePath: &quot;/stroom-proxy/certs/client.jks&quot;  
trustStorePath: &quot;/stroom-proxy/certs/ca.jks&quot;  
</code></pre>
<p>Could be changed to……………….</p>
<pre><code class="language-yaml">keyStorePath: &quot;/home/stroomuser/stroom-proxy/certs/client.jks&quot;  
trustStorePath: &quot;/home/stroomuser/stroom-proxy/certs/ca.jks&quot;  
keyStorePath: &quot;/home/stroomuser/stroom-proxy/certs/client.jks&quot;  
trustStorePath: &quot;/home/stroomuser/stroom-proxy/certs/ca.jks&quot;
</code></pre>
<p> </p>
<p>Create a directory - <strong>/stroom-proxy</strong> – and ensure that stroom can write to it<br>
This is where the proxy data files are stored - <strong>/stroom-proxy/repo</strong></p>
<pre><code class="language-yaml">proxyRepositoryConfig:
    storingEnabled: true
    repoDir: **&quot;/stroom-proxy/repo&quot;**
    format: &quot;${executionUuid}/${year}-${month}-${day}/${feed}/${pathId}/${id}&quot;
</code></pre>
<p> </p>

</div>




    
	
  
    
    
	
    



<div class="td-content" style="--base-section-num: '6.'; page-break-before: always">
    
  <h1 id="pg-6982f6e621f1d467e7ca809128cdf465">6 - Stroom Upgrades</h1>
    
	<h2 id="stroom-v6">Stroom v6+</h2>
<p>Stroom is designed to detect the version of the database schema present and to run any migrations necessary to bring it up to the version begin deployed.</p>
<h3 id="docker-stack-deployments">Docker stack deployments</h3>
<p><em>TODO</em></p>
<h3 id="non-docker-deployments">Non-docker deployments</h3>
<p><em>TODO</em></p>
<h3 id="major-version-upgrades">Major version upgrades</h3>
<p>The following notes are specific for these major version upgrades</p>
<ul>
<li><a href="../../../docs/install-guide/upgrades/6_to_7_upgrade/">v6 =&gt; v7</a></li>
</ul>
<h2 id="stroom-v5">Stroom v5</h2>
<p>The cleanest way to upgrade or patch is to simply remove the installed content and reinstall.  For example:</p>
<pre><code class="language-bash">./stroom-deploy/stop.sh
rm -fr stroom-app*

&lt;unzip new builds as per install instructions&gt;
&lt;run setup.sh as per install instructions&gt;

./stroom-deploy/start.sh
</code></pre>
<p><strong>It is extremely important</strong> that you enter the configuration parameters correctly.  In particular the node name should match the current node name otherwise Stroom will create a new node in the system thinking it is part of a cluster.  It is recommended that you copy the original parameters file values used in the original installation to help with this (e.g. cp stroom-app/bin/~setup.xml /tmp/orig-stroom-app-setup.xml.</p>
<p>You should remove and reinstall all components you originally installed i.e. stroom-deploy-X-Y-Z, stroom-app-X-Y-X as required.</p>
<p>You should temporary disable the cron auto deploy script if you have it running during the above.</p>
<h3 id="patching">Patching</h3>
<p>You can choose for a minor patch (1-2-X) to simply copy the new WAR file into relevant lib directory and run the deploy.sh script (which you may have running on a cron tab).  However this would not patch any potential script or tomcat setting changes.</p>

</div>




    
	
  
    
    
	
    



<div class="td-content" style="--base-section-num: '7.'; page-break-before: always">
    
  <h1 id="pg-f6ffd8d1b01a0988e33029f1507960c6">7 - Upgrades</h1>
    
	
</div>




    
      
  
  
  
  

  
  

  
    
    
	
    



<div class="td-content" style="--base-section-num: '7.1.'; ">
    
  <h1 id="pg-751a8e0db6ce54a247c6cecee7659fca">7.1 - v6 to v7 Upgrade</h1>
    <div class="lead">This document describes the process for upgrading a Stroom single node docker stack from v6.x to v7.x.</div>
	
<div class="pageinfo pageinfo-danger">
<h4 class="text-danger alert-heading">Warning</h4>
<p>Before comencing an upgrade to v7 you should upgrade Stroom to the latest minor and patch version of v6.</p>

</div>


<h2 id="differences-between-v6-and-v7">Differences between v6 and v7</h2>
<p>Stroom v7 has significant differences to v6 which make the upgrade process a little more complicated.</p>
<ul>
<li>v6 handled authentication using a separate application, <em>stroom-auth-service</em>, with its own database.
In v7 authentication is handled either internally in stroom (the default) or by an external identity provider such as google or AWS Cognito.</li>
<li>v6 used a stroom.conf file or environment variables for configuration.
In v7 stroom uses a config.yml file for its configuration (see <a href="../../../docs/user-guide/properties/">Properties</a>)</li>
<li>v6 used upper case and heavily abbreviated names for its tables.
In v7 clearer and lower case table names are used.
As a result ALL v6 tables get renamed with the prefix <code>OLD_</code>, the new tables created and any content copied over.
As the database will be holding two copies of most data you need to ensure you have space to accomodate it.</li>
</ul>
<h2 id="pre-upgrade-tasks">Pre-Upgrade tasks</h2>
<p>The following steps are required to be performed before migrating from v6 to v7.</p>
<h3 id="download-migration-scripts">Download migration scripts</h3>
<p>Download the migration SQL scripts from <a href="https://github.com/gchq/stroom/blob/STROOM_VERSION/scripts">https://github.com/gchq/stroom/blob/STROOM_VERSION/scripts</a>
e.g. <a href="https://github.com/gchq/stroom/blob/v7.0-beta.133/scripts">https://github.com/gchq/stroom/blob/v7.0-beta.133/scripts</a></p>
<p>These scripts will be used in the steps below.</p>
<h3 id="pre-migration-database-checks">Pre-migration database checks</h3>
<p>Run the pre-migration checks script on the running database.</p>
<pre><code class="language-bash">docker exec -i stroom-all-dbs mysql --table -u&quot;stroomuser&quot; -p&quot;stroompassword1&quot; stroom &lt; v7_db_pre_migration_checks.sql
</code></pre>
<p>This will produce a report of items that will not be migrated or need attention before migration.</p>
<h3 id="stop-processing">Stop processing</h3>
<p>Before shutting stroom down it is wise to turn off stream processing and let all outstanding server tasks complete.</p>
<p><em>TODO</em> clairfy steps for this.</p>
<h3 id="stop-the-stack">Stop the stack</h3>
<p>Stop the stack (stroom and the database) then start up the database.
Do this using the v6 stack.
This ensures that stroom is not trying to access the database.</p>
<pre><code class="language-bash">./stop.sh
./start.sh stroom-all-dbs
</code></pre>
<h3 id="backup-the-databases">Backup the databases</h3>
<p>Backup all the databases for the different components.
Typically these will be <code>stroom</code>, <code>stats</code> and <code>auth</code>.</p>
<p>If you are running in a docker stack then you can run the <code>./backup_databases.sh</code> script.</p>
<h3 id="stop-the-database">Stop the database</h3>
<p>Stop the database using the v6 stack.</p>
<pre><code class="language-bash">./stop.sh
</code></pre>
<h3 id="deploy-and-configure-v7">Deploy and configure v7</h3>
<p>Deploy the v7 stack.
<em>TODO</em> - more detail</p>
<p>Verify the database connection configuration for the stroom and stats databases.
Ensure that there is NOT any configuration for a separate auth database as this will now be in stroom.</p>
<h3 id="running-mysql_upgrade">Running <code>mysql_upgrade</code></h3>
<p>Stroom v6 ran on mysql v5.6.
Stroom v7 runs on mysql v8.
The upgrade path for MySQL is 5.6 =&gt; 5.7.33 =&gt; 8.x</p>
<p>To ensure the database is up to date <code>mysql_upgrade</code> neeeds to be run using the 5.7.33 binaries, <a href="https://dev.mysql.com/doc/refman/8.0/en/mysql-upgrade.html">see (external link)</a>.</p>
<p>This is the process for upgrading the database. All of these commands are using the v7 stack.</p>
<pre><code class="language-bash"># Set the version of the MySQL docker image to use
export MYSQL_TAG=5.7.33

# Start MySQL at v5.7, this will recreate the container
./start.sh stroom-all-dbs

# Run the upgrade from 5.6 =&gt; 5.7.33
docker exec -it stroom-all-dbs mysql_upgrade -u&quot;root&quot; -p&quot;my-secret-pw&quot;

# Stop MySQL
./stop.sh

# Unset the tag variable so that it now uses the default from the stack (8.x)
unset MYSQL_TAG

# Start MySQL at v8.x, this will recreate the container and run the upgrade from 5.7.33=&gt;8
./start.sh stroom-all-dbs

./stop.sh
</code></pre>
<h3 id="rename-legacy-stroom-auth-tables">Rename legacy stroom-auth tables</h3>
<p>Run this command to connect to the <code>auth</code> database and run the pre-migration SQL script.</p>
<pre><code class="language-bash">docker exec -i stroom-all-dbs mysql --table -u&quot;authuser&quot; -p&quot;stroompassword1&quot; auth &lt; v7_auth_db_table_rename.sql
</code></pre>
<p>This will rename all but one of the tables in the <code>auth</code> database.</p>
<h3 id="copy-the-auth-database-content-to-stroom">Copy the <code>auth</code> database content to <code>stroom</code></h3>
<p>Having run the table rename perform another backup of just the <code>auth</code> database.</p>
<pre><code class="language-bash">./backup_databases.sh . auth
</code></pre>
<p>Now restore this backup into the <code>stroom</code> database.
You can use the v7 stack scripts to do this.</p>
<pre><code class="language-bash">./restore_database.sh stroom auth_20210312143513.sql.gz
</code></pre>
<p>You should now see the following tables in the <code>stroom</code> database:</p>
<pre><code class="language-text">OLD_AUTH_json_web_key
OLD_AUTH_schema_version
OLD_AUTH_token_types
OLD_AUTH_tokens
OLD_AUTH_users
</code></pre>
<p>This can be checked by running the following in the v7 stack.</p>
<pre><code class="language-bash">echo 'select table_name from information_schema.tables where table_name like &quot;OLD_AUTH%&quot;' | ./database_shell.sh
</code></pre>
<h3 id="drop-unused-databases">Drop unused databases</h3>
<p>There may be a number of databases that are no longer used that can be dropped prior to the upgrade.
Note the use of the <code>--force</code> argument so it copes with users that are not there.</p>
<pre><code class="language-bash">docker exec -i stroom-all-dbs mysql --force -u&quot;root&quot; -p&quot;my-secret-pw&quot; &lt; v7_drop_unused_databases.sql
</code></pre>
<p>Verify it worked with:</p>
<pre><code class="language-bash">echo 'show databases;' | docker exec -i stroom-all-dbs mysql -u&quot;root&quot; -p&quot;my-secret-pw&quot;
</code></pre>
<h2 id="performing-the-upgrade">Performing the upgrade</h2>
<p>To perform the stroom schema upgrade to v7 run the migrate command which will migrate the database then exit.
For a large upgrade like this is it is preferable to run the migrate command rather than just starting stroom as stroom will only migrate the parts of the schema as it needs to use them.
Running migrate ensures all parts of the migration are completed when the command is run and no other parts of stroom will be started.</p>
<pre><code class="language-bash">./migrate.sh
</code></pre>
<h2 id="post-upgrade-tasks">Post-Upgrade tasks</h2>
<p><em>TODO</em> remove auth* containers,images,volumes</p>

</div>




    
	
  

    
	
  
    
    
	
    



<div class="td-content" style="--base-section-num: '8.'; page-break-before: always">
    
  <h1 id="pg-c89e5b17a07204690526a16417c9dd50">8 - Configuration</h1>
    
	<blockquote>
<p><strong>Version Information:</strong> Created with Stroom v7.0<br>
<strong>Last Updated:</strong> 2021-06-23</p>
</blockquote>
<p>Stroom and its associated services can be deployed in may ways (single node docker stack, non-docker cluster, kubernetes, etc).
This document will cover two types of deployment:</p>
<ul>
<li>Single node stroom_core docker stack.</li>
<li>A mixed deployment with nginx in docker and stroom, stroom-proxy and the database not in docker.</li>
</ul>
<p>This document will explain how each application/service is configured and where its configuration files live.</p>
<h2 id="application-configuration">Application Configuration</h2>
<p>The following sections provide links to how to configure each application.</p>
<ul>
<li>
<p><a href="../../../docs/install-guide/configuration/configuring-stroom/">Stroom Configuration</a></p>
</li>
<li>
<p><a href="../../../docs/install-guide/configuration/configuring-stroom-proxy/">Stroom Proxy Configuration</a></p>
</li>
<li>
<p><a href="../../../docs/install-guide/configuration/configuring-mysql/">MySQL Configuration</a></p>
</li>
<li>
<p><a href="../../../docs/install-guide/configuration/configuring-nginx/">Nginx Configuration</a></p>
</li>
<li>
<p><a href="../../../docs/install-guide/configuration/configuring-stroom-log-sender/">Stroom log sender Configuration</a></p>
</li>
</ul>
<h2 id="general-configuration-of-docker-stacks">General configuration of docker stacks</h2>
<h3 id="environment-variables">Environment variables</h3>
<p>The stroom docker stacks have a single env file <code>&lt;stack name&gt;.env</code> that acts as a single point to configure some aspects of the stack.
Setting values in the env file can be useful when the value is shared between multiple containers.
This env file sets environment variables that are then used for variable substitution in the docker compose YAML files, e.g.</p>
<pre><code class="language-yaml">    environment:
      - MYSQL_ROOT_PASSWORD=${STROOM_DB_ROOT_PASSWORD:-my-secret-pw}
</code></pre>
<p>In this example the environment variable <code>STROOM_DB_ROOT_PASSWORD</code> is read and used to set the environment variable <code>MYSQL_ROOT_PASSWORD</code> in the docker container.
If <code>STROOM_DB_ROOT_PASSWORD</code> is not set then the value <code>my-secret-pw</code> is used instead.</p>
<p>The environment variables set in the env file are <em>NOT</em> automatically visible <em>inside</em> the containers.
Only those environment variables defined in the <code>environment</code> section of the docker-compose YAML files are visible.
These <code>environment</code> entries can either be hard coded values or use environment variables from <em>outside</em> the container.
In some case the names in the env file and the names of the environment variables set in the containers are the same, in some they are different.</p>
<p>The environment variables set in the containers can then be used by the application running in each container to set its configuration.
For example, stroom&rsquo;s <code>config.yml</code> file also uses variable substitution, e.g.</p>
<pre><code class="language-yaml">appConfig:
  commonDbDetails:
    connection:
    jdbcDriverClassName: &quot;${STROOM_JDBC_DRIVER_CLASS_NAME:-com.mysql.cj.jdbc.Driver}&quot;
</code></pre>
<p>In this example <code>jdbcDriverUrl</code> will be set to the value of environment variable <code>STROOM_JDBC_DRIVER_CLASS_NAME</code> or <code>com.mysql.cj.jdbc.Driver</code> if that is not set.</p>
<p>The following example shows how setting <code>MY_ENV_VAR=123</code> means <code>myProperty</code> will ultimately get a value of <code>123</code> and not its default of <code>789</code>.</p>
<pre><code class="language-text">env file (stroom&lt;stack name&gt;.env) - MY_ENV_VAR=123
                |
                |
                | environment variable substitution
                |
                v
docker compose YAML (01_stroom.yml) - STROOM_ENV_VAR=${MY_ENV_VAR:-456}
                |
                |
                | environment variable substitution
                |
                v
Stroom configuration file (config.yml) - myProperty: &quot;${STROOM_ENV_VAR:-789}&quot;
</code></pre>
<p>Note that environment variables are only set into the container on start.
Any changes to the env file will not take effect until the container is (re)started.</p>
<h3 id="configuration-files">Configuration files</h3>
<p>The following shows the basic structure of a stack with respect to the location of the configuration files:</p>
<pre><code class="language-text">── stroom_core_test-vX.Y.Z
   ├── config                [stack env file and docker compose YAML files]
   └── volumes
       └── &lt;service&gt;
           └── conf/config   [service specifc configuration files]
</code></pre>
<p>Some aspects of configuration do not lend themselves to environment variable substitution, e.g. deeply nested parts of stroom&rsquo;s <code>config.yml</code>.
In these instances it may be necessary to have static configuration files that have no connection to the env file or only use environment variables for some values.</p>
<h3 id="bind-mounts">Bind mounts</h3>
<p>Everything in the stack <code>volumes</code> directory is bind-mounted into the named docker container but is mounted read-only to the container.
This allows configuration files to be read by the container but not modified.</p>
<p>Typically the bind mounts mount a directory into the container, though in the case of the <code>stroom-all-dbs.cnf</code> file, the file is mounted.
The mounts are done using the inode of the file/directory rather than the name, so docker will mount whatever the inode points to even if the name changes.
If for instance the <code>stroom-all-dbs.cnf</code> file is renamed to <code>stroom-all-dbs.cnf.old</code> then copied to <code>stroom-all-dbs.cnf</code> and then the new version modified, the container would still see the old file.</p>
<h3 id="docker-managed-volumes">Docker managed volumes</h3>
<p>When stroom is running various forms of data are persisted, e.g. stroom&rsquo;s stream store, stroom-all-dbs database files, etc.
All this data is stored in docker managed volumes.
By default these will be located in <code>/var/lib/docker/volumes/&lt;volume name&gt;/_data</code> and root/sudo access will be needed to access these directories.</p>
<h4 id="docker-data-root">Docker data root</h4>
<blockquote>
<p><strong>IMPORTANT</strong></p>
</blockquote>
<p>By default Docker stores all its images, container layers and managed volumes in its default data root directory which defaults to <code>/var/lib/docker</code>.
It is typical in server deployments for the root file system to be kept fairly small and this is likely to result in the root file system running out of space due to the growth in docker images/layers/volumes in <code>/var/lib/docker</code>.
It is therefore strongly recommended to move the docker data root to another location with more space.</p>
<p>There are various options for achieving this.
In all cases the docker daemon should be stopped prior to making the changes, e.g. <code>service docker stop</code>, then started afterwards.</p>
<ul>
<li>
<p><strong>Symlink</strong> - One option is to move the <code>var/lib/docker</code> directory to a new location then create a symlink to it.
For example:</p>
<pre><code class="language-sh">ln -s /large_mount/docker_data_root /var/lib/docker
</code></pre>
<p>This has the advantage that anyone unaware that the data root has moved will be able to easily find it if they look in the default location.</p>
</li>
<li>
<p><strong>Configuration</strong> - The location can be changed by adding this key to the file <code>/etc/docker/daemon.json</code> (or creating this file if it doesn&rsquo;t exist.</p>
<pre><code class="language-json">{
  &quot;data-root&quot;: &quot;/mnt/docker&quot;
}

</code></pre>
</li>
<li>
<p><strong>Mount</strong> - If your intention is to use a whole storage device for the docker data root then you can mount that device to <code>/var/lib/docker</code>.
You will need to make a copy of the <code>/var/lib/docker</code> directory prior to doing this then copy it mount once created.
The process for setting up this mount will be OS dependent and is outside the scope of this document.</p>
</li>
</ul>
<h3 id="active-services">Active services</h3>
<p>Each stroom docker stack comes pre-built with a number of different services, e.g. the <em>stroom_core</em> stack contains the following:</p>
<ul>
<li>stroom</li>
<li>stroom-proxy-local</li>
<li>stroom-all-dbs</li>
<li>nginx</li>
<li>stroom-log-sender</li>
</ul>
<p>While you can pass a set of service names to the commands like <code>start.sh</code> and <code>stop.sh</code>, it may sometimes be required to configure the stack instance to only have a set of services active.
You can set the active services like so:</p>
<pre><code class="language-bash">./set_services.sh stroom stroom-all-dbs nginx
</code></pre>
<p>In the above example and subsequent use of commands like <code>start.sh</code> and <code>stop.sh</code> with no named services would only act upon the active services set by <code>set_services.sh</code>.
This list of active services is held in <code>ACTIVE_SERVICES.txt</code> and the full list of available services is held in <code>ALL_SERVICES.txt</code>.</p>
<h3 id="certificates">Certificates</h3>
<p>A number of the services in the docker stacks will make use of SSL certificates/keys in various forms.
The certificate/key files are typically found in the directories <code>volumes/&lt;service&gt;/certs/</code>.</p>
<p>The stacks come with a set of client/server certificates that can be used for demo/test purposes.
For production deployments these should be replaced with the actual certificates/keys for your environment.</p>
<p>In general the best approach to configuring the certificates/keys is to replace the existing files with symlinks to the actual files.
For example in the case of the server certificates for nginx (found in <code>volumes/nginx/certs/</code>) the directory would look like:</p>
<pre><code class="language-text">ca.pem.crt -&gt; /some/path/to/certificate_authority.pem.crt
server.pem.crt -&gt; /some/path/to/host123.pem.crt
server.unencrypted.key -&gt; /some/path/to/host123.key
</code></pre>
<p>This approach avoids the need to change any configuration files to reference differently named certificate/key files and avoids having to copy your real certificates/keys into multiple places.</p>
<p>For examples of how to create certificates, keys and keystores see <a href="https://github.com/gchq/stroom-resources/blob/master/dev-resources/certs/createCerts.sh">creatCerts.sh (external link)</a></p>

</div>




    
      
  
  
  
  

  
  

  
    
    
	
    



<div class="td-content" style="--base-section-num: '8.1.'; page-break-before: always">
    
  <h1 id="pg-a53a193cf4abc0b6dfa8fa20a2fda8e2">8.1 - Nginx Configuration</h1>
    <div class="lead">Nginx is the standard web server used by stroom. Its primary role is SSL termination and reverse proxying for stroom and stroom-proxy that sit behind it. It can also load balance incoming requests and ensure traffic from the same source is always route to the same upstream instance. Other web servers can be used if required but their installation/configuration is out of the scope of this documentation.</div>
	<blockquote>
<p><strong>Version Information:</strong> Created with Stroom v7.0<br>
<strong>Last Updated:</strong> 2021-06-07<br>
<strong>See Also:</strong> <a href="https://nginx.org/en/docs/">Nginx documentation (external link)</a>.</p>
</blockquote>
<h2 id="without-docker">Without Docker</h2>
<p>The standard way of deploying Nginx with stroom running without docker involves running Nginx as part of the <em>services</em> stack.
See below for details of how to configure it.
If you want to deploy Nginx without docker then you can but that is outside the scope of the this documentation.</p>
<h2 id="as-part-of-a-docker-stack">As part of a docker stack</h2>
<p>Nginx is included in all the stroom docker stacks.
Nginx is configured using multiple configuration files to aid clarity and allow reuse of sections of configuration.
The main file for configuring Nginx is <code>nginx.conf.template</code> and this makes use of other files via <code>include</code> statements.</p>
<p>The purpose of the various files is as follows:</p>
<ul>
<li><code>nginx.conf.template</code> - Top level configuration file that orchestrate the other files.</li>
<li><code>logging.conf.template</code> - Configures the logging output, its content and format.</li>
<li><code>server.conf.template</code> - Configures things like SSL settings, timeouts, ports, buffering, etc.</li>
<li>Upstream configuration
<ul>
<li><code>upstreams.stroom.ui.conf.template</code> - Defines the upstream host(s) for stroom node(s) that are dedicated to serving the user interface.</li>
<li><code>upstreams.stroom.processing.conf.template</code> - Defines the upstream host(s) for stroom node(s) that are dedicated to stream processing and direct data receipt.</li>
<li><code>upstreams.proxy.conf.template</code> - Defines the upstream host(s) for local stroom-proxy node(s).</li>
</ul>
</li>
<li>Location configuration
<ul>
<li><code>locations_defaults.conf.template</code> - Defines some default directives (e.g. headers) for configuring stroom paths.</li>
<li><code>proxy_location_defaults.conf.template</code> - Defines some default directives (e.g. headers) for configuring stroom-proxy paths.</li>
<li><code>locations.proxy.conf.template</code> - Defines the various paths (e.g/ <code>/datafeed</code>) that will be reverse proxied to stroom-proxy hosts.</li>
<li><code>locations.stroom.conf.template</code> - Defines the various paths (e.g/ <code>/datafeeddirect</code>) that will be reverse proxied to stroom hosts.</li>
</ul>
</li>
</ul>
<h3 id="templating">Templating</h3>
<p>The nginx container has been configured to support using environment variables passed into it to set values in the Nginx configuration files.
It should be noted that recent versions of Nginx have templating support built in.
The templating mechanism used in stroom&rsquo;s Nginx container was set up before this existed but achieves the same result.</p>
<p>All non-default configuration files for Nginx should be placed in <code>volumes/nginx/conf/</code> and named with the suffix <code>.template</code> (even if no templating is needed).
When the container starts any variables in these templates will be substituted and the resulting files will be copied into <code>/etc/nginx</code>.
The result of the template substitution is logged to help with debugging.</p>
<p>The files can contain templating of the form:</p>
<pre><code class="language-text">ssl_certificate             /stroom-nginx/certs/&lt;&lt;&lt;NGINX_SSL_CERTIFICATE&gt;&gt;&gt;;
</code></pre>
<p>In this example <code>&lt;&lt;&lt;NGINX_SSL_CERTIFICATE&gt;&gt;&gt;</code> will be replaced with the value of environment variable <code>NGINX_SSL_CERTIFICATE</code> when the container starts.</p>
<h3 id="upstreams">Upstreams</h3>
<p>When configuring a multi node cluster you will need to configure the upstream hosts.
Nginx acts as a reverse proxy for the applications behind it so the lists of hosts for each application need to be configured.</p>
<p>For example if you have a 10 node cluster and 2 of those nodes are dedicated for user interface use then the configuration would look like:</p>
<p><strong>upstreams.stroom.ui.conf.template</strong></p>
<pre><code class="language-conf">server node1.stroomhosts:&lt;&lt;&lt;STROOM_PORT&gt;&gt;&gt;
server node2.stroomhosts:&lt;&lt;&lt;STROOM_PORT&gt;&gt;&gt;
</code></pre>
<p><strong>upstreams.stroom.processing.conf.template</strong></p>
<pre><code class="language-conf">server node3.stroomhosts:&lt;&lt;&lt;STROOM_PORT&gt;&gt;&gt;
server node4.stroomhosts:&lt;&lt;&lt;STROOM_PORT&gt;&gt;&gt;
server node5.stroomhosts:&lt;&lt;&lt;STROOM_PORT&gt;&gt;&gt;
server node6.stroomhosts:&lt;&lt;&lt;STROOM_PORT&gt;&gt;&gt;
server node7.stroomhosts:&lt;&lt;&lt;STROOM_PORT&gt;&gt;&gt;
server node8.stroomhosts:&lt;&lt;&lt;STROOM_PORT&gt;&gt;&gt;
server node9.stroomhosts:&lt;&lt;&lt;STROOM_PORT&gt;&gt;&gt;
server node10.stroomhosts:&lt;&lt;&lt;STROOM_PORT&gt;&gt;&gt;
</code></pre>
<p><strong>upstreams.proxy.conf.template</strong></p>
<pre><code class="language-conf">server node3.stroomhosts:&lt;&lt;&lt;STROOM_PORT&gt;&gt;&gt;
server node4.stroomhosts:&lt;&lt;&lt;STROOM_PORT&gt;&gt;&gt;
server node5.stroomhosts:&lt;&lt;&lt;STROOM_PORT&gt;&gt;&gt;
server node6.stroomhosts:&lt;&lt;&lt;STROOM_PORT&gt;&gt;&gt;
server node7.stroomhosts:&lt;&lt;&lt;STROOM_PORT&gt;&gt;&gt;
server node8.stroomhosts:&lt;&lt;&lt;STROOM_PORT&gt;&gt;&gt;
server node9.stroomhosts:&lt;&lt;&lt;STROOM_PORT&gt;&gt;&gt;
server node10.stroomhosts:&lt;&lt;&lt;STROOM_PORT&gt;&gt;&gt;
</code></pre>
<p>In the above example the port is set using templating as it is the same for all nodes.
Nodes 1 and 2 will receive all UI and REST API traffic.
Nodes 8-10 will serve all datafeed(direct) requests.</p>
<h3 id="certificates">Certificates</h3>
<p>The stack comes with a default server certificate/key and CA certificate for demo/test purposes.
The files are located in <code>volumes/nginx/certs/</code>.
For a production deployment these will need to be changed, see <a href="../../../docs/install-guide/configuration/#certificates">Certificates</a></p>
<h3 id="log-rotation">Log rotation</h3>
<p>The Nginx container makes use of logrotate to rotate Nginx&rsquo;s log files after a period of time so that rotated logs can be sent to stroom.
Logrotate is configured using the file <code>volumes/stroom-log-sender/logrotate.conf.template</code>.
This file is templated in the same way as the Nginx configuration files, see <a href="#templating">above</a>.
The number of rotated files that should be kept before deleting them can be controlled using the line.</p>
<pre><code class="language-text">rotate 100
</code></pre>
<p>This should be set in conjunction with the frequency that logrotate is called, which is controlled by <code>volumes/stroom-log-sender/crontab.txt</code>.
This crontab file drives the lograte process and by default is set to run every minute.</p>

</div>




    
	
  
    
    
	
    



<div class="td-content" style="--base-section-num: '8.2.'; page-break-before: always">
    
  <h1 id="pg-f67b02c1954e1e3755f22565ea9c45a2">8.2 - Stroom Configuration</h1>
    
	<blockquote>
<p><strong>Version Information:</strong> Created with Stroom v7.0<br>
<strong>Last Updated:</strong> 2021-06-23<br>
<strong>See Also:</strong> <a href="../../../docs/user-guide/properties/">Properties</a>.</p>
</blockquote>
<h2 id="general-configuration">General configuration</h2>
<p>The Stroom application is essentially just an executable <a href="https://en.wikipedia.org/wiki/JAR_%28file_format%29">JAR (external link)</a> file that can be run when provided with a configuration file, <code>config.yml</code>.
This config file is common to all forms of deployment.</p>
<h3 id="configyml">config.yml</h3>
<p>This file, sometimes known as the DropWizard configuration file (as DropWizard is the java framework on which Stroom runs) is the primary means of configuring stroom.
As a minimum this file should be used to configure anything that needs to be set before stroom can start up, e.g. database connection details or is specific to a node in a stroom cluster.
If you are using some form of scripted deployment, e.g. ansible then it can be used to set all stroom properties for the environment that stroom runs in.
If you are not using scripted deployments then you can maintain stroom&rsquo;s node agnostic configuration properties via the user interface.</p>
<p>For more details on the structure of the file, data types and property precedence see <a href="../../../docs/user-guide/properties/">Properties</a>.</p>
<p>Stroom operates on a configuration by exception basis so all configuration properties will have a sensible default value and a property only needs to be explicitly configured if the default value is not appropriate, e.g. for tuning a large scale production deployment or where values are environment specific.
As a result <code>config.yml</code> only contains a minimal set of properties.
The full tree of properties can be seen in <code>./config/config-defaults.yml</code> and a schema for the configuration tree (along with descriptions for each property) can be found in <code>./config/config-schema.yml</code>.
These two files can be used as a reference when configuring stroom.</p>
<h4 id="key-configuration-properties">Key Configuration Properties</h4>
<p>The following are key properties that would typically be changed for a production deployment.
All configuration branches are relative to the <code>appConfig</code> root.</p>
<p>The database name(s), hostname(s), port(s), usernames(s) and password(s) should be configured using these properties.
Typically stroom is configured to keep it statistics data in a separate database to the main stroom database, as is configured below.</p>
<pre><code class="language-yaml">  commonDbDetails:
    connection:
      jdbcDriverUrl: &quot;jdbc:mysql://localhost:3307/stroom?useUnicode=yes&amp;characterEncoding=UTF-8&quot;
      jdbcDriverUsername: &quot;stroomuser&quot;
      jdbcDriverPassword: &quot;stroompassword1&quot;
  statistics:
    sql:
      db:
        connection:
          jdbcDriverUrl: &quot;jdbc:mysql://localhost:3307/stats?useUnicode=yes&amp;characterEncoding=UTF-8&quot;
          jdbcDriverUsername: &quot;statsuser&quot;
          jdbcDriverPassword: &quot;stroompassword1&quot;
</code></pre>
<p>In a clustered deployment each node must be given a node name that is unique within the cluster.
This is used to identify nodes in the Nodes screen.
It could be the hostname of the node or follow some other naming convetion.</p>
<pre><code class="language-yaml">  node:
    name: &quot;node1a&quot;
</code></pre>
<p>Each node should have its identity on the network configured so that it uses the appropriate FQDNs.
The <code>nodeUri</code> hostname is the FQDN of each node and used by nodes to communicate with each other, therefore it can be private to the cluster of nodes.
The <code>publicUri</code> hostname is the public facing FQDN for stroom, i.e. the address of a load balancer or Nginx.
This is the address that users will use in their browser.</p>
<pre><code class="language-yaml">  nodeUri:
    hostname: &quot;localhost&quot; # e.g. node5.stroomnodes.somedomain
  publicUri:
    hostname: &quot;localhost&quot; # e.g. stroom.somedomain
</code></pre>
<h2 id="deploying-without-docker">Deploying without Docker</h2>
<p>Stroom running without docker has two files to configure it.
The following locations are relative to the stroom home directory, i.e. the root of the distribution zip.</p>
<ul>
<li><code>./config/config.yml</code> - Stroom configuration YAML file</li>
<li><code>./config/scripts.env</code> - Stroom scripts configuration env file</li>
</ul>
<p>The distribution also includes these files which are helpful when it comes to configuring stroom.</p>
<ul>
<li><code>./config/config-defaults.yml</code> - Full version of the config.yml file containing all branches/leaves with default values set.
Useful as a reference for the structure and the default values.</li>
<li><code>./config/config-schema.yml</code> - The schema defining the structure of the <code>config.yml</code> file.</li>
</ul>
<h3 id="scriptsenv">scripts.env</h3>
<p>This file is used by the various shell scripts like <code>start.sh</code>, <code>stop.sh</code>, etc.
This file should not need to be unless you want to change the locations where certain log files are written to or need to change the java memory settings.</p>
<p>In a production system it is highly likely that you will need to increase the java heap size as the default is only 2G.
The heap size settings and any other java command line options can be set by changing:</p>
<pre><code class="language-sh">JAVA_OPTS=&quot;-Xms512m -Xmx2048m&quot;
</code></pre>
<h2 id="as-part-of-a-docker-stack">As part of a docker stack</h2>
<p>When stroom is run as part of one of our docker stacks, e.g. <em>stroom_core</em> there are some additional layers of configuration to take into account, but the configuration is still primarily done using the <code>config.yml</code> file.</p>
<p>Stroom&rsquo;s <code>config.yml</code> file is found in the stack in <code>./volumes/stroom/config/</code> and this is the primary means of configuring Stroom.</p>
<p>The stack also ships with a default <code>config.yml</code> file baked into the docker image.
This minimal fallback file (located in <code>/stroom/config-fallback/</code> inside the container) will be used in the absence of one provided in the docker stack configuration (<code>./volumes/stroom/config/</code>).</p>
<p>The default <code>config.yml</code> file uses <a href="../../../docs/install-guide/configuration/#environment-variables">environment variable substitution</a> so some configuration items will be set by environment variables set into the container by the stack <em>env</em> file and the docker-compose YAML.
This approach is useful for configuration values that need to be used by multiple containers, e.g. the public FQDN of Nginx, so it can be configured in one place.</p>
<p>If you need to further customise the stroom configuration then it is recommended to edit the <code>./volumes/stroom/config/config.yml</code> file.
This can either be a simple file with hard coded values or one that uses environment variables for some of its
configuration items.</p>
<p>The configuration works as follows:</p>
<pre><code class="language-text">env file (stroom&lt;stack name&gt;.env)
                |
                |
                | environment variable substitution
                |
                v
docker compose YAML (01_stroom.yml)
                |
                |
                | environment variable substitution
                |
                v
Stroom configuration file (config.yml)
</code></pre>
<h3 id="ansible">Ansible</h3>
<p>If you are using Ansible to deploy a stack then it is recommended that all of stroom&rsquo;s configuration properties are set directly in the <code>config.yml</code> file using a templated version of the file and to NOT use any environment variable substitution.
When using Ansible, the Ansible inventory is the single source of truth for your configuration so not using environment variable substitution for stroom simplifies the configuration and makes it clearer when looking at deployed configuration files.</p>
<p><a href="https://github.com/gchq/stroom-ansible">Stroom-ansible</a> has an example inventory for a single node stroom stack deployment.
The <a href="https://github.com/gchq/stroom-ansible/blob/master/config/single_node_stroom_core_stack/example_inventory/group_vars/all">group_vars/all</a> file shows how values can be set into the <em>env</em> file.</p>

</div>




    
	
  
    
    
	
    



<div class="td-content" style="--base-section-num: '8.3.'; page-break-before: always">
    
  <h1 id="pg-2fbd4f6015742d6292564c2fec48dde8">8.3 - Stroom Proxy Configuration</h1>
    
	<blockquote>
<p><strong>Version Information:</strong> Created with Stroom v7.0<br>
<strong>Last Updated:</strong> 2021-06-23<br>
<strong>See Also:</strong> <a href="../../../docs/install-guide/configuration/configuring-stroom/">Stroom Application Configuration</a><br>
<strong>See Also:</strong> <a href="../../../docs/user-guide/properties/">Properties</a>.<br>
<strong>TODO:</strong> This needs updating for v7.1</p>
</blockquote>
<p>The configuration of Stroom-proxy is very much the same as for Stroom with the only difference being the structure of the <code>config.yml</code> file.
Stroom-proxy has a <code>proxyConfig</code> key in the YAML while Stroom has <code>appConfig</code>.
It is recommended to first read <a href="../../../docs/install-guide/configuration/configuring-stroom/">Stroom Application Configuration</a> to understand the general mechanics of the stroom configuration as this will largely apply to stroom-proxy.</p>
<h2 id="general-configuration">General configuration</h2>
<p>The Stroom-proxy application is essentially just an executable <a href="https://en.wikipedia.org/wiki/JAR_%28file_format%29">JAR (external link)</a> file that can be run when provided with a configuration file, <code>config.yml</code>.
This configuration file is common to all forms of deployment.</p>
<h3 id="configyml">config.yml</h3>
<p>Stroom-proxy does not have a user interface so the <code>config.yml</code> file is the only way of configuring stroom-proxy.
As with stroom, the <code>config.yml</code> file is split into three sections using these keys:</p>
<ul>
<li><code>server</code> - Configuration of the web server, e.g. ports, paths, request logging.</li>
<li><code>logging</code> - Configuration of application logging</li>
<li><code>proxyConfig</code> - Configuration of stroom-proxy</li>
</ul>
<p>See also <a href="../../../docs/user-guide/properties/">Properties</a> for more details on structure of the config.yml file and supported data types.</p>
<p>Stroom-proxy operates on a configuration by exception basis so all configuration properties will have a sensible default value and a property only needs to be explicitly configured if the default value is not appropriate, e.g. for tuning a large scale production deployment or where values are environment specific.
As a result <code>config.yml</code> only contains a minimal set of properties.
The full tree of properties can be seen in <code>./config/config-defaults.yml</code> and a schema for the configuration tree (along with descriptions for each property) can be found in <code>./config/config-schema.yml</code>.
These two files can be used as a reference when configuring stroom.</p>
<h4 id="key-configuration-properties">Key Configuration Properties</h4>
<p>Stroom-proxy has two main functions, storing and forwarding.
It can be configured to do either or both of these functions.
These functions are enabled/disabled using:</p>
<pre><code class="language-yaml">proxyConfig:

  forwardStreamConfig:
    forwardingEnabled: true

  proxyRepositoryConfig:
    storingEnabled: true
</code></pre>
<p>Stroom-proxy should be configured to check the receipt status of feeds on receipt of data.
This is done by configuring the end point of a downstream stroom-proxy or stroom.</p>
<pre><code class="language-yaml">  feedStatus:
    url: &quot;http://stroom:8080/api/feedStatus/v1&quot;
    apiKey: &quot;&quot;
</code></pre>
<p>The <code>url</code> should be the url for the feed status API on the downstream stroom(-proxy).
If this is on the same host then you can use the http endpoint, however if it is on a remote host then you should use https and the host of its nginx, e.g. <code>https://downstream-instance/api/feedStatus/v1</code>.</p>
<p>In order to use the API, the proxy must have a configured <code>apiKey</code>.
The API key must be created in the downstream stroom instance and then copied into this configuration.</p>
<p>If the proxy is configured to forward data then the forward destination(s) should be set.
This is the <code>datafeed</code> endpoint of the downstream stroom-proxy or stroom instance that data will be forwarded to.
This may also be te address of a load balancer or similar that is fronting a cluster of stroom-proxy or stroom instances.
See also <a href="#feed-status-certificate-configuration">Feed status certificate configuration</a>.</p>
<pre><code class="language-yaml">  forwardStreamConfig:
    forwardDestinations:
      - forwardUrl: &quot;https://nginx/stroom/datafeed&quot;
</code></pre>
<p><code>forwardUrl</code> specifies the URL of the <em>datafeed</em> endpoint on the destination host.
Each forward location can use a different key/trust store pair.
See also <a href="#forwarding-certificate-configuration">Forwarding certificate configuration</a>.</p>
<p>If the proxy is configured to store then it is the location of the proxy repository may need to be configured if it needs to be in a different location to the proxy home directory, e.g. on another mount point.</p>
<h2 id="deploying-without-docker">Deploying without Docker</h2>
<p>Apart from the structure of the <code>config.yml</code> file, the configuration in a non-docker environment is the same as for <a href="../../../docs/install-guide/configuration/configuring-stroom-proxy/#deploying-without-docker">stroom</a></p>
<h2 id="as-part-of-a-docker-stack">As part of a docker stack</h2>
<p>The way stroom-proxy is configured is essentially the same as for <a href="../../../docs/install-guide/configuration/configuring-stroom-proxy/#as-part-of-a-docker-stack">stroom</a> with the only real difference being the structure of the <code>config.yml</code> file as note <a href="#configyml">above</a> .
As with stroom the docker stack comes with a <code>./volumes/stroom-proxy-*/config/config.yml</code> file that will be used in the absence of a provided one.
Also as with stroom, the <code>config.yml</code> file supports environment variable substitution so can make use of environment variables set in the stack env file and passed down via the docker-compose YAML files.</p>
<h3 id="certificates">Certificates</h3>
<p>Stroom-proxy makes use of client certificates for two purposes:</p>
<ul>
<li>Communicating with a downstream stroom/stroom-proxy in order to establish the receipt status for the feeds it has received data for.</li>
<li>When forwarding data to a downstream stroom/stroom-proxy</li>
</ul>
<p>The stack comes with the following files that can be used for demo/test purposes.</p>
<pre><code class="language-text">volumes/stroom-proxy-*/certs/ca.jks
volumes/stroom-proxy-*/certs/client.jks
</code></pre>
<p>For a production deployment these will need to be changed, see <a href="../../../docs/install-guide/configuration/#certificates">Certificates</a></p>
<h4 id="feed-status-certificate-configuration">Feed status certificate configuration</h4>
<p>The configuration of the client certificates for feed status checks is done using:</p>
<pre><code class="language-yaml">proxyConfig:

  jerseyClient:
    timeout: &quot;10s&quot;
    connectionTimeout: &quot;10s&quot;
    timeToLive: &quot;1h&quot;
    cookiesEnabled: false
    maxConnections: 1024
    maxConnectionsPerRoute: &quot;1024&quot;
    keepAlive: &quot;0ms&quot;
    retries: 0
    tls:
      verifyHostname: true
      keyStorePath: &quot;/stroom-proxy/certs/client.jks&quot;
      keyStorePassword: &quot;password&quot;
      keyStoreType: &quot;JKS&quot;
      trustStorePath: &quot;/stroom-proxy/certs/ca.jks&quot;
      trustStorePassword: &quot;password&quot;
      trustStoreType: &quot;JKS&quot;
      trustSelfSignedCertificates: false
</code></pre>
<p>This configuration is also used for making any other REST API calls.</p>
<h4 id="forwarding-certificate-configuration">Forwarding certificate configuration</h4>
<p>Stroom-proxy can forward to multiple locations.
The configuration of the certificate(s) for the forwarding locations is as follows:</p>
<pre><code class="language-yaml">proxyConfig:

  forwardStreamConfig:
    forwardingEnabled: true
    forwardDestinations:
      # If you want multiple forward destinations then you will need to edit this file directly
      # instead of using env var substitution
      - forwardUrl: &quot;https://nginx/stroom/datafeed&quot;
        sslConfig:
          keyStorePath: &quot;/stroom-proxy/certs/client.jks&quot;
          keyStorePassword: &quot;password&quot;
          keyStoreType: &quot;JKS&quot;
          trustStorePath: &quot;/stroom-proxy/certs/ca.jks&quot;
          trustStorePassword: &quot;password&quot;
          trustStoreType: &quot;JKS&quot;
          hostnameVerificationEnabled: true
</code></pre>
<p><code>forwardUrl</code> specifies the URL of the <em>datafeed</em> endpoint on the destination host.
Each forward location can use a different key/trust store pair.</p>

</div>




    
	
  
    
    
	
    



<div class="td-content" style="--base-section-num: '8.4.'; page-break-before: always">
    
  <h1 id="pg-cea106477cd6590d5c2f583e39fc1d53">8.4 - Stroom Log Sender Configuration</h1>
    
	<blockquote>
<p><strong>Version Information:</strong> Created with Stroom v7.0<br>
<strong>Last Updated:</strong> 2021-06-14</p>
</blockquote>
<p>Stroom log sender is a docker image used for sending application logs to stroom.
It is essentially just a combination of the <a href="https://github.com/gchq/stroom-clients/tree/master/bash">send_to_stroom.sh (external link)</a> script and a set of crontab entries to call the script at intervals.</p>
<h2 id="deploying-without-docker">Deploying without Docker</h2>
<p>When deploying without docker stroom and stroom-proxy nodes will need to be configured to send their logs to stroom.
This can be done using the <code>./bin/send_to_stroom.sh</code> script in the stroom and stroom-proxy zip distributions and some crontab configuration.</p>
<p>The crontab file for the user account running stroom should be edited (<code>crontab -e</code>) and set to something like:</p>
<pre><code class="language-crontab"># stroom logs
* * * * * STROOM_HOME=&lt;path to stroom home&gt; ${STROOM_HOME}/bin/send_to_stroom.sh ${STROOM_HOME}/logs/access STROOM-ACCESS-EVENTS &lt;datafeed URL&gt; --system STROOM --environment &lt;environment&gt; --file-regex '.*/[a-z]+-[0-9]{4}-[0-9]{2}-[0-9]{2}T.*\\.log' --max-sleep 10 --key &lt;key file&gt; --cert &lt;cert file&gt; --cacert &lt;CA cert file&gt; --delete-after-sending --compress &gt;&gt; &lt;path to log&gt; 2&gt;&amp;1
* * * * * STROOM_HOME=&lt;path to stroom home&gt; ${STROOM_HOME}/bin/send_to_stroom.sh ${STROOM_HOME}/logs/app    STROOM-APP-EVENTS    &lt;datafeed URL&gt; --system STROOM --environment &lt;environment&gt; --file-regex '.*/[a-z]+-[0-9]{4}-[0-9]{2}-[0-9]{2}T.*\\.log' --max-sleep 10 --key &lt;key file&gt; --cert &lt;cert file&gt; --cacert &lt;CA cert file&gt; --delete-after-sending --compress &gt;&gt; &lt;path to log&gt; 2&gt;&amp;1
* * * * * STROOM_HOME=&lt;path to stroom home&gt; ${STROOM_HOME}/bin/send_to_stroom.sh ${STROOM_HOME}/logs/user   STROOM-USER-EVENTS   &lt;datafeed URL&gt; --system STROOM --environment &lt;environment&gt; --file-regex '.*/[a-z]+-[0-9]{4}-[0-9]{2}-[0-9]{2}T.*\\.log' --max-sleep 10 --key &lt;key file&gt; --cert &lt;cert file&gt; --cacert &lt;CA cert file&gt; --delete-after-sending --compress &gt;&gt; &lt;path to log&gt; 2&gt;&amp;1

# stroom-proxy logs
* * * * * PROXY_HOME=&lt;path to proxy home&gt; ${PROXY_HOME}/bin/send_to_stroom.sh ${PROXY_HOME}/logs/access  STROOM_PROXY-ACCESS-EVENTS  &lt;datafeed URL&gt; --system STROOM-PROXY --environment &lt;environment&gt; --file-regex '.*/[a-z]+-[0-9]{4}-[0-9]{2}-[0-9]{2}T.*\\.log' --max-sleep 10 --key &lt;key file&gt; --cert &lt;cert file&gt; --cacert &lt;CA cert file&gt; --delete-after-sending --compress &gt;&gt; &lt;path to log&gt; 2&gt;&amp;1
* * * * * PROXY_HOME=&lt;path to proxy home&gt; ${PROXY_HOME}/bin/send_to_stroom.sh ${PROXY_HOME}/logs/app     STROOM_PROXY-APP-EVENTS     &lt;datafeed URL&gt; --system STROOM-PROXY --environment &lt;environment&gt; --file-regex '.*/[a-z]+-[0-9]{4}-[0-9]{2}-[0-9]{2}T.*\\.log' --max-sleep 10 --key &lt;key file&gt; --cert &lt;cert file&gt; --cacert &lt;CA cert file&gt; --delete-after-sending --compress &gt;&gt; &lt;path to log&gt; 2&gt;&amp;1
* * * * * PROXY_HOME=&lt;path to proxy home&gt; ${PROXY_HOME}/bin/send_to_stroom.sh ${PROXY_HOME}/logs/send    STROOM_PROXY-SEND-EVENTS    &lt;datafeed URL&gt; --system STROOM-PROXY --environment &lt;environment&gt; --file-regex '.*/[a-z]+-[0-9]{4}-[0-9]{2}-[0-9]{2}T.*\\.log' --max-sleep 10 --key &lt;key file&gt; --cert &lt;cert file&gt; --cacert &lt;CA cert file&gt; --delete-after-sending --compress &gt;&gt; &lt;path to log&gt; 2&gt;&amp;1
* * * * * PROXY_HOME=&lt;path to proxy home&gt; ${PROXY_HOME}/bin/send_to_stroom.sh ${PROXY_HOME}/logs/receive STROOM_PROXY-RECEIVE-EVENTS &lt;datafeed URL&gt; --system STROOM-PROXY --environment &lt;environment&gt; --file-regex '.*/[a-z]+-[0-9]{4}-[0-9]{2}-[0-9]{2}T.*\\.log' --max-sleep 10 --key &lt;key file&gt; --cert &lt;cert file&gt; --cacert &lt;CA cert file&gt; --delete-after-sending --compress &gt;&gt; &lt;path to log&gt; 2&gt;&amp;1
</code></pre>
<p>where the environment specific values are:</p>
<ul>
<li><code>&lt;path to stroom home&gt;</code> - The absolute path to the stroom home, i.e. the location of the <code>start.sh</code> script.</li>
<li><code>&lt;path to proxy home&gt;</code> - The absolute path to the stroom-proxy home, i.e. the location of the <code>start.sh</code> script.</li>
<li><code>&lt;datafeed URL&gt;</code> - The URL that the logs will be sent to.
This will typically be the nginx host or load balancer and the path will typically be <code>https://host/datafeeddirect</code> to bypass the proxy for faster access to the logs.</li>
<li><code>&lt;environment&gt;</code> - The environment name that the stroom/proxy is deployed in, e.g. OPS, REF, DEV, etc.</li>
<li><code>&lt;key file&gt;</code> - The absolute path to the SSL key file used by curl.</li>
<li><code>&lt;cert file&gt;</code> - The absolute path to the SSL certificate file used by curl.</li>
<li><code>&lt;CA cert file&gt;</code> - The absolute path to the SSL certificate authority file used by curl.</li>
<li><code>&lt;path to log&gt;</code> - The absolute path to a log file to log all the send_to_stroom.sh output to.</li>
</ul>
<p>If your implementation of cron supports environment variables then you can define some of the common values at the top of the crontab file and use them in the entries.
<code>cronie</code> as used by Centos does not support environment variables in the crontab file but variables can be defined at the line level as has been shown with STROOM_HOME and PROXY_HOME.</p>
<p>The above crontab entries assume that stroom and stroom-proxy are running on the same host.
If there are not then the entries can be split across the hosts accordingly.</p>
<h3 id="service-hosts">Service host(s)</h3>
<p>When deploying stroom/stroom-proxy without stroom you may still be deploying the service stack (nginx and stroom-log-sender) to a host.
In this case see <a href="#as-part-of-a-docker-stack">As part of a docker stack</a> below for details of how to configure stroom-log-sender to send the nginx logs.</p>
<h2 id="as-part-of-a-docker-stack">As part of a docker stack</h2>
<h3 id="crontab">Crontab</h3>
<p>The docker stacks include the stroom-log-sender docker image for sending the logs of all the other containers to stroom.
Stroom-log-sender is configured using the crontab file <code>volumes/stroom-log-sender/conf/crontab.txt</code>.
When the container starts this file will be read.
Any variables in it will be substituted with the values from the corresponding environment variables that are present in the container.
These common values can be set in the <code>config/&lt;stack name&gt;.env</code> file.</p>
<p>As the variables are substituted on container start you will need to restart the container following any configuration change.</p>
<h3 id="certificates">Certificates</h3>
<p>The directory <code>volumes/stroom-log-sender/certs</code> contains the default client certificates used for the stack.
These allow stroom-log-sender to send the log files over SSL which also provides stroom with details of the sender.
These will need to be replaced in a production environment.</p>
<pre><code class="language-text">volumes/stroom-log-sender/certs/ca.pem.crt
volumes/stroom-log-sender/certs/client.pem.crt
volumes/stroom-log-sender/certs/client.unencrypted.key
</code></pre>
<p>For a production deployment these will need to be changed, see <a href="../../../docs/install-guide/configuration/#certificates">Certificates</a></p>

</div>




    
	
  
    
    
	
    



<div class="td-content" style="--base-section-num: '8.5.'; page-break-before: always">
    
  <h1 id="pg-c55274dc8017978026995b0c30172626">8.5 - MySQL Configuration</h1>
    
	<blockquote>
<p><strong>Version Information:</strong> Created with Stroom v7.0<br>
<strong>Last Updated:</strong> 2021-06-07<br>
<strong>See Also:</strong> <a href="../../../docs/install-guide/setup/mysql-server-setup/">MySQL Server Setup</a><br>
<strong>See Also:</strong> <a href="https://dev.mysql.com/doc/refman/8.0/en/server-administration.html">MySQL Server Administration (external link)</a></p>
</blockquote>
<h2 id="general-configuration">General configuration</h2>
<p>MySQL is configured via the <code>.cnf</code> file which is typically located in one of these locations:</p>
<ul>
<li><code>/etc/my.cnf</code></li>
<li><code>/etc/mysql/my.cnf</code></li>
<li><code>$MYSQL_HOME/my.cnf</code></li>
<li><code>&lt;data dir&gt;/my.cnf</code></li>
<li><code>~/.my.cnf</code></li>
</ul>
<h3 id="key-configuration-properties">Key configuration properties</h3>
<ul>
<li>
<p><code>lower_case_table_names</code> - This proerty controls how the tables are stored on the filesystem and the case-sensitivity of table names in SQL.
A value of <code>0</code> means tables are stored on the filesystem in the case used in CREATE TABLE and sql is case sensitive.
This is the default in linux and is the preferred value for deployments of stroom of v7+.
A value of <code>1</code> means tables are stored on the filesystem in lowercase but sql is case insensitive.
<a href="https://dev.mysql.com/doc/refman/8.0/en/identifier-case-sensitivity.html">See also (external link)</a></p>
</li>
<li>
<p><code>max_connections</code> - The maximum permitted number of simultaneous client connections.
For a clustered deployment of stroom, the default value of 151 will typically be too low.
Each stroom node will hold a pool of open database connections for its use, therefore with a large number of stroom nodes and a big connection pool the total number of connections can be very large.
This property should be set taking into account the values of the stroom properties of the form <code>*.db.connectionPool.maxPoolSize</code>.
<a href="https://dev.mysql.com/doc/refman/8.0/en/connection-interfaces.html">See also (external link)</a></p>
</li>
<li>
<p><code>innodb_buffer_pool_size</code>/<code>innodb_buffer_pool_instances</code> - Controls the amount of memory availble to MySQL for caching table/index data.
Typically this will be set to 80% of available RAM, assuming MySQL is running on a dedicated host and the total amount of table/index data is greater than 80% of avaialable RAM.
<em>Note</em>: <code>innodb_buffer_pool_size</code> must be set to a value that is equal to or a multiple of <code>innodb_buffer_pool_chunk_size * innodb_buffer_pool_instances</code>.
<a href="https://dev.mysql.com/doc/refman/8.0/en/innodb-buffer-pool-resize.html">See also (external link)</a></p>
</li>
</ul>
<blockquote>
<p><strong>TODO</strong> - Add additional key configuration items</p>
</blockquote>
<h2 id="deploying-without-docker">Deploying without Docker</h2>
<p>When MySQL is deployed without a docker stack then MySQL should be installed and configured according to the MySQL documentation.
How MySQL is deployed and configured will depend on the requirements of the environment, e.g. clustered, primary/standby, etc.</p>
<h2 id="as-part-of-a-docker-stack">As part of a docker stack</h2>
<p>Where a stroom docker stack includes stroom-all-dbs (MySQL) the MySQL instance is configured via the <code>.cnf</code> file.
The <code>.cnf</code> file is located in <code>volumes/stroom-all-dbs/conf/stroom-all-dbs.cnf</code>.
This file is read-only to the container and will be read on container start.</p>
<h3 id="database-initialisation">Database initialisation</h3>
<p>When the container is started for the first time the database be initialised with the root user account.
It will also then run any scripts found in <code>volumes/stroom-all-dbs/init/stroom</code>.
The scripts in here will be run in alpabetical order.
Scripts of the form <code>.sh</code>, <code>.sql</code>, <code>.sql.gz</code> and <code>.sql.template</code> are supported.</p>
<p><code>.sql.template</code> files are proprietry to stroom stacks and are just templated <code>.sql</code> files.
They can contain tags of the form <code>&lt;&lt;&lt;ENV_VAR_NAME&gt;&gt;&gt;</code> which will be replaced with the value of the named environment variable that has been set in the container.</p>
<p>If you need to add additional database users then either add them to <code>volumes/stroom-all-dbs/init/stroom/001_create_databases.sql.template</code> or create additional scripts/templates in that directory.</p>
<p>The script that controls this templating is <code>volumes/stroom-all-dbs/init/000_stroom_init.sh</code>.
This script MUST not have its executable bit set else it will be executed rather than being sourced by the MySQL entry point scripts and will then not work.</p>

</div>




    
	
  

    
	
  



          </main>
        </div>
      </div>
      
<footer class="bg-dark py-5 row d-print-none">
  <div class="container-fluid mx-sm-5">
    <div class="row">
      <div class="col-6 col-sm-4 text-xs-center order-sm-2">
        
        
        
      </div>
      <div class="col-6 col-sm-4 text-right text-xs-center order-sm-3">
        
        
        
<ul class="list-inline mb-0">
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="GitHub" aria-label="GitHub">
    <a class="text-white" target="_blank" rel="noopener" href="https://github.com/gchq/stroom" aria-label="GitHub">
      <i class="fab fa-github"></i>
    </a>
  </li>
  
</ul>

        
        
      </div>
      <div class="col-12 col-sm-4 text-center py-2 order-sm-2">
        <small class="text-white">&copy; 2022 Crown Copyright All Rights Reserved</small>
        
	
      </div>
    </div>
  </div>
</footer>


    </div>
    

<script src='../../../js/popper.min.js'></script>
<script src='../../../js/bootstrap.min.js'></script>






<script src='../../../js/tabpane-persist.js'></script>



















<script src="../../../js/main.js"></script>



<script src='../../../js/prism.js'></script>



  </body>
</html>
