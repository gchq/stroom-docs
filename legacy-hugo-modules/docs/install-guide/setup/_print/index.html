<!doctype html>
<html lang="en" class="no-js">
  <head>
    
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="generator" content="Hugo 0.95.0" />
<link rel="canonical" type="text/html" href="../../../../docs/install-guide/setup/">
<meta name="robots" content="noindex, nofollow">


<link rel="shortcut icon" href="../../../../favicons/favicon.ico" >
<link rel="apple-touch-icon" href="../../../../favicons/apple-touch-icon-180x180.png" sizes="180x180">
<link rel="icon" type="image/png" href="../../../../favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="../../../../favicons/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="../../../../favicons/android-36x36.png" sizes="36x36">
<link rel="icon" type="image/png" href="../../../../favicons/android-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="../../../../favicons/android-72x72.png" sizes="72x72">
<link rel="icon" type="image/png" href="../../../../favicons/android-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="../../../../favicons/android-144x144.png" sizes="144x144">
<link rel="icon" type="image/png" href="../../../../favicons/android-192x192.png" sizes="192x192">

<title>Setup | Stroom</title>
<meta name="description" content="">
<meta property="og:title" content="Setup" />
<meta property="og:description" content="Stroom documentation, release notes, news and open source community information" />
<meta property="og:type" content="website" />
<meta property="og:url" content="/docs/install-guide/setup/" /><meta property="og:site_name" content="Stroom" />

<meta itemprop="name" content="Setup">
<meta itemprop="description" content="Stroom documentation, release notes, news and open source community information"><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Setup"/>
<meta name="twitter:description" content="Stroom documentation, release notes, news and open source community information"/>





<link href="../../../../scss/main.css" rel="stylesheet">


<script src='../../../../js/jquery-3.6.0.min.js'></script>


<script src='../../../../js/lunr.min.js'></script>
  
<link rel="stylesheet" href="../../../../css/prism.css"/>

  </head>
  <body class="td-section">
    <header>
      
<nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar">
        <a class="navbar-brand" href="../../../../">
		<span class="navbar-logo"><svg xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:cc="http://creativecommons.org/ns#" xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#" xmlns:svg="http://www.w3.org/2000/svg" xmlns="http://www.w3.org/2000/svg" xmlns:sodipodi="http://sodipodi.sourceforge.net/DTD/sodipodi-0.dtd" xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape" width="110.61089" height="30.000004" viewBox="0 0 88.488641 23.999957" id="svg2" inkscape:version="0.91 r13725" sodipodi:docname="logo.svg"><defs id="defs20"/><sodipodi:namedview pagecolor="#989898" bordercolor="#666666" borderopacity="1" objecttolerance="10" gridtolerance="10" guidetolerance="10" inkscape:pageopacity="0" inkscape:pageshadow="2" inkscape:window-width="1920" inkscape:window-height="1137" id="namedview18" showgrid="false" fit-margin-top="0" fit-margin-left="0" fit-margin-right="0" fit-margin-bottom="0" inkscape:zoom="5.5951814" inkscape:cx="55.451414" inkscape:cy="16.275348" inkscape:window-x="0" inkscape:window-y="0" inkscape:window-maximized="1" inkscape:current-layer="svg2"/><g id="g4150" style="opacity:.97000002" transform="matrix(0.03883584,0,0,0.03883584,0,-3.1155874e-4)"><path id="path6" d="M121.99991 205.98497C54.999958 205.98497.0 259.98493.0 327.98487c0 66.99994 54.999958 121.99989 121.99991 121.99989h167.99987c24.99998.0 44.99996 20.99998 44.99996 44.99996.0 24.99998-19.99998 44.99996-44.99996 44.99996H109.20929C65.984126 553.87219 27.100843 581.57313.01093599 617.98462H289.99978c66.99994.0 121.99991-54.99996 121.99991-122.9999.0-66.99994-54.99997-121.99989-121.99991-121.99989H121.99991c-24.999984.0-44.999969-19.99999-44.999969-44.99996.0-24.99998 19.999985-44.99996 44.999969-44.99996h228.79045c26.9905-35.88325 65.47093-63.18547 108.21554-76.99994H121.99991z" style="fill:#fff" inkscape:connector-curvature="0"/><path id="path8" d="M601.44485-.00077860649C572.6583 8.3697982 546.49491 22.822962 524.44491 41.902305V205.78969l.002.19528h-.002c-65.11 48e-5-123.03145 30.0199-160.74675 76.99994h160.74675v334.99971h76.99994V282.98491h144.85298c27.16134-36.05885 65.96411-63.39275 109.02184-76.99994H601.44485v-205.98574860649z" style="fill:#fff" inkscape:connector-curvature="0"/><path id="path10" d="m919.42586 205.98497c-113.99519.0-205.99537 92.00648-206.00296 205.99982-15e-5 68.67178.0 137.32749.0 205.99983h77.99994c-.012-68.6493.0176-137.46869.0-205.99983.0846-70.92785 57.05747-128.99988 128.00462-128.99988 5.28623.0 10.49823.32864 15.62183.95311 18.2219-24.51229 41.78461-45.0838 68.42501-60.15146-25.65065-11.43799-54.08662-17.80159-84.04684-17.80159z" style="fill:#fff" inkscape:connector-curvature="0"/><path id="path12" d="m1109.4153 205.98457c-113.99994.0-205.99983 91.99993-205.99983 205.99984.0 112.9999 91.99989 205.9998 205.99983 205.9998 114 0 205.9999-92.9999 205.9999-205.9998.0-113.99991-91.9999-205.99984-205.9999-205.99984zm0 333.99974c-70.9999.0-128.99994-56.99996-128.99994-127.9999.0-70.99995 58.00004-128.9999 128.99994-128.9999 71 0 128.9999 57.99995 128.9999 128.9999.0 70.99994-57.9999 127.9999-128.9999 127.9999z" style="fill:#fff" inkscape:connector-curvature="0"/><path id="path14" d="m1444.4737 205.98457c-113.9999.0-205.9998 91.99993-205.9998 205.99984.0 112.9999 91.9999 205.9998 205.9998 205.9998s205.9999-92.9999 205.9999-205.9998c0-113.99991-92-205.99984-205.9999-205.99984zm0 333.99974c-70.9999.0-128.9999-56.99996-128.9999-127.9999.0-70.99995 58-128.9999 128.9999-128.9999 71 0 128.9999 57.99995 128.9999 128.9999.0 70.99994-57.9999 127.9999-128.9999 127.9999z" style="fill:#fff" inkscape:connector-curvature="0"/><path id="path16" d="m1738.5308 379.98447c0-53 43-97 95.9999-97 53 0 97 44 97 97v237.9997h76.9999v-237.9997c0-53 43-97 96.9999-97 53 0 95.9999 44 95.9999 97v237.9997h77v-237.9997c0-96-77-173.9999-172.9999-173.9999-54.9999.0-103.9999 24.99998-135.9999 64.99995-31.9999-39.99997-79.9999-64.99995-134.9999-64.99995-95.9999.0-173.9998 77.9999-173.9998 173.9999v237.9997h77.9999z" style="fill:#fff" inkscape:connector-curvature="0"/></g></svg></span><span class="font-weight-bold">Stroom</span>
	</a>
	<div class="td-navbar-nav-scroll ml-md-auto" id="main_navbar">
		<ul class="navbar-nav mt-2 mt-lg-0">
			
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				
				
				<a class="nav-link" href="../../../../about/about/" ><span>About</span></a>
			</li>
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				
				
				<a class="nav-link active" href="../../../../docs/" ><span class="active">Documentation</span></a>
			</li>
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				
				
				<a class="nav-link" href="../../../../community/" ><span>Community</span></a>
			</li>
			
			
			<li class="nav-item dropdown mr-4 d-none d-lg-block">
				<a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
	Stroom Version (Legacy)
</a>
<div class="dropdown-menu" aria-labelledby="navbarDropdownMenuLink">
	
	<a class="dropdown-item" href="../../../../../7.1">7.1</a>
	
	<a class="dropdown-item" href="../../../../../7.0">7.0</a>
	
	<a class="dropdown-item" href="../../../../../legacy">Legacy</a>
	
</div>

			</li>
			
			
		</ul>
	</div>
	<div class="navbar-nav d-none d-lg-block"><input
  type="search"
  class="form-control td-search-input"
  placeholder="&#xf002; Search this site…"
  aria-label="Search this site…"
  autocomplete="off"
  
  data-offline-search-index-json-src="../../../../offline-search-index.json"
  data-offline-search-base-href="../../../../"
  data-offline-search-max-results="50"
>
</div>
</nav>

    </header>
    <div class="container-fluid td-outer">
      <div class="td-main">
        <div class="row flex-xl-nowrap">
          <main class="col-12 col-md-9 col-xl-8 pl-md-5" role="main">
            




<div class="td-content">
<div class="pageinfo pageinfo-primary d-print-none">
<p>
This is the multi-page printable view of this section.
<a href="#" onclick="print();return false;">Click here to print</a>.
</p><p>
<a href="../../../../docs/install-guide/setup/">Return to the regular view of this page</a>.
</p>
</div>



<h1 class="title">Setup</h1>





    <ul>
    
  
  
  
  

  
    
    
	
<li>1: <a href="#pg-baf25f528dd0b5d043a6131fcf804e8d">Apache Forwarding</a></li>


    
  
    
    
	
<li>2: <a href="#pg-06d5f6643ea3f5b645b70260fb32e360">Java Key Store Setup</a></li>


    
  
    
    
	
<li>3: <a href="#pg-2ca84eb0d1a73aaef4a9d836a7d0b0be">MySQL Setup</a></li>


    
  
    
    
	
<li>4: <a href="#pg-83516d1c6898776469e61e1639643937">Processing Users</a></li>


    
  
    
    
	
<li>5: <a href="#pg-1423b5de8658215848877b76e270e0c7">Securing Stroom</a></li>


    
  

    </ul>


<div class="content">
      
</div>
</div>


  
  
  
  

  
  

  
    
    
	
    



<div class="td-content" style="--base-section-num: '1.'; ">
    
  <h1 id="pg-baf25f528dd0b5d043a6131fcf804e8d">1 - Apache Forwarding</h1>
    
	
<div class="pageinfo pageinfo-danger">
<h4 class="text-danger alert-heading">Warning</h4>
<p>This document refers to v4/5.</p>

</div>


<p>Stroom defaults to listening for HTTP on port 8080.
It is recommended that Apache is used to listen on the standard HTTP port 80 and forward requests on via the Apache mod_jk module and the AJP protocol (on 8009).
Apache can also perform HTTPS on port 443 and pass over requests to Tomcat using the same AJP protocol.</p>
<p>It is additionally recommended that Stroom Proxy is used to front data ingest and so Apache is configured to route traffic to http(s)://server/stroom/datafeed to Stroom Proxy and anything else to Stroom.</p>
<h2 id="prerequisites">Prerequisites</h2>
<ul>
<li>tomcat-connectors-1.2.31-src.tar.gz</li>
</ul>
<h2 id="setup-apache">Setup Apache</h2>
<ul>
<li>As root</li>
<li>Patch mod_jk</li>
</ul>
<pre><code class="language-bash">cd ~/tmp
tar -xvzf tomcat-connectors-1.2.31-src.tar.gz 
cd tomcat-connectors-1.2.31-src/native
./configure --with-apxs=/usr/sbin/apxs 
make
sudo cp apache-2.0/mod_jk.so /etc/httpd/modules/
cd
</code></pre>
<ul>
<li>Put the web server cert, private key, and CA cert into the web servers conf directory  /etc/httpd/conf.  E.g.</li>
</ul>
<pre><code class="language-bash">[user@node1 stroom-doc]$ ls -al /etc/httpd/conf
....
-rw-r--r-- 1 root root  1729 Aug 27  2013 host.crt
-rw-r--r-- 1 root root  1675 Aug 27  2013 host.key
-rw-r--r-- 1 root root  1289 Aug 27  2013 CA.crt
....
</code></pre>
<ul>
<li>Make changes to /etc/http/conf.d/ssl.conf as per below</li>
</ul>
<pre><code class="language-text">JkMount /stroom* local
JkMount /stroom/remoting/cluster* local
</code></pre>
<pre><code class="language-text">JkOptions +ForwardKeySize +ForwardURICompat +ForwardSSLCertChain -ForwardDirectories

SSLCertificateFile /etc/httpd/conf/[YOUR SERVER].crt
SSLCertificateKeyFile /etc/httpd/conf/[YOUR SERVER].key
SSLCertificateChainFile /etc/httpd/conf/[YOUR CA].crt
SSLCACertificateFile /etc/httpd/conf/[YOUR CA APPENDED LIST].crt

SSLOptions +ExportCertData
</code></pre>
<ul>
<li>Remove /etc/httpd/conf.d/nss.conf to avoid a 8443 port clash</li>
</ul>
<pre><code class="language-bash">rm /etc/httpd/conf.d/nss.conf 
</code></pre>
<ul>
<li>Create a /etc/httpd/conf.d/mod_jk.conf configuration</li>
</ul>
<pre><code class="language-text">LoadModule jk_module modules/mod_jk.so
JkWorkersFile conf/workers.properties
JkLogFile logs/mod_jk.log
JkLogLevel info
JkLogStampFormat  &quot;[%a %b %d %H:%M:%S %Y]&quot;
JkOptions +ForwardKeySize +ForwardURICompat +ForwardSSLCertChain -ForwardDirectories
JkRequestLogFormat &quot;%w %V %T&quot;
</code></pre>
<pre><code class="language-text">JkMount /stroom* local
JkMount /stroom/remoting/cluster* local
</code></pre>
<pre><code class="language-text">JkShmFile logs/jk.shm
&lt;Location /jkstatus/&gt;
    JkMount status
    Order deny,allow
    Deny from all
    Allow from 127.0.0.1
&lt;/Location&gt;
</code></pre>
<ul>
<li>Setup stroom-setup/cluster.txt, generate the workers file and copy into Apache.  (as root and replace stroomuser with your processing user)</li>
</ul>
<pre><code class="language-bash">/home/stroomuser/stroom-setup/workers.properties.sh --cluster=/home/stroomuser/cluster.txt &gt; /etc/httpd/conf/workers.properties
</code></pre>
<ul>
<li>Inspect /etc/httpd/conf/workers.properties to make sure it looks as you expect for your cluster</li>
</ul>
<pre><code class="language-text">worker.list=loadbalancer,local,status
worker.stroom_1.port=8009
worker.stroom_1.host=localhost
worker.stroom_1.type=ajp13
worker.stroom_1.lbfactor=1
worker.stroom_1.max_packet_size=65536
....
....
worker.loadbalancer.type=lb
worker.loadbalancer.balance_workers=stroom_1,stroom_2
worker.loadbalancer.sticky_session=1
worker.local.type=lb
worker.local.balance_workers=stroom_1
worker.local.sticky_session=1
worker.status.type=status
</code></pre>
<ul>
<li>Create a simple redirect page to the stroom web app for the root URL (e.g. DocumentRoot &ldquo;/var/www/html&rdquo;, index.html)</li>
</ul>
<pre><code class="language-text">&amp;lt;html&amp;gt;&amp;lt;head&amp;gt;&amp;lt;meta http-equiv=&quot;Refresh&quot; content=&quot;0; URL=stroom&quot;&amp;gt;&amp;lt;/head&amp;gt;&amp;lt;/html&amp;gt;
</code></pre>
<ul>
<li>Restart Apache and then test default http / https access.</li>
</ul>
<pre><code class="language-bash">sudo /etc/init.d/httpd restart
</code></pre>
<h2 id="advanced-forwarding">Advanced Forwarding</h2>
<p>Typically Stroom is setup so that traffic sent to /stroom* is routed to Stroom and /stroom/datafeed to Stroom Proxy.  It is possible to setup an extra 1 level of datafeed routing so that based on the URL this traffic can be routed differently.</p>
<p>For example to route traffic directly to Stroom under the URL /stroom/datafeed/direct (avoiding any aggregation) the following mod_jk setting could be used.</p>
<pre><code class="language-text">JkMount /stroom/datafeed/direct* loadbalancer
</code></pre>

</div>




    
	
  
    
    
	
    



<div class="td-content" style="--base-section-num: '2.'; page-break-before: always">
    
  <h1 id="pg-06d5f6643ea3f5b645b70260fb32e360">2 - Java Key Store Setup</h1>
    
	<p>In order that the java process communicates over https (for example Stroom Proxy forwarding onto Stroom) the JVM requires relevant keystore&rsquo;s setting up.</p>
<p>As the processing user copy the following files to a directory stroom-jks in the processing user home directory :</p>
<ul>
<li>CA.crt     - Certificate Authority</li>
<li>SERVER.crt - Server certificate with client authentication attributes</li>
<li>SERVER.key - Server private key</li>
</ul>
<p>As the processing user perform the following:</p>
<ul>
<li>First turn your keys into der format:</li>
</ul>
<pre><code class="language-bash">cd ~/stroom-jks

SERVER=&lt;SERVER crt/key PREFIX&gt;
AUTHORITY=CA

openssl x509 -in ${SERVER}.crt -inform PEM -out ${SERVER}.crt.der -outform DER
openssl pkcs8 -topk8 -nocrypt -in ${SERVER}.key -inform PEM -out ${SERVER}.key.der -outform DER
</code></pre>
<ul>
<li>Import Keys into the Key Stores:</li>
</ul>
<pre><code class="language-bash">Stroom_UTIL_JAR=`find ~/*app -name 'stroom-util*.jar' -print | head -1`

java -cp ${Stroom_UTIL_JAR} stroom.util.cert.ImportKey keystore=${SERVER}.jks keypass=${SERVER} alias=${SERVER} keyfile=${SERVER}.key.der certfile=${SERVER}.crt.der
keytool -import -noprompt -alias ${AUTHORITY} -file ${AUTHORITY}.crt -keystore ${AUTHORITY}.jks -storepass ${AUTHORITY}
</code></pre>
<ul>
<li>Update Processing User Global Java Settings:</li>
</ul>
<pre><code class="language-bash">PWD=`pwd`
echo &quot;export JAVA_OPTS=\&quot;-Djavax.net.ssl.trustStore=${PWD}/${AUTHORITY}.jks -Djavax.net.ssl.trustStorePassword=${AUTHORITY} -Djavax.net.ssl.keyStore=${PWD}/${SERVER}.jks -Djavax.net.ssl.keyStorePassword=${SERVER}\&quot;&quot; &gt;&gt; ~/env.sh  
</code></pre>
<p>Any Stroom or Stroom Proxy instance will now additionally pickup the above JAVA_OPTS settings.</p>

</div>




    
	
  
    
    
	
    



<div class="td-content" style="--base-section-num: '3.'; page-break-before: always">
    
  <h1 id="pg-2ca84eb0d1a73aaef4a9d836a7d0b0be">3 - MySQL Setup</h1>
    
	<h2 id="prerequisites">Prerequisites</h2>
<ul>
<li>MySQL 5.5.y server installed (e.g. yum install mysql-server)</li>
<li>Processing User Setup</li>
</ul>
<p>A single MySQL database is required for each Stroom instance.
You do not need to setup a MySQL instance per node in your cluster.</p>
<h2 id="check-database-installed-and-running">Check Database installed and running</h2>
<pre><code class="language-bash">[root@stroomdb ~]# /sbin/chkconfig --list mysqld
mysqld          0:off   1:off   2:on    3:on    4:on    5:on    6:off
[root@stroomdb ~]# mysql --user=root -p
Enter password:
Welcome to the MySQL monitor.  Commands end with ; or \g.
...
mysql&gt; quit      
</code></pre>
<p>The following commands can be used to auto start mysql if required:</p>
<pre><code class="language-bash">[root@stroomdb ~]# /sbin/chkconfig –level 345 mysqld on
[root@stroomdb ~]# /sbin/service httpd start
</code></pre>
<h2 id="overview">Overview</h2>
<p>MySQL configuration can be simple to complex depending on your requirements.<br>
For a very simple configuration you simply need an out-of-the-box mysql
install and create a database user account.</p>
<p>Things get more complicated when considering:</p>
<ul>
<li>Security</li>
<li>Master Slave Replication</li>
<li>Tuning memory usage</li>
<li>Running Stroom Stats in a different database to Stroom</li>
<li>Performance Monitoring</li>
</ul>
<h2 id="simple-install">Simple Install</h2>
<p>Ensure the database is running, create the database and access to it</p>
<pre><code class="language-bash">[stroomuser@host stroom-setup]$ mysql --user=root
Welcome to the MySQL monitor.  Commands end with ; or \g.
...

mysql&gt; create database stroom;
Query OK, 1 row affected (0.02 sec)

mysql&gt; grant all privileges on stroom.* to 'stroomuser'@'host' identified by 'password';
Query OK, 0 rows affected (0.00 sec)

mysql&gt; create database stroom_stats;
Query OK, 1 row affected (0.02 sec)

mysql&gt; grant all privileges on stroom_stats.* to 'stroomuser'@'host' identified by 'password';
Query OK, 0 rows affected (0.00 sec)

mysql&gt; flush privileges;
Query OK, 0 rows affected (0.00 sec)
</code></pre>
<h2 id="advanced-security">Advanced Security</h2>
<p>It is recommended to run /usr/bin/mysql_secure_installation to remove test database and accounts.</p>
<p>./stroom-setup/mysql_grant.sh is a utility script that creates accounts for you to use within a
cluster (or single node setup).  Run to see the options:</p>
<pre><code class="language-bash">[stroomuser@host stroom-setup]$ ./mysql_grant.sh
usage : --name=&lt;instance name (defaults to my for /etc/my.cnf)&gt;
        --user=&lt;the stroom user for the db&gt;
        --password=&lt;the stroom password for the db&gt;
        --cluster=&lt;the file with a line per node in the cluster&gt;
--user=&lt;db user&gt; Must be set
</code></pre>
<p>N.B. name is used when multiple mysql instances are setup (see below).</p>
<p>You need to create a file cluster.txt with a line for each member of your cluster
(or single line in the case of a one node Stroom install).
Then run the utility script to lock down the server access.</p>
<pre><code class="language-bash">[stroomuser@host ~]$ hostname &gt;&gt; cluster.txt
[stroomuser@host ~]$ ./stroom-setup/mysql_grant.sh --name=mysql56_dev --user=stroomuser --password= --cluster=cluster.txt
Enter root mysql password :
--------------
flush privileges
--------------

--------------
delete from mysql.user where user = 'stroomuser'
--------------
...
...
...
--------------
flush privileges
--------------

[stroomuser@host ~]$
</code></pre>
<h2 id="advanced-install">Advanced Install</h2>
<p>The below example uses the utility scripts to create 3 custom mysql server instances on 2 servers:</p>
<ul>
<li>server1 - master stroom,</li>
<li>server2 - slave stroom, stroom_stats</li>
</ul>
<p>As root on server1:</p>
<pre><code class="language-bash">yum install &quot;mysql56-mysql-server&quot;
</code></pre>
<p>Create the master database:</p>
<pre><code class="language-bash">[root@node1 stroomuser]# ./stroom-setup/mysqld_instance.sh --name=mysqld56_stroom --port=3106 --server=mysqld56 --os=rhel6

--master not set ... assuming master database
Wrote base files in tmp (You need to move them as root).  cp /tmp/mysqld56_stroom /etc/init.d/mysqld56_stroom; cp /tmp/mysqld56_stroom.cnf /etc/mysqld56_stroom.cnf
Run mysql client with mysql --defaults-file=/etc/mysqld56_stroom.cnf

[root@node1 stroomuser]# cp /tmp/mysqld56_stroom /etc/init.d/mysqld56_stroom; cp /tmp/mysqld56_stroom.cnf /etc/mysqld56_stroom.cnf
[root@node1 stroomuser]# /etc/init.d/mysqld56_stroom start

Initializing MySQL database:  Installing MySQL system tables...
OK
Filling help tables...
...
...
Starting mysql56-mysqld:                                   [  OK  ]
</code></pre>
<p>Check Start up Settings Correct</p>
<pre><code class="language-bash">[root@node2 stroomuser]# chkconfig mysqld off
[root@node2 stroomuser]# chkconfig mysql56-mysqld off
[root@node1 stroomuser]# chkconfig --add mysqld56_stroom
[root@node1 stroomuser]# chkconfig mysqld56_stroom on

[root@node2 stroomuser]# chkconfig --list | grep mysql
mysql56-mysqld  0:off   1:off   2:off   3:off   4:off   5:off   6:off
mysqld          0:off   1:off   2:off   3:off   4:off   5:off   6:off
mysqld56_stroom    0:off   1:off   2:on    3:on    4:on    5:on    6:off
mysqld56_stats  0:off   1:off   2:on    3:on    4:on    5:on    6:off
</code></pre>
<p>Create a text file will all members of the cluster:</p>
<pre><code class="language-bash">[root@node1 stroomuser]# vi cluster.txt

node1.my.org
node2.my.org
node3.my.org
node4.my.org 
</code></pre>
<p>Create the grants:</p>
<pre><code class="language-bash">[root@node1 stroomuser]# ./stroom-setup/mysql_grant.sh --name=mysqld56_stroom --user=stroomuser --password=password --cluster=cluster.txt
</code></pre>
<p>As root on server2:</p>
<pre><code class="language-bash">[root@node2 stroomuser]# yum install &quot;mysql56-mysql-server&quot;


[root@node2 stroomuser]# ./stroom-setup/mysqld_instance.sh --name=mysqld56_stroom --port=3106 --server=mysqld56 --os=rhel6 --master=node1.my.org --user=stroomuser --password=password

--master set ... assuming slave database
Wrote base files in tmp (You need to move them as root).  cp /tmp/mysqld56_stroom /etc/init.d/mysqld56_stroom; cp /tmp/mysqld56_stroom.cnf /etc/mysqld56_stroom.cnf
Run mysql client with mysql --defaults-file=/etc/mysqld56_stroom.cnf

[root@node2 stroomuser]# cp /tmp/mysqld56_stroom /etc/init.d/mysqld56_stroom; cp /tmp/mysqld56_stroom.cnf /etc/mysqld56_stroom.cnf
[root@node1 stroomuser]# /etc/init.d/mysqld56_stroom start

Initializing MySQL database:  Installing MySQL system tables...
OK
Filling help tables...
...
...
Starting mysql56-mysqld:                                   [  OK  ]
</code></pre>
<p>Check Start up Settings Correct</p>
<pre><code class="language-bash">[root@node2 stroomuser]# chkconfig mysqld off
[root@node2 stroomuser]# chkconfig mysql56-mysqld off
[root@node1 stroomuser]# chkconfig --add mysqld56_stroom
[root@node1 stroomuser]# chkconfig mysqld56_stroom on

[root@node2 stroomuser]# chkconfig --list | grep mysql
mysql56-mysqld  0:off   1:off   2:off   3:off   4:off   5:off   6:off
mysqld          0:off   1:off   2:off   3:off   4:off   5:off   6:off
mysqld56_stroom    0:off   1:off   2:on    3:on    4:on    5:on    6:off
</code></pre>
<p>Create the grants:</p>
<pre><code class="language-bash">[root@node1 stroomuser]# ./stroom-setup/mysql_grant.sh --name=mysqld56_stroom --user=stroomuser --password=password --cluster=cluster.txt
</code></pre>
<p>Make the slave database start to follow:</p>
<pre><code class="language-bash">[root@node2 stroomuser]# cat /etc/mysqld56_stroom.cnf | grep &quot;change master&quot;
# change master to MASTER_HOST='node1.my.org', MASTER_PORT=3106, MASTER_USER='stroomuser', MASTER_PASSWORD='password';

[root@node2 stroomuser]# mysql --defaults-file=/etc/mysqld56_stroom.cnf

mysql&gt; change master to MASTER_HOST='node1.my.org', MASTER_PORT=3106, MASTER_USER='stroomuser', MASTER_PASSWORD='password';
mysql&gt; start slave; 
</code></pre>
<p>As processing user on server1:</p>
<pre><code class="language-bash">[stroomuser@node1 ~]$ mysql --defaults-file=/etc/mysqld56_stroom.cnf --user=stroomuser --password=password

mysql&gt; create database stroom;
Query OK, 1 row affected (0.00 sec)

mysql&gt; use stroom;
Database changed

mysql&gt; create table test (a int);
Query OK, 0 rows affected (0.05 sec)
</code></pre>
<p>As processing user on server2 check server replicating OK:</p>
<pre><code class="language-bash">[stroomuser@node2 ~]$ mysql --defaults-file=/etc/mysqld56_stroom.cnf --user=stroomuser --password=password

mysql&gt; show create table test;
+-------+----------------------------------------------------------------------------------------+
| Table | Create Table                                                                           |
+-------+----------------------------------------------------------------------------------------+
| test  | CREATE TABLE `test` (`a` int(11) DEFAULT NULL  ) ENGINE=InnoDB DEFAULT CHARSET=latin1  |
+-------+----------------------------------------------------------------------------------------+
1 row in set (0.00 sec)
</code></pre>
<p>As root on server2:</p>
<pre><code class="language-bash">[root@node2 stroomuser]# /home/stroomuser/stroom-setup/mysqld_instance.sh --name=mysqld56_stats --port=3206 --server=mysqld56 --os=rhel6 --user=statsuser --password=password
[root@node2 stroomuser]# cp /tmp/mysqld56_stats /etc/init.d/mysqld56_stats; cp /tmp/mysqld56_stats.cnf /etc/mysqld56_stats.cnf
[root@node2 stroomuser]# /etc/init.d/mysqld56_stats start
[root@node2 stroomuser]# chkconfig mysqld56_stats on
</code></pre>
<p>Create the grants:</p>
<pre><code class="language-bash">[root@node2 stroomuser]# ./stroom-setup/mysql_grant.sh --name=mysqld56_stats --database=stats  --user=stroomstats --password=password --cluster=cluster.txt
</code></pre>
<p>As processing user create the database:</p>
<pre><code class="language-bash">[stroomuser@node2 ~]$ mysql --defaults-file=/etc/mysqld56_stats.cnf --user=stroomstats --password=password
Welcome to the MySQL monitor.  Commands end with ; or \g.
....
mysql&gt; create database stats;
Query OK, 1 row affected (0.00 sec)
</code></pre>

</div>




    
	
  
    
    
	
    



<div class="td-content" style="--base-section-num: '4.'; page-break-before: always">
    
  <h1 id="pg-83516d1c6898776469e61e1639643937">4 - Processing Users</h1>
    
	<h2 id="processing-user-setup">Processing User Setup</h2>
<p>Stroom / Stroom Proxy should be run under a processing user (we assume stroomuser below).</p>
<ul>
<li>Setup this user</li>
</ul>
<pre><code class="language-bash">/usr/sbin/adduser --system stroomuser
</code></pre>
<ul>
<li>
<p>You may want to allow normal accounts to sudo to this account for maintenance (visudo)</p>
</li>
<li>
<p>Create a service script to start/stop on server startup (as root).</p>
</li>
</ul>
<pre><code class="language-bash">vi /etc/init.d/stroomuser

#!/bin/bash
#
# stroomuser       This shell script takes care of starting and stopping
#               the stroomuser subsystem (tomcat6, etc)
#
# chkconfig: - 86 14
# description: stroomuser is the stroomuser sub system

Stroom_USER=stroomuser

case $1 in
start)
/bin/su ${Stroom_USER} /home/${Stroom_USER}/stroom-deploy/start.sh
;;
stop)
/bin/su ${Stroom_USER} /home/${Stroom_USER}/stroom-deploy/stop.sh
;;
restart)
/bin/su ${Stroom_USER} /home/${Stroom_USER}/stroom-deploy/stop.sh
/bin/su ${Stroom_USER} /home/${Stroom_USER}/stroom-deploy/start.sh
;;
esac
exit 0
</code></pre>
<ul>
<li>Initialise Script</li>
</ul>
<pre><code class="language-bash">/bin/chmod +x /etc/init.d/stroomuser
/sbin/chkconfig --level 345 stroomuser on
</code></pre>
<h2 id="install-java-8">Install Java 8</h2>
<pre><code class="language-bash">yum install java-1.8.0-openjdk.x86_64
yum install java-1.8.0-openjdk-devel.x86_64
</code></pre>
<h2 id="setup-deployment-scripts">Setup Deployment Scripts</h2>
<ul>
<li>As the processing user unpack the stroom-deploy-X-Y-Z-bin.zip generic deployment
scripts in the processing users home directory.</li>
</ul>
<pre><code class="language-bash">unzip stroom-deploy-5.0.beta1-bin.zip
</code></pre>
<ul>
<li>Setup env.sh to include JAVA_HOME to point to the installed directory of the JDK
(this will be platform specific).  vi ~/env.sh</li>
</ul>
<pre><code class="language-bash"># User specific aliases and functions
export JAVA_HOME=/usr/lib/jvm/java-1.8.0
export PATH=${JAVA_HOME}/bin:${PATH}
</code></pre>
<ul>
<li>Setup users profile to include the same.  vi ~/.bashrc</li>
</ul>
<pre><code class="language-bash"># User specific aliases and functions
. ~/env.sh
</code></pre>
<ul>
<li>Check that java is installed OK</li>
</ul>
<pre><code class="language-bash">[stroomuser@node1 ~]$ . .bashrc
[stroomuser@node1 ~]$ which java
/usr/lib/jvm/java-1.8.0/bin/java

[stroomuser@node1 ~]$ which javac
/usr/lib/jvm/java-1.8.0/bin/javac

[stroomuser@node1 ~]$ java -version
openjdk version &quot;1.8.0_65&quot;
OpenJDK Runtime Environment (build 1.8.0_65-b17)
OpenJDK 64-Bit Server VM (build 25.65-b01, mixed mode)
</code></pre>
<ul>
<li>Setup auto deployment crontab script as below (crontab -e)</li>
</ul>
<pre><code class="language-bash">[stroomuser@node1 ~]$ crontab -l
# Deploy Script
0,5,10,15,20,25,30,35,40,45,50,55 * * * * /home/stroomuser/stroom-deploy/deploy.sh &gt;&gt; /home/stroomuser/stroom-deploy.log
59 0 * * * rm -f /home/stroomuser/stroom-deploy.log
# Clean system
0 0 * * * /home/stroomuser/stroom-deploy/clean.sh &gt; /dev/null
</code></pre>

</div>




    
	
  
    
    
	
    



<div class="td-content" style="--base-section-num: '5.'; page-break-before: always">
    
  <h1 id="pg-1423b5de8658215848877b76e270e0c7">5 - Securing Stroom</h1>
    
	<blockquote>
<p><em>NOTE</em> This document was written for stroom v4/5. Some parts may not be applicable for v6+.</p>
</blockquote>
<h2 id="firewall">Firewall</h2>
<p>The following firewall configuration is recommended:</p>
<ul>
<li>Outside cluster drop all access except ports HTTP 80, HTTPS 443, and any other system ports your require SSH, etc</li>
<li>Within cluster allow all access</li>
</ul>
<p>This will enable nodes within the cluster to communicate on:</p>
<ul>
<li>Native tomcat HTTP 8080, 9080</li>
<li>Tomcat AJP 8009, 9009</li>
<li>MySQL 3006</li>
</ul>
<h2 id="mysql">MySQL</h2>
<ul>
<li>It is recommended that you run mysql_secure_installation to set a root password and remove test database:</li>
</ul>
<pre><code class="language-bash">mysql_secure_installation (provide a root password)
- Set root password? [Y/n] Y
- Remove anonymous users? [Y/n] Y 
- Disallow root login remotely? [Y/n] Y
- Remove test database and access to it? [Y/n] Y
- Reload privilege tables now? [Y/n] Y
</code></pre>
<ul>
<li>stroom-setup includes a version of this script designed to be run on instances create using mysqld_instance.sh
(i.e. non standard or multiple instances of mysql)</li>
</ul>
<pre><code class="language-bash">[stroomuser@stroom_1 stroom-setup]$ ./mysql_secure_installation.sh --name=mysqld_ref1m
</code></pre>

</div>




    
	
  



          </main>
        </div>
      </div>
      
<footer class="bg-dark py-5 row d-print-none">
  <div class="container-fluid mx-sm-5">
    <div class="row">
      <div class="col-6 col-sm-4 text-xs-center order-sm-2">
        
        
        
      </div>
      <div class="col-6 col-sm-4 text-right text-xs-center order-sm-3">
        
        
        
<ul class="list-inline mb-0">
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="GitHub" aria-label="GitHub">
    <a class="text-white" target="_blank" rel="noopener" href="https://github.com/gchq/stroom" aria-label="GitHub">
      <i class="fab fa-github"></i>
    </a>
  </li>
  
</ul>

        
        
      </div>
      <div class="col-12 col-sm-4 text-center py-2 order-sm-2">
        <small class="text-white">&copy; 2022 Crown Copyright All Rights Reserved</small>
        
	
      </div>
    </div>
  </div>
</footer>


    </div>
    

<script src='../../../../js/popper.min.js'></script>
<script src='../../../../js/bootstrap.min.js'></script>






<script src='../../../../js/tabpane-persist.js'></script>



















<script src="../../../../js/main.js"></script>



<script src='../../../../js/prism.js'></script>



  </body>
</html>
